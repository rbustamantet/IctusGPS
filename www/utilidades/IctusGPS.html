<!DOCTYPE html>
<html lang="es">
  <head>

    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1,
      viewport-fit=cover">
    <link rel="manifest" href="../site.webmanifest">
    <link rel="icon" type="image/png" sizes="192x192"
      href="../iconos/ictusgps.png">
    <link rel="apple-touch-icon" sizes="180x180"
      href="../iconos/ictusgps.png">
    <link rel="shortcut icon" href="../iconos/ictusgps.png">
    <meta name="theme-color" content="#0f3d83">
    <title>Ictus GPS</title>
    <style>
/* =========================================================
   VARIABLES GLOBALES
========================================================= */
:root{
  --bg:#f8fafc; 
  --ink:#0e1a33;

  --azul:#0f3d83;
  --azul-institucional:#0f3d83;

  --accent-dark:#0f3d83;
  --accent-light:#2563eb;

  --border:#e5e9f2;
  --muted:#64748b;

  --ok:#166534;
  --ok-bg:#e9fce7;
  --ok-ring:#bbf7d0;

  --mid:#92400e;
  --mid-bg:#fff7ed;
  --mid-ring:#fed7aa;

  --bad:#991b1b;
  --bad-bg:#fef2f2;
  --bad-ring:#fecaca;

  --gris:#6b7280;
  --borde:#e5e7eb;
  --error:#b91c1c;
  --base-scale:0.60;
}

/* =========================================================
   BASE
========================================================= */
html,
body{
  margin:0;
  padding:0;
  background:var(--bg);
  color:var(--ink);
  font-family:Verdana, Geneva, Tahoma, sans-serif;
}

*{box-sizing:border-box;}

.wrap{
  max-width:1100px;
  margin:0 auto;
  padding:.2rem;
}

/* Empuja el contenido real por debajo de la barra superior fija */
body{
  padding-top:calc(env(safe-area-inset-top, 0px) + 60px); /* altura de .safe-top */
}

/* =========================================================
   SAFE-TOP (FIJO 60 px + notch)
========================================================= */
.safe-top{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:calc(env(safe-area-inset-top) + 60px);
  background:var(--azul-institucional);
  z-index:1001;
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding-top:env(safe-area-inset-top);
}

.safe-content{
  width:100%;
  max-width:1080px;
  padding:6px 16px 8px;
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
}

.safe-left{
  display:flex;
  align-items:center;
  gap:10px;
}

.safe-mini{
  width:44px;
  height:44px;
  object-fit:contain;
  padding:4px;
  box-shadow:0 0 4px rgba(0,0,0,0.1);
}

.safe-logo{
  height:44px;
  width:auto;
}

.safe-actions{
  display:flex;
  gap:10px;
}

.safe-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:40px;
  height:40px;
  background:rgba(255,255,255,0.15);
  border:1px solid #ffffff;
  border-radius:50%;
  transition:background .25s, border-color .25s, transform .1s;
}

.safe-btn:hover{
  background:#01c5fe;
}

.safe-btn:active{
  transform:scale(0.95);
}

.safe-icon{
  width:32px;
  height:32px;
  object-fit:contain;
}

/* =========================================================
   CABECERA STICKY
========================================================= */
header{
  position:sticky;
  top:calc(env(safe-area-inset-top) + 52px);
  z-index:1002;
  backdrop-filter:blur(6px);
  background:var(--azul-institucional);
  border-bottom:1px solid rgba(255,255,255,.08);
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
  color:#fff;
}

.bar{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  height:52px;
  padding:0 16px;
}

.title{
  display:flex;
  align-items:center;
  font-size:1.4rem;
  font-weight:700;
  color:#fff;
}

.title img{
  width:32px;
  height:32px;
  margin-right:8px;
}

/* =========================================================
   CUERPO PRINCIPAL
========================================================= */
main{
  max-width:1080px;
  margin:0 auto;
  padding:2rem 1.5rem 1.5rem;
  box-sizing:border-box;
}

.howto{
  background:#fff;
  border:1px solid var(--border);
  border-radius:14px;
  box-shadow:0 2px 2px rgba(148,163,184,0.35);
  padding:1rem;
  margin:.3rem 0 1rem;
  font-size:14px;
}

.content{
  display:flex;
  gap:20px;
  align-items:flex-start;
  justify-content:space-between;
}

.panel{
  width:48%;
  text-align:left;
}

h2{
  margin:.3rem 0 1rem 0;
  font-size:1.5rem;
  color:var(--accent-dark);
}

.toolbar{
  display:flex;
  gap:.5rem;
  flex-wrap:wrap;
  align-items:center;
  margin-bottom:.75rem;
}

.toolbar button{
  border:1px solid var(--borde);
  background:#f8fafc;
  padding:.45rem .7rem;
  border-radius:.5rem;
  cursor:pointer;
}

.toolbar button:hover{
  background:#eef2ff;
  border-color:#c7d2fe;
}

/* Panel superior limitado en ancho ya se controla con main */
.panel{
  width:100%;
}

/* =========================================================
   CONTENEDOR OVERLAY
========================================================= */
.overlay-container{
  position:relative;
  display:block;
  overflow:hidden;
  width:100%;
  min-height:260px;
  border:1px dashed var(--borde);
  border-radius:.5rem;
  background:#fff;
  touch-action:none;
}

@media (min-width:1080px){
  .overlay-container{
    width:calc(100% * var(--base-scale));
  }
}

#imagenCargada{
  position:relative;
  z-index:0;
  display:block;
  width:100%;
  height:auto;
  user-select:none;
  -webkit-user-drag:none;
}

#mapaReferencia{
  position:absolute;
  top:0;
  left:0;
  opacity:.5;
  cursor:grab;
  user-select:none;
  -webkit-user-drag:none;
  transform-origin:0 0;
  z-index:1;
  width:auto;
  height:auto;
  max-width:none;
  max-height:none;

  /* Mejora de rendimiento en m√≥vil/WebView */
  will-change:transform;
  transform:translate3d(0,0,0);
}

#mapaReferencia.grabbing{
  cursor:grabbing;
}

.scale-badge{
  position:absolute;
  top:6px;
  left:6px;
  padding:.15rem .4rem;
  font-size:.8rem;
  background:#ffffffcc;
  border:1px solid var(--borde);
  border-radius:.35rem;
  color:#111;
  pointer-events:none;
  z-index:3;
  display:none;
}

/* Dropzone */
.dropzone{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:.4rem;
  text-align:center;
  padding:1rem;
  color:var(--muted);
  background:repeating-linear-gradient(
    45deg,
    #fafafa,
    #fafafa 10px,
    #ffffff 10px,
    #ffffff 20px
  );
  border-radius:.5rem;
  cursor:pointer;
  z-index:4;
}

.dropzone strong{
  color:var(--ink);
}

.dropzone .hint{
  font-size:.9rem;
}

.dropzone.dragover{
  outline:2px dashed var(--accent-light);
  outline-offset:-6px;
  background:#f8fbff;
}

/* Campos y textos de apoyo */
.field{margin:.6rem 0;}
label{
  font-size:.9rem;
  color:var(--muted);
  margin-right:.5rem;
}
input[type="range"]{vertical-align:middle;}
.hint{
  color:var(--muted);
  font-size:.92rem;
}
.hint.small{font-size:.88rem;}

/* =========================================================
   PANEL DE AYUDA COLAPSABLE
========================================================= */
details.help{
  margin-top:.6rem;
  max-width:calc(100% * var(--base-scale));
  border:1px solid var(--borde);
  border-radius:.5rem;
  background:#fafafa;
}

details.help > summary{
  list-style:none;
  cursor:pointer;
  user-select:none;
  padding:.6rem .8rem;
  font-weight:600;
  color:#0f172a;
  display:flex;
  align-items:center;
  gap:.5rem;
}

details.help > summary::-webkit-details-marker{
  display:none;
}

details.help > summary::before{
  content:"‚ñ∏";
  display:inline-block;
  transform:rotate(0deg);
  transition:transform .2s ease;
  color:var(--accent-dark);
}

details.help[open] > summary::before{
  transform:rotate(90deg);
}

details.help .help-body{
  padding:.6rem .9rem .85rem .9rem;
  border-top:1px solid var(--borde);
  color:#111;
  font-size:.92rem;
  line-height:1.3;
  display:block;
}

.help h3{
  margin:.2rem 0 .4rem 0;
  font-size:1rem;
}

.help ul{
  margin:.25rem 0 .5rem 1.1rem;
  padding:0;
}

.help li{
  margin:.2rem 0;
}

.kbd{
  display:inline-block;
  padding:.05rem .35rem;
  border:1px solid #cbd5e1;
  border-bottom-width:2px;
  border-radius:.35rem;
  font-family:ui-monospace,SFMono-Regular,Menlo,monospace;
  font-size:.88em;
  background:#fff;
}

/* Leyenda */
#leyenda{margin-top:20px;}
#leyenda h3{margin:.2rem 0 .4rem 0;}
#leyenda ul{
  list-style:none;
  padding:0;
  margin:.25rem 0;
}
#leyenda li{margin:.15rem 0;}

/* Layout responsive */
@media (max-width:1080px){
  .content{
    flex-direction:column;
    align-items:stretch;
  }
  .panel{width:100%;}
  .overlay-container{width:100%;}
  details.help{max-width:100%;}
}

/* Mejora m√≥vil general */
@media (max-width:600px){
  html{font-size:17px;}
  h2{font-size:1.2rem;}
  .toolbar{gap:.6rem;}
  .toolbar button{
    padding:.65rem 1rem;
    font-size:1rem;
    min-height:44px;
    border-radius:.6rem;
  }
  #fileInput{font-size:1rem;}
  label{font-size:1rem;}
  #opacidadBlock{
    display:flex;
    align-items:center;
    gap:.6rem;
  }
  input[type="range"]{height:34px;}
  input[type="range"]::-webkit-slider-runnable-track{
    height:12px;
    border-radius:999px;
  }
  input[type="range"]::-webkit-slider-thumb{
    width:30px;
    height:30px;
    margin-top:-9px;
    border-radius:50%;
  }
  input[type="range"]::-moz-range-track{
    height:12px;
    border-radius:999px;
  }
  input[type="range"]::-moz-range-thumb{
    width:30px;
    height:30px;
    border-radius:50%;
  }
  select,
  button,
  input[type=file]{font-size:1rem;}
  #opacidadVal{font-size:1.1rem;}
}

/* =========================================================
   SWATCHES LEYENDA
========================================================= */
.swatch{
  display:inline-block;
  width:0.95em;
  height:0.95em;
  border:1px solid #cbd5e1;
  border-radius:3px;
  margin-right:.35rem;
  vertical-align:-0.12em;
}

/* Colores lisos */
.sw-blue{background:#1d4ed8;}
.sw-lightblue{background:#60a5fa;}
.sw-green{background:#2e7d32;}
.sw-salmon{background:#f97373;}
.sw-red{background:#ef4444;}

/* Azul ‚Äútramado‚Äù */
.sw-blue-hatch{
  background:
    repeating-linear-gradient(
      45deg,
      rgba(29,78,216,.0) 0 2px,
      rgba(29,78,216,.18) 2px 3px
    ),
    #93c5fd;
}

/* =========================================================
   GALER√çA DE MAPAS (MINIATURAS)
========================================================= */
.map-gallery{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap:12px;
  margin-top:.5rem;
}

.map-thumb{
  border:1px solid var(--borde);
  border-radius:8px;
  background:#fff;
  padding:6px;
  cursor:pointer;
  text-align:center;
  box-shadow:0 1px 2px rgba(0,0,0,0.1);
  transition:transform .15s, box-shadow .15s, border-color .15s;
}

.map-thumb:hover{
  transform:scale(1.03);
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
  border-color:var(--accent-light);
}

.map-thumb.selected{
  border:2px solid var(--accent-light);
  box-shadow:0 0 0 3px rgba(37,99,235,0.25);
}

.map-thumb img{
  width:100%;
  height:auto;
  border-radius:6px;
  object-fit:cover;
}

.map-thumb-name{
  font-size:.85rem;
  margin-top:4px;
  color:var(--ink);
}

/* =========================================================
   PIE
========================================================= */
footer{
  width:100%;
  margin:2rem 0 0;
  padding:1.5rem 0;
  border-top:1px solid #e5e7eb;
  background:#ffffff;
  text-align:center;
  box-shadow:0 -2px 6px rgba(0,0,0,0.04);
}
footer img{
  max-width:320px;
  height:auto;
  opacity:.95;
}

/* =========================================================
   MEDIA QUERIES GENERALES
========================================================= */
@media(max-width:768px){
  header{font-size:1.05rem;}
  main{padding:0.9rem 1rem;}
  body{font-size:0.96rem;}
}
  </style>
  </head>
  <body>
    <!-- SAFE-TOP -->
    <div class="safe-top">
      <div class="safe-content">
        <div class="safe-left"> <img src="../iconos/utilidadesico.png"
            class="safe-mini" alt=""> <img src="../img/topbar.png"
            class="safe-logo" alt="Ictus GPS"> </div>
        <div class="safe-actions"> <a href="javascript:history.back()"
            class="safe-btn" aria-label="Volver"> <img
              src="../iconos/atrastransparente.png" class="safe-icon"
              alt=""> </a> <a href="../index.html" class="safe-btn"
            aria-label="Inicio"> <img
              src="../iconos/hometransparente.png" class="safe-icon"
              alt=""> </a> </div>
      </div>
    </div>
    <!-- CABECERA -->
    <header>
      <div class="bar">
        <div class="title"> <img src="../iconos/ictusgpsico.png" alt="">
          Ictus GPS </div>
      </div>
    </header>
    <!-- CONTENIDO PRINCIPAL -->
    <main>
      <div class="howto" align="justify"> Carga una imagen de TC o RM y
        ajusta sobre ella el mapa arterial seleccionado. Puedes mover,
        ampliar, voltear y modificar la opacidad para facilitar la
        correlaci√≥n anat√≥mica. La herramienta permite comparar cortes
        axiales con mapas predefinidos para identificar territorios
        vasculares. </div>
      <div class="content">
        <!-- PANEL IZQUIERDO -->
        <div class="panel">
          <h2>üñ•Ô∏è Imagen m√©dica (TC/RM)</h2>
          <div class="toolbar"> <input accept="image/*" id="fileInput"
              style="max-width:220px" type="file"> <button
              type="button" id="btnFlip">Voltear horizontal</button> <button
              type="button" id="btnReset">Reiniciar</button> </div>
          <div class="overlay-container" id="contenedor">
            <div id="dropzone" class="dropzone" title="Haz clic para
              elegir archivo"> <strong>Arrastra aqu√≠ una imagen</strong>
              <div class="hint">o haz clic para seleccionar</div>
              <div class="hint">tambi√©n puedes <strong>pegar</strong>
                (Ctrl/Cmd+V)</div>
            </div>
            <div id="scaleBadge" class="scale-badge">100%</div>
            <img id="imagenCargada" alt="" aria-hidden="true"> <img
              id="mapaReferencia" src="" alt="Mapa superpuesto"
              hidden=""> </div>
          <!-- Opacidad bajo la imagen -->
          <div class="field" id="opacidadBlock"> <label for="opacidad">Opacidad
              del mapa:</label> <input id="opacidad" min="0" max="1"
              step="0.01" value="0.5" type="range"> <span
              id="opacidadVal" aria-live="polite"
              style="color:#475569;margin-left:.35rem;">50%</span> </div>
          <!-- AYUDA: desplegable -->
          <details class="help" id="helpPanel">
            <summary>Ayuda y atajos</summary>
            <div class="help-body" aria-live="polite">
              <h3>Uso r√°pido</h3>
              <ul>
                <li><strong>Cargar imagen:</strong> clic en el panel,
                  arrastrar y soltar o <span class="kbd">Ctrl</span>/<span
                    class="kbd">‚åò</span>+<span class="kbd">V</span>.</li>
                <li><strong>Arrastrar:</strong> clic/tocar y arrastra
                  sobre el mapa.</li>
                <li><strong>Zoom:</strong> rueda (PC) o pellizco (m√≥vil)
                  centrado en el puntero.</li>
                <li><strong>Reajustar:</strong> bot√≥n ‚ÄúReiniciar‚Äù o
                  tecla <span class="kbd">R</span>/<span class="kbd">0</span>.</li>
              </ul>
              <h3>Atajos de teclado</h3>
              <ul>
                <li><span class="kbd">‚Üê</span> <span class="kbd">‚Üí</span>
                  <span class="kbd">‚Üë</span> <span class="kbd">‚Üì</span>&nbsp;
                  mover el mapa.</li>
                <li><span class="kbd">+</span>/<span class="kbd">=</span>
                  y <span class="kbd">-</span>&nbsp; zoom in/out.</li>
                <li><span class="kbd">R</span> / <span class="kbd">0</span>&nbsp;
                  ajustar al corte base.</li>
                <li><span class="kbd">F</span>&nbsp; voltear imagen
                  m√©dica.</li>
              </ul>
            </div>
          </details>
        </div>
        <!-- PANEL DERECHO -->
        <div class="panel">
          <h2>üó∫Ô∏è Mapa de referencia</h2>
          <!-- Selector de juego de mapas -->
          <div class="field"> <label for="selectorSet">Juego de mapas:</label>
            <select id="selectorSet">
            </select>
          </div>
          <!-- Galer√≠a de mapas -->
          <div class="field"> <label>Selecciona mapa:</label>
            <div id="mapGallery" class="map-gallery"></div>
          </div>
          <div class="hint small" id="mapHint"></div>
          <div id="leyenda"></div>
        </div>
      </div>
    </main>
    <footer> <img src="../img/uibanner.png" alt="Ictus GPS">
    </footer>
    <script>
/* =========================================================
   UTILIDADES B√ÅSICAS
========================================================= */
const clamp = (v,a,b)=> Math.max(a, Math.min(b, v));
const IS_TOUCH = ('ontouchstart' in window) || (navigator.maxTouchPoints && navigator.maxTouchPoints > 0);

/* Referencias DOM */
const contenedor   = document.getElementById('contenedor');
const dropzone     = document.getElementById('dropzone');
const imagenMedica = document.getElementById('imagenCargada');
const mapaImg      = document.getElementById('mapaReferencia');
const scaleBadge   = document.getElementById('scaleBadge');
const fileInput    = document.getElementById('fileInput');

const selectorSet  = document.getElementById('selectorSet');
const mapHint      = document.getElementById('mapHint');

const opacidad     = document.getElementById('opacidad');
const opacidadVal  = document.getElementById('opacidadVal');
const btnFlip      = document.getElementById('btnFlip');
const btnReset     = document.getElementById('btnReset');
const leyendaBox   = document.getElementById('leyenda');

/* Estado de interacci√≥n */
let escala = 1, mapaX = 0, mapaY = 0;
let arrastrando = false, inicioX = 0, inicioY = 0;
let pinchActiva = false, pinchDist0 = 0, escala0 = 1;
let centroPinch = {x:0, y:0};
const SCALE_MIN = 0.1, SCALE_MAX = 12;
let mapNatW = 0, mapNatH = 0;

/* =========================================================
   DEFINICI√ìN DE CONJUNTOS DE MAPAS
========================================================= */
const mapSets = {
  infra_supra: {
    label: 'Territorios infra y supratentoriales',
    maps: [
      {id:'is1',  name:'Agujero magno',             src:'img/r01.png'},
      {id:'is2',  name:'Bulbo',                     src:'img/r02.png'},
      {id:'is3',  name:'√Ångulo pontocerebeloso',    src:'img/r03.png'},
      {id:'is4',  name:'Protuberancia alta',        src:'img/r04.png'},
      {id:'is5',  name:'Mesenc√©falo',               src:'img/r05.png'},
      {id:'is6',  name:'III ventr√≠culo y t√°lamo',   src:'img/r06.png'},
      {id:'is7',  name:'Ganglios de la base',       src:'img/r07.png'},
      {id:'is8',  name:'Cuerpos ventriculares',     src:'img/r08.png'},
      {id:'is9',  name:'Centros semiovales',        src:'img/r09.png'},
      {id:'is10', name:'V√©rtex',                    src:'img/r10.png'}
    ],
    legendHTML: `
      <h3>Territorios infra y supratentoriales</h3>
      <ul>
        <li><span class="swatch" style="background:#7e22ce;"></span><strong style="color:#7e22ce;">PICA</strong> ‚Äì Arteria cerebelosa posteroinferior.</li>
        <li><span class="swatch" style="background:#0284c7;"></span><strong style="color:#0284c7;">AICA</strong> ‚Äì Arteria cerebelosa anteroinferior.</li>
        <li><span class="swatch" style="background:#06b6d4;"></span><strong style="color:#06b6d4;">SCA</strong> ‚Äì Arteria cerebelosa superior.</li>
        <li><span class="swatch" style="background:#16a34a;"></span><strong style="color:#16a34a;">BA</strong> ‚Äì Arteria basilar y sus ramas perforantes.</li>
        <li><span class="swatch" style="background:#1e40af;"></span><strong style="color:#1e40af;">PCA</strong> ‚Äì Arteria cerebral posterior.</li>
        <li><span class="swatch" style="background:#7c3aed;"></span><strong style="color:#7c3aed;">Lenticuloestriadas</strong> ‚Äì Ramas perforantes.</li>
        <li><span class="swatch" style="background:#ec4899;"></span><strong style="color:#ec4899;">A. coroidea anterior</strong> ‚Äì Origen en car√≥tida intracraneal.</li>
        <li><span class="swatch" style="background:#dc2626;"></span><strong style="color:#dc2626;">MCA</strong> ‚Äì Arteria cerebral media.</li>
        <li><span class="swatch" style="background:#ca8a04;"></span><strong style="color:#ca8a04;">ACA</strong> ‚Äì Arteria cerebral anterior.</li>
        <li><span class="swatch" style="background:#78350f;"></span><strong style="color:#78350f;">Espinales</strong> ‚Äì Ramas espinales anterior y posterior.</li>
      </ul>
    `
  },
  corticales: {
    label: 'Arterias y ramas corticales',
    maps: [
      {id:'mapa1', name:'Protuberancia',         src:'img/a01.png'},
      {id:'mapa2', name:'Mesenc√©falo',          src:'img/a02.png'},
      {id:'mapa3', name:'III ventr√≠culo',       src:'img/a03.png'},
      {id:'mapa4', name:'Cuerpos ventriculares',src:'img/a04.png'},
      {id:'mapa5', name:'Frontoparietal',       src:'img/a05.png'}
    ],
    legendHTML: `
      <h3>Arterias y ramas corticales</h3>
      <p style="color: blue;"><strong>Arteria cerebral anterior</strong></p>
      <ul>
        <li>1. A. frontal interna anterior</li>
        <li>2. A. recurrente de Heubner</li>
        <li>3. A. frontal interna posterior</li>
        <li>4. A. parietales internas superior e inferior</li>
        <li>5. A. frontal interna media</li>
        <li>6. A. paracentrales</li>
        <li>21a. A. del cuerpo calloso</li>
      </ul>
      <p style="color: red;"><strong>Arteria cerebral media</strong></p>
      <ul>
        <li>7. A. prefrontal</li>
        <li>8. A. parietales anteriores y posteriores</li>
        <li>9. A. de la circunvoluci√≥n angular</li>
        <li>10. A. temporal anterior</li>
        <li>11. A. temporal media</li>
        <li>12. A. temporal posterior</li>
        <li>13. A. temporooccipital</li>
        <li>14. A. rol√°ndica</li>
        <li>15. A. prerol√°ndica</li>
        <li>16. A. insular</li>
        <li>17. A. lenticuloestriadas</li>
      </ul>
      <p style="color: green;"><strong>Arteria cerebral posterior</strong></p>
      <ul>
        <li>18. A. occipitotemporal</li>
        <li>19. A. parietooccipital y calc√°rea</li>
        <li>20. A. t√°lamo perforantes y coroidea posterior</li>
        <li>21b. A. del cuerpo calloso</li>
      </ul>
      <p style="color: purple;"><strong>Arteria coroidea anterior</strong></p>
      <ul>
        <li>22. A. coroidea anterior</li>
      </ul>
    `
  },
  grandes: {
    label: 'Grandes vasos intracraneales',
    maps: [
      {id:'gv1',  name:'Protuberancia media',          src:'img/t01.png'},
      {id:'gv2',  name:'Protuberancia alta',           src:'img/t02.png'},
      {id:'gv3',  name:'Mesenc√©falo bajo',             src:'img/t03.png'},
      {id:'gv4',  name:'Nivel tal√°mico posterior',     src:'img/t04.png'},
      {id:'gv5',  name:'T√°lamo y N√∫cleos basales',     src:'img/t05.png'},
      {id:'gv6',  name:'N√∫cleos basales',              src:'img/t06.png'},
      {id:'gv7',  name:'Cuerpos ventriculares',        src:'img/t07.png'},
      {id:'gv8',  name:'Corona radiada inferior',      src:'img/t08.png'},
      {id:'gv9',  name:'Corona radiada media',         src:'img/t09.png'},
      {id:'gv10', name:'Corona radiata superior',      src:'img/t10.png'},
      {id:'gv11', name:'Convexidad fronto-parietal',   src:'img/t11.png'},
      {id:'gv12', name:'Convexidad alta',              src:'img/t12.png'}
    ],
    legendHTML: `
      <h3>Grandes vasos intracraneales</h3>
      <ul>
        <li><span class="swatch sw-blue"></span><strong style="color:#1d4ed8">Azul:</strong> Arteria cerebral media, tronco superior.</li>
        <li><span class="swatch sw-lightblue"></span><strong style="color:#60a5fa">Celeste:</strong> Arteria cerebral media, tronco inferior.</li>
        <li><span class="swatch sw-blue-hatch"></span><strong style="color:#487485">Azul (tramado):</strong> Arterias lenticuloestriadas.</li>
        <li><span class="swatch sw-green"></span><strong style="color:#2e7d32">Verde:</strong> Arteria cerebral posterior.</li>
        <li><span class="swatch sw-salmon"></span><strong style="color:#f97373">Salm√≥n:</strong> Arteria cerebral anterior.</li>
        <li><span class="swatch sw-red"></span><strong style="color:#ef4444">Rojo:</strong> Arteria coroidea anterior.</li>
      </ul>
    `
  }
};

/* =========================================================
   SELECT JUEGO DE MAPAS
========================================================= */
function populateSetSelect(){
  selectorSet.innerHTML = '';
  for (const key of Object.keys(mapSets)){
    const opt = document.createElement('option');
    opt.value = key;
    opt.textContent = mapSets[key].label;
    selectorSet.appendChild(opt);
  }
}

/* =========================================================
   GALER√çA DE MINIATURAS
========================================================= */
function populateMapGallery(setKey){
  const gallery = document.getElementById("mapGallery");
  gallery.innerHTML = "";

  const set = mapSets[setKey];

  set.maps.forEach((m)=>{
    const div = document.createElement("div");
    div.className = "map-thumb";
    div.dataset.mapid = m.id;

    const img = document.createElement("img");
    img.src = m.src;
    img.alt = m.name;

    const name = document.createElement("div");
    name.className = "map-thumb-name";
    name.textContent = m.name;

    div.appendChild(img);
    div.appendChild(name);

    div.addEventListener("click", ()=>{
      seleccionarMapaDesdeGaleria(m.id);
    });

    gallery.appendChild(div);
  });

  // leyenda del set
  leyendaBox.innerHTML = set.legendHTML;
  mapHint.textContent = '';

  // seleccionar el primer mapa por defecto
  const first = gallery.querySelector(".map-thumb");
  if (first) first.classList.add("selected");
}

/* Seleccionar un mapa al pulsar miniatura */
function seleccionarMapaDesdeGaleria(id){
  const set = mapSets[selectorSet.value];
  const entry = set.maps.find(m => m.id === id);

  // marcar seleccionado visualmente
  document.querySelectorAll(".map-thumb").forEach(t => t.classList.remove("selected"));
  const thumb = document.querySelector(`.map-thumb[data-mapid="${id}"]`);
  if (thumb) thumb.classList.add("selected");

  if (!imagenMedica.src){
    mapHint.textContent = "Mapa seleccionado. Carga una imagen para visualizarlo.";
  } else if (entry && entry.src){
    cargarMapa(entry.src);
    mapHint.textContent = "";
  } else {
    mapaImg.hidden = true;
    mapHint.textContent = "El mapa seleccionado no tiene imagen configurada.";
  }
}

/* Obtener src del mapa actualmente seleccionado en la galer√≠a */
function getCurrentMapSrc(){
  const selected = document.querySelector(".map-thumb.selected");
  if (!selected) return null;

  const set = mapSets[selectorSet.value];
  const entry = set.maps.find(m => m.id === selected.dataset.mapid);

  return entry ? entry.src : null;
}

/* =========================================================
   ACTUALIZACI√ìN DE UI (TRANSFORMACIONES)
========================================================= */
function actualizarUI(){
  mapaImg.style.transform = `translate3d(${mapaX}px, ${mapaY}px, 0) scale(${escala})`;
  if (mapaImg.hidden){
    scaleBadge.style.display = 'none';
  } else {
    scaleBadge.style.display = 'block';
    scaleBadge.textContent = Math.round(escala * 100) + '%';
  }
}

/* Ajusta el tama√±o del contenedor en funci√≥n de la imagen base */
function contenedorDesdeImagen(){
  const rect = imagenMedica.getBoundingClientRect();
  let w = rect.width;
  let h = rect.height;

  /* Fallback: si a√∫n no hay bounding box v√°lido (p.ej. Android WebView) */
  if (!w || !h){
    w = contenedor.clientWidth;
    h = contenedor.clientHeight;
  }

  if (w > 0 && h > 0){
    contenedor.style.width  = w + 'px';
    contenedor.style.height = h + 'px';
  }
}

/* Ajuste del mapa al corte */
function ajustarMapaAFit(){
  if (!mapNatW || !mapNatH) return;

  const w = contenedor.clientWidth;
  const h = contenedor.clientHeight;

  if (!w || !h) return;

  const s = Math.min(w / mapNatW, h / mapNatH);
  escala = clamp(s, SCALE_MIN, SCALE_MAX);

  const mapW = mapNatW * escala;
  const mapH = mapNatH * escala;

  mapaX = (w - mapW)/2;
  mapaY = (h - mapH)/2;

  actualizarUI();
}

/* =========================================================
   CARGA DE IMAGEN Y MAPA
========================================================= */
function cargarImagenDesdeArchivo(file){
  if (!file || !file.type?.startsWith('image/')) return;

  const lector = new FileReader();
  lector.onload = (ev)=>{
    imagenMedica.onload = ()=>{
      dropzone.style.display = 'none';
      imagenMedica.removeAttribute('aria-hidden');

      /* Esperar un frame para asegurar layout correcto (importante en Android) */
      requestAnimationFrame(()=>{
        contenedorDesdeImagen();
        const src = getCurrentMapSrc();
        if (src){
          cargarMapa(src);
        } else {
          mapaImg.hidden = true;
          mapHint.textContent = 'El mapa seleccionado no tiene imagen configurada.';
        }
        actualizarUI();
      });
    };
    imagenMedica.src = ev.target.result;
  };
  lector.readAsDataURL(file);
}

function cargarMapa(src){
  if (!src){
    mapHint.textContent = 'El mapa seleccionado no tiene imagen configurada.';
    return;
  }
  mapHint.textContent = '';
  mapaImg.hidden = false;

  mapaImg.onload = ()=>{
    mapNatW = mapaImg.naturalWidth;
    mapNatH = mapaImg.naturalHeight;
    ajustarMapaAFit();
  };
  mapaImg.onerror = ()=>{
    mapaImg.hidden = true;
    mapHint.textContent = 'No se ha podido cargar la imagen del mapa (compruebe la ruta en Android).';
  };

  mapaImg.src = src;
}

/* =========================================================
   EVENTOS: ARCHIVOS / DROP / PASTE
========================================================= */
fileInput.addEventListener('change', e=> {
  cargarImagenDesdeArchivo(e.target.files?.[0]);
});

dropzone.addEventListener('click', ()=> fileInput.click());

['dragenter','dragover','dragleave','drop'].forEach(evt=>{
  document.addEventListener(evt, e=> e.preventDefault());
});

['dragenter','dragover'].forEach(evt=>{
  contenedor.addEventListener(evt, e=>{
    e.preventDefault();
    dropzone.classList.add('dragover');
  });
  dropzone.addEventListener(evt, e=>{
    e.preventDefault();
    dropzone.classList.add('dragover');
  });
});

['dragleave','drop'].forEach(evt=>{
  contenedor.addEventListener(evt, e=>{
    e.preventDefault();
    dropzone.classList.remove('dragover');
  });
  dropzone.addEventListener(evt, e=>{
    e.preventDefault();
    dropzone.classList.remove('dragover');
  });
});

contenedor.addEventListener('drop', e=>{
  cargarImagenDesdeArchivo(e.dataTransfer?.files?.[0]);
});

dropzone.addEventListener('drop', e=>{
  cargarImagenDesdeArchivo(e.dataTransfer?.files?.[0]);
});

window.addEventListener('paste', e=>{
  const items = e.clipboardData?.items || [];
  for (const it of items){
    if (it.type?.startsWith('image/')){
      cargarImagenDesdeArchivo(it.getAsFile());
      break;
    }
  }
});

/* Redimensionado */
window.addEventListener('resize', ()=>{
  contenedorDesdeImagen();
  actualizarUI();
});

/* =========================================================
   SELECTOR DE JUEGO DE MAPAS
========================================================= */
selectorSet.addEventListener('change', ()=>{
  populateMapGallery(selectorSet.value);

  if (imagenMedica.src){
    const src = getCurrentMapSrc();
    if (src){ cargarMapa(src); }
    else {
      mapaImg.hidden = true;
      mapHint.textContent = 'El mapa seleccionado no tiene imagen configurada.';
    }
  }
});

/* =========================================================
   OPACIDAD
========================================================= */
function actualizarOpacidad(val){
  mapaImg.style.opacity = val;
  opacidadVal.textContent = Math.round(val * 100) + '%';
}

opacidad.addEventListener('input', e=>{
  actualizarOpacidad(parseFloat(e.target.value));
});

/* =========================================================
   BOTONES B√ÅSICOS
========================================================= */
btnFlip.addEventListener('click', ()=>{
  const t = imagenMedica.style.transform;
  imagenMedica.style.transform = (t === 'scaleX(-1)') ? 'scaleX(1)' : 'scaleX(-1)';
});

btnReset.addEventListener('click', ajustarMapaAFit);

/* =========================================================
   PANEADO (RAT√ìN)
========================================================= */
contenedor.addEventListener('mousedown', e=>{
  if (mapaImg.hidden) return;
  arrastrando = true;
  mapaImg.classList.add('grabbing');
  inicioX = e.clientX - mapaX;
  inicioY = e.clientY - mapaY;
  e.preventDefault();
});

window.addEventListener('mouseup', ()=>{
  arrastrando = false;
  mapaImg.classList.remove('grabbing');
});

window.addEventListener('mousemove', e=>{
  if (!arrastrando) return;
  mapaX = e.clientX - inicioX;
  mapaY = e.clientY - inicioY;
  actualizarUI();
});

/* Doble clic para fit en escritorio */
if (!IS_TOUCH){
  contenedor.addEventListener('dblclick', ()=>{
    if (!mapaImg.hidden) ajustarMapaAFit();
  });
}

/* =========================================================
   ZOOM (RUEDA Y GESTOS)
========================================================= */
function zoomHaciaPuntero(deltaY, clientX, clientY){
  if (!mapNatW || !mapNatH) return;

  const rect = contenedor.getBoundingClientRect();
  const mouseX = clientX - rect.left;
  const mouseY = clientY - rect.top;

  const preX = (mouseX - mapaX) / escala;
  const preY = (mouseY - mapaY) / escala;

  const factor = (deltaY < 0) ? 1.015 : 0.985;  // zoom muy fino
  const nuevaEscala = clamp(escala * factor, SCALE_MIN, SCALE_MAX);

  mapaX = mouseX - preX * nuevaEscala;
  mapaY = mouseY - preY * nuevaEscala;

  escala = nuevaEscala;
  actualizarUI();
}

contenedor.addEventListener('wheel', e=>{
  if (!mapaImg.hidden){
    e.preventDefault();
    zoomHaciaPuntero(e.deltaY, e.clientX, e.clientY);
  }
},{passive:false});

/* Gestos t√°ctiles */
contenedor.addEventListener('touchstart', e=>{
  if (mapaImg.hidden) return;
  if (e.touches.length === 1){
    arrastrando = true;
    const t = e.touches[0];
    inicioX = t.clientX - mapaX;
    inicioY = t.clientY - mapaY;
  } else if (e.touches.length === 2){
    arrastrando  = false;
    pinchActiva  = true;
    const [t1, t2] = e.touches;
    pinchDist0 = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
    escala0    = escala;

    const r = contenedor.getBoundingClientRect();
    centroPinch = {
      x: ((t1.clientX + t2.clientX)/2) - r.left,
      y: ((t1.clientY + t2.clientY)/2) - r.top
    };
  }
},{passive:false});

contenedor.addEventListener('touchmove', e=>{
  if (mapaImg.hidden) return;
  e.preventDefault();

  if (pinchActiva && e.touches.length === 2){
    const [t1, t2] = e.touches;
    const dist  = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
    const ratio = dist / (pinchDist0 || dist);
    const nueva = clamp(escala0 * ratio, SCALE_MIN, SCALE_MAX);

    const preX = (centroPinch.x - mapaX) / escala;
    const preY = (centroPinch.y - mapaY) / escala;

    mapaX = centroPinch.x - preX * nueva;
    mapaY = centroPinch.y - preY * nueva;
    escala = nueva;

    actualizarUI();
  } else if (arrastrando && e.touches.length === 1){
    const t = e.touches[0];
    mapaX = t.clientX - inicioX;
    mapaY = t.clientY - inicioY;
    actualizarUI();
  }
},{passive:false});

contenedor.addEventListener('touchend', e=>{
  if (pinchActiva && e.touches && e.touches.length < 2){
    pinchActiva = false;
  }
  if (arrastrando && (!e.touches || e.touches.length === 0)){
    arrastrando = false;
  }
});

/* =========================================================
   ATAJOS DE TECLADO
========================================================= */
document.addEventListener('keydown', e=>{
  if (mapaImg.hidden) return;

  const tag = (e.target.tagName || '').toLowerCase();
  if (
    e.target.isContentEditable ||
    tag === 'textarea' ||
    (tag === 'input' && (e.target.type ?? 'text') === 'text')
  ){
    return;
  }

  const r  = contenedor.getBoundingClientRect();
  const cx = r.left + contenedor.clientWidth / 2;
  const cy = r.top  + contenedor.clientHeight / 2;
  const step = 20;
  const k = (e.key || '').toLowerCase();

  if (['arrowleft','arrowright','arrowup','arrowdown','+','-','=','r','f','0'].includes(k)){
    e.preventDefault();
  }

  if (k === 'arrowleft'){
    mapaX += step;
    actualizarUI();
  } else if (k === 'arrowright'){
    mapaX -= step;
    actualizarUI();
  } else if (k === 'arrowup'){
    mapaY += step;
    actualizarUI();
  } else if (k === 'arrowdown'){
    mapaY -= step;
    actualizarUI();
  } else if (k === '+' || k === '='){
    zoomHaciaPuntero(-1, cx, cy);
  } else if (k === '-'){
    zoomHaciaPuntero( 1, cx, cy);
  } else if (k === 'r' || k === '0'){
    ajustarMapaAFit();
  } else if (k === 'f'){
    btnFlip.click();
  }
});

/* =========================================================
   INICIO
========================================================= */
window.addEventListener('DOMContentLoaded', ()=>{
  populateSetSelect();
  selectorSet.value = 'infra_supra';
  populateMapGallery('infra_supra');
  actualizarOpacidad(parseFloat(opacidad.value));
});
</script><!-- Script general de la PWA / app (mantengo tu referencia original) -->
    <script src="js/index.js"></script>
  </body>
</html>
