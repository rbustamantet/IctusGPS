<!DOCTYPE html>
<html lang="es">
  <head>

    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1,
      viewport-fit=cover">
    <title>Detección automática de lesión cerebral | Ictus GPS</title>
    <link rel="manifest" href="../site.webmanifest">
    <link rel="icon" type="image/png" sizes="192x192"
      href="../iconos/ictusgps.png">
    <link rel="apple-touch-icon" sizes="180x180"
      href="../iconos/ictusgps.png">
    <link rel="shortcut icon" href="../iconos/ictusgps.png">
    <meta name="theme-color" content="#0f3d83">
    <style>
/* =========================================================
   VARIABLES GLOBALES
========================================================= */
:root{
  --bg:#f8fafc; 
  --ink:#0e1a33;
  --azul:#0f3d83;
  --accent-light:#2563eb;
  --border:#e5e9f2;
  --muted:#64748b;
  --borde:#e2e8f0;
}

/* =========================================================
   BASE
========================================================= */
html, body{
  margin:0;
  padding:0;
  background:var(--bg);
  color:var(--ink);
  font-family:Verdana, Geneva, Tahoma, sans-serif;
}

*{box-sizing:border-box;}

body{
  padding-top:calc(env(safe-area-inset-top, 0px) + 60px);
}

/* =========================================================
   SAFE-TOP
========================================================= */
.safe-top{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:calc(env(safe-area-inset-top) + 60px);
  background:var(--azul);
  z-index:1001;
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding-top:env(safe-area-inset-top);
}
.safe-content{
  width:100%;
  max-width:1080px;
  padding:6px 16px 8px;
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
}
.safe-left{
  display:flex;
  align-items:center;
  gap:10px;
}
.safe-mini{
  width:44px;
  height:44px;
  object-fit:contain;
  padding:4px;
}
.safe-logo{
  height:44px;
  width:auto;
}
.safe-actions{
  display:flex;
  gap:10px;
}
.safe-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:40px;
  height:40px;
  background:rgba(255,255,255,0.15);
  border:1px solid #ffffff;
  border-radius:50%;
}
.safe-btn:hover{
  background:#01c5fe;
}
.safe-icon{
  width:32px;
  height:32px;
}

/* =========================================================
   HEADER STICKY
========================================================= */
header{
  position:sticky;
  top:calc(env(safe-area-inset-top) + 52px);
  z-index:1002;
  background:var(--azul);
  color:#fff;
  border-bottom:1px solid rgba(255,255,255,.1);
}
.bar{
  display:flex;
  justify-content:flex-start;
  align-items:center;
  height:52px;
  padding:0 16px;
  gap:10px;
}
.bar img{
  width:32px;
}

/* =========================================================
   CUERPO PRINCIPAL
========================================================= */
.wrap{
  max-width:1100px;
  margin:0 auto;
  padding:1rem;
}

.howto{
  background:#fff;
  border:1px solid var(--border);
  border-radius:14px;
  padding:1rem;
  box-shadow:0 2px 4px rgba(0,0,0,0.08);
  font-size:14px;
  margin-bottom:1rem;
}

main{
  display:flex;
  gap:20px;
  flex-wrap:wrap;
}

/* =========================================================
   PANEL IZQUIERDO
========================================================= */
.left-panel{
  flex:1 1 58%;
}

h2{
  margin:0 0 .8rem;
  color:var(--azul);
}

/* Dropzone */
.dropzone{
  border:2px dashed var(--borde);
  border-radius:10px;
  padding:1rem;
  text-align:center;
  color:var(--muted);
  cursor:pointer;
  margin-bottom:1rem;
  background:#ffffff;
}
.dropzone.dragover{
  background:#eef7ff;
  border-color:var(--accent-light);
}

#contenedorImagen{
  position:relative;
  width:100%;
  background:#000;
  border-radius:8px;
  overflow:hidden;
  min-height:260px;
  border:1px solid var(--borde);
}
#imagenBase{
  width:100%;
  height:auto;
  display:none;
}
#maskOverlay{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  display:none;
  pointer-events:none;
}

/* Opacidad */
.opacity-control{
  margin:.6rem 0;
  display:flex;
  align-items:center;
  gap:.6rem;
}

/* =========================================================
   PANEL DERECHO (CONTROLES)
========================================================= */
.right-panel{
  flex:1 1 38%;
}

.panel-box{
  background:#fff;
  border:1px solid var(--border);
  border-radius:10px;
  padding:1rem;
  margin-bottom:1rem;
  box-shadow:0 2px 4px rgba(0,0,0,0.06);
}

.field{
  margin-bottom:.8rem;
}
label{
  display:block;
  font-size:.9rem;
  color:var(--muted);
  margin-bottom:.2rem;
}
select, input[type=range], input[type=checkbox]{
  font-size:1rem;
}
.hint.small{
  font-size:.8rem;
  color:var(--muted);
  margin-top:.1rem;
}

/* Botones */
button{
  padding:.55rem .9rem;
  border-radius:6px;
  border:1px solid var(--borde);
  background:#f1f5f9;
  cursor:pointer;
  font-size:1rem;
  margin-right:.4rem;
}
button:hover{
  background:#e2e8f0;
}
.btn-primary{
  background:var(--accent-light);
  color:#fff;
  border-color:var(--accent-light);
}
.btn-primary:hover{
  background:#1d4ed8;
}

/* Resultados */
.result-card{
  background:#fff;
  border:1px solid var(--border);
  padding:1rem;
  border-radius:10px;
  margin-bottom:1rem;
}
.result-card ul{
  padding-left:1.1rem;
  margin:.3rem 0;
}
.result-card li{
  margin:.2rem 0;
}

/* Nota */
.nota{
  font-size:.75rem;
  color:var(--muted);
  margin-top:.6rem;
}

/* Footer */
footer{
  width:100%;
  margin:2rem 0 0;
  padding:1.5rem 0;
  border-top:1px solid var(--border);
  background:#ffffff;
  text-align:center;
}
footer img{
  max-width:320px;
}

</style>
  </head>
  <body>
    <!-- =========================================================
     SAFE-TOP
========================================================= -->
    <div class="safe-top">
      <div class="safe-content">
        <div class="safe-left"> <img src="../iconos/utilidadesico.png"
            class="safe-mini" alt=""> <img src="../img/topbar.png"
            class="safe-logo" alt="Ictus GPS"> </div>
        <div class="safe-actions"> <a href="javascript:history.back()"
            class="safe-btn"><img src="../iconos/atrastransparente.png"
              class="safe-icon"></a> <a href="../index.html"
            class="safe-btn"><img src="../iconos/hometransparente.png"
              class="safe-icon"></a> </div>
      </div>
    </div>
    <!-- =========================================================
     HEADER
========================================================= -->
    <header>
      <div class="bar"> <img src="../iconos/ictusgpsico.png"> <span
          style="font-size:1.3rem;font-weight:700;">Detección automática
          de lesión (TC/RM)</span> </div>
    </header>
    <!-- =========================================================
     CONTENIDO PRINCIPAL
========================================================= -->
    <div class="wrap">
      <div class="howto" align="justify"> Carga una imagen de TC o RM
        para detectar automáticamente áreas sospechosas de lesión y
        estimar el territorio vascular probable. La herramienta funciona
        localmente en tu dispositivo y no envía datos a ningún servidor.
      </div>
      <main>
        <!-- =========================================================
     PANEL IZQUIERDO
========================================================= -->
        <div class="left-panel">
          <h2>Imagen</h2>
          <div id="dropzone" class="dropzone"> <strong>Arrastra aquí
              una imagen de TC o RM</strong>
            <div class="hint">o haz clic para seleccionar</div>
          </div>
          <input id="fileInput" accept="image/*" style="display:none;"
            type="file">
          <div id="contenedorImagen"> <img id="imagenBase" alt=""> <canvas
              id="maskOverlay"></canvas> </div>
          <div class="opacity-control"> <label for="maskOpacity">Opacidad
              de la máscara:</label> <input id="maskOpacity" min="0"
              max="1" step="0.01" value="0.6" type="range"> <span
              id="maskOpacityVal">60%</span> </div>
          <div> <input id="toggleMask" checked="checked"
              type="checkbox"> <label for="toggleMask">Mostrar máscara
              de lesión</label> </div>
        </div>
        <!-- =========================================================
     PANEL DERECHO
========================================================= -->
        <div class="right-panel">
          <div class="panel-box">
            <h2>Parámetros del detector</h2>
            <div class="field"> <label for="tipoImagen">Tipo de imagen</label>
              <select id="tipoImagen">
                <option value="auto" selected="selected">Detección
                  automática</option>
                <option value="tc">TC simple</option>
                <option value="dwi">RM DWI</option>
                <option value="flair">RM FLAIR</option>
                <option value="adc">RM ADC</option>
              </select>
            </div>
            <div class="field"> <label>Sensibilidad</label> <input
                id="sensibilidad" min="1" max="5" value="3" type="range">
              <div class="hint small">A mayor sensibilidad, mayor
                detección pero más ruido.</div>
            </div>
            <div class="field"> <label>Suavizado</label> <input
                id="suavizado" min="0" max="3" value="1" type="range"> </div>
            <div class="field"> <input id="comparacionHemisferica"
                checked="checked" type="checkbox"> <label
                for="comparacionHemisferica">Usar comparación
                hemisférica</label> </div>
          </div>
          <div class="panel-box">
            <h2>Acciones</h2>
            <button id="btnDetectar" class="btn-primary">Detectar lesión</button>
            <button id="btnBorrarMask">Borrar máscara</button> <button
              id="btnResetTodo">Reiniciar</button> </div>
          <div class="result-card">
            <h3>Resumen de la lesión</h3>
            <p>Área estimada: <strong id="areaLesion">–</strong></p>
            <p>Asimetría hemisférica: <strong id="asimetriaLesion">–</strong></p>
            <p>Confianza del detector: <strong id="confianzaDetector">–</strong></p>
          </div>
          <div class="result-card">
            <h3>Territorio probable</h3>
            <ul id="listaTerritorios">
            </ul>
          </div>
          <div class="nota"> ⚠ Esta herramienta es orientativa y no
            sustituye la interpretación experta. </div>
        </div>
      </main>
    </div>
    <footer> <img src="../img/uibanner.png" alt="Ictus GPS">
    </footer>
    <script>
/* =========================================================
   REFERENCIAS DOM
========================================================= */
const dropzone        = document.getElementById("dropzone");
const fileInput       = document.getElementById("fileInput");
const imagenBase      = document.getElementById("imagenBase");
const maskCanvas      = document.getElementById("maskOverlay");
const maskCtx         = maskCanvas.getContext("2d");

const tipoImagenSel   = document.getElementById("tipoImagen");
const sensibilidadSel = document.getElementById("sensibilidad");
const suavizadoSel    = document.getElementById("suavizado");
const compHCheck      = document.getElementById("comparacionHemisferica");

const maskOpacity     = document.getElementById("maskOpacity");
const maskOpacityVal  = document.getElementById("maskOpacityVal");
const toggleMask      = document.getElementById("toggleMask");

const btnDetectar     = document.getElementById("btnDetectar");
const btnBorrarMask   = document.getElementById("btnBorrarMask");
const btnResetTodo    = document.getElementById("btnResetTodo");

const areaLesionEl    = document.getElementById("areaLesion");
const asimetriaEl     = document.getElementById("asimetriaLesion");
const confianzaEl     = document.getElementById("confianzaDetector");
const listaTerritorios= document.getElementById("listaTerritorios");

let imgLoaded = false;
// si algún día añades botón “Voltear”, cambia esta bandera:
let imagenInvertida = false;

/* =========================================================
   UTILIDADES GENERALES
========================================================= */
function avg(arr){
  if(!arr.length) return 0;
  return arr.reduce((a,b)=>a+b,0)/arr.length;
}

function percentileFromHist(hist, total, p){
  const target = total * p;
  let acc = 0;
  for(let i=0;i<256;i++){
    acc += hist[i] || 0;
    if(acc >= target) return i;
  }
  return 255;
}

function resizeMaskCanvas(){
  const rect = imagenBase.getBoundingClientRect();
  const w = Math.max(1, Math.round(rect.width));
  const h = Math.max(1, Math.round(rect.height));
  maskCanvas.width  = w;
  maskCanvas.height = h;
}

/* =========================================================
   CARGA DE IMAGEN
========================================================= */
dropzone.addEventListener("click", ()=> fileInput.click());

fileInput.addEventListener("change", e=>{
  if(e.target.files && e.target.files[0]){
    loadImage(e.target.files[0]);
  }
});

["dragenter","dragover","dragleave","drop"].forEach(ev=>{
  dropzone.addEventListener(ev, e=>{
    e.preventDefault();
    if(ev==="dragover") dropzone.classList.add("dragover");
    else if(ev==="dragleave" || ev==="drop") dropzone.classList.remove("dragover");
  });
});

dropzone.addEventListener("drop", e=>{
  const f = e.dataTransfer.files[0];
  if(f) loadImage(f);
});

window.addEventListener("paste", e=>{
  const items = e.clipboardData && e.clipboardData.items;
  if(!items) return;
  for(const it of items){
    if(it.type && it.type.startsWith("image/")){
      loadImage(it.getAsFile());
      break;
    }
  }
});

function loadImage(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    imagenBase.onload = ()=>{
      imgLoaded = true;
      imagenBase.style.display = "block";
      resizeMaskCanvas();
      maskCtx.clearRect(0,0,maskCanvas.width,maskCanvas.height);
      // reset resultados
      actualizarResultados(null,null,null,null);
    };
    imagenBase.src = reader.result;
  };
  reader.readAsDataURL(file);
}

/* =========================================================
   CONTROL DE MÁSCARA
========================================================= */
maskOpacity.addEventListener("input", e=>{
  const v = parseFloat(e.target.value);
  maskOpacityVal.textContent = Math.round(v*100)+"%";
  maskCanvas.style.opacity = v;
});
maskCanvas.style.opacity = parseFloat(maskOpacity.value);

toggleMask.addEventListener("change", e=>{
  maskCanvas.style.display = e.target.checked ? "block" : "none";
});
toggleMask.dispatchEvent(new Event("change"));

/* =========================================================
   ESTADÍSTICAS DE IMAGEN
========================================================= */
function computeStats(imgData, w, h){
  const data = imgData.data;
  const hist = new Array(256).fill(0);
  const half = Math.floor(w/2);

  let vals = [];
  let leftVals = [];
  let rightVals = [];

  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const idx = (y*w + x)*4;
      const r = data[idx], g = data[idx+1], b = data[idx+2];

      // excluir fondo muy negro
      if(r<5 && g<5 && b<5) continue;

      const val = 0.3*r + 0.59*g + 0.11*b;
      const v = Math.max(0, Math.min(255, Math.round(val)));
      hist[v]++;
      vals.push(v);
      if(x<half) leftVals.push(v); else rightVals.push(v);
    }
  }

  const m  = avg(vals);
  const ml = avg(leftVals);
  const mr = avg(rightVals);
  let s2 = 0;
  for(const v of vals) s2 += (v-m)*(v-m);
  const std = vals.length ? Math.sqrt(s2/vals.length) : 0;

  return {
    hist,
    total: vals.length,
    mean: m,
    std: std,
    meanLeft: ml,
    meanRight: mr
  };
}

/* =========================================================
   MORFOLOGÍA / COMPONENTES CONECTADOS
========================================================= */
function smoothMask(binaryMask, w, h, iterations){
  if(!iterations) return binaryMask;
  let src = binaryMask;
  for(let it=0;it<iterations;it++){
    const dst = new Uint8Array(w*h);
    for(let y=1;y<h-1;y++){
      for(let x=1;x<w-1;x++){
        let c=0;
        for(let dy=-1;dy<=1;dy++){
          for(let dx=-1;dx<=1;dx++){
            const nx=x+dx, ny=y+dy;
            if(src[ny*w+nx]) c++;
          }
        }
        if(c>=5) dst[y*w+x]=1;
      }
    }
    src = dst;
  }
  return src;
}

function extractLargestComponent(binaryMask, w, h){
  const visited = new Uint8Array(w*h);
  const dirs = [[1,0],[-1,0],[0,1],[0,-1]];
  let bestComp = [];
  let bestSize = 0;

  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const idx = y*w + x;
      if(!binaryMask[idx] || visited[idx]) continue;

      let stack = [idx];
      let comp  = [];
      visited[idx] = 1;

      while(stack.length){
        const p = stack.pop();
        comp.push(p);
        const px = p % w;
        const py = (p / w)|0;

        for(const [dx,dy] of dirs){
          const nx = px+dx, ny = py+dy;
          if(nx<0||ny<0||nx>=w||ny>=h) continue;
          const ni = ny*w+nx;
          if(binaryMask[ni] && !visited[ni]){
            visited[ni]=1;
            stack.push(ni);
          }
        }
      }

      if(comp.length>bestSize){
        bestSize = comp.length;
        bestComp = comp;
      }
    }
  }

  return bestComp;
}

function renderMask(binaryMask, w, h){
  const img = maskCtx.createImageData(w,h);
  const d   = img.data;
  for(let i=0;i<w*h;i++){
    if(binaryMask[i]){
      const idx = i*4;
      d[idx]   = 255;
      d[idx+1] = 0;
      d[idx+2] = 0;
      d[idx+3] = 185;
    }
  }
  maskCtx.putImageData(img,0,0);
}

/* =========================================================
   DETECTORES POR MODALIDAD
========================================================= */
// DWI / FLAIR: hiperintensidad
function detectHyperintensity(imgData, w, h, sensibilidad, usarCompH){
  const stats = computeStats(imgData,w,h);
  if(!stats.total) return null;

  const baseP = 0.94 + (sensibilidad-1)*0.01; // 0.94–0.98
  const pHigh = Math.max(0.90, Math.min(0.99, baseP));
  let thr     = percentileFromHist(stats.hist, stats.total, pHigh);

  if(usarCompH){
    const diff = Math.abs(stats.meanLeft - stats.meanRight);
    thr -= diff*0.05; // baja ligeramente el umbral si hay asimetría
  }

  const data   = imgData.data;
  const binary = new Uint8Array(w*h);
  const marginX = Math.floor(w*0.05);
  const marginY = Math.floor(h*0.05);

  for(let y=marginY; y<h-marginY; y++){
    for(let x=marginX; x<w-marginX; x++){
      const idx = (y*w+x)*4;
      const r = data[idx], g = data[idx+1], b = data[idx+2];

      if(r<5 && g<5 && b<5) continue; // fondo

      const val = 0.3*r + 0.59*g + 0.11*b;
      if(val >= thr){
        binary[y*w+x] = 1;
      }
    }
  }

  return {binary, stats};
}

// ADC / TC: hipodensidad / hipointensidad
function detectHypointensity(imgData, w, h, sensibilidad, usarCompH){
  const stats = computeStats(imgData,w,h);
  if(!stats.total) return null;

  const baseP = 0.13 - (sensibilidad-1)*0.015; // 0.13–0.07
  const pLow  = Math.max(0.02, Math.min(0.25, baseP));
  let thr     = percentileFromHist(stats.hist, stats.total, pLow);

  if(usarCompH){
    const diff = Math.abs(stats.meanLeft - stats.meanRight);
    thr += diff*0.05; // sube umbral si hay mucha asimetría global
  }

  const data   = imgData.data;
  const binary = new Uint8Array(w*h);
  const marginX = Math.floor(w*0.05);
  const marginY = Math.floor(h*0.05);

  for(let y=marginY; y<h-marginY; y++){
    for(let x=marginX; x<w-marginX; x++){
      const idx = (y*w+x)*4;
      const r = data[idx], g = data[idx+1], b = data[idx+2];
      if(r<5 && g<5 && b<5) continue; // fondo

      const val = 0.3*r + 0.59*g + 0.11*b;
      if(val > 240) continue;        // excluir hueso muy brillante

      if(val <= thr){
        binary[y*w+x] = 1;
      }
    }
  }

  return {binary, stats};
}

/* =========================================================
   ORIENTACIÓN NEUROIMAGEN
   (radiológica: pantalla izq = hemisferio derecho)
========================================================= */
function hemisferioDesdeImagen(cx, w, invertida){
  const ladoPantalla = (cx < w/2) ? "izquierda" : "derecha";
  let hemi = (ladoPantalla === "izquierda") ? "derecho" : "izquierdo";
  if(invertida){
    hemi = (hemi === "derecho") ? "izquierdo" : "derecho";
  }
  return hemi;
}

/* =========================================================
   CLASIFICACIÓN VASCULAR PRO (orientativa)
========================================================= */
function clasificarTerritorioVascular(cx, cy, w, h, modo){
  const xNorm = cx / w;
  const yNorm = cy / h;

  const dx = xNorm - 0.5;
  const dy = yNorm - 0.5;
  const r  = Math.sqrt(dx*dx + dy*dy); // 0 centro profundo, >0.3 cortical

  let territorio = "";
  let detalles   = [];
  let segmentos  = [];

  // corte supratentorial estándar
  if(yNorm < 0.25){
    territorio = "ACA";
    segmentos.push("A2–A3 (pericallosa/callosomarginal)");
  } else if(yNorm < 0.40){
    territorio = "ACM (tronco superior)";
    segmentos.push(r < 0.25 ? "Segmento M2 insular/suprainsular" : "Segmento M3 cortical frontoparietal");
  } else if(yNorm < 0.60){
    if(r < 0.22){
      territorio = "Perforantes profundas";
      segmentos.push("Lenticuloestriadas / talamoperforantes (M1–M2 proximal)");
    } else {
      territorio = "ACM (tronco inferior)";
      segmentos.push("M2 insular / M3 opercular y cortical lateral");
    }
  } else if(yNorm < 0.80){
    territorio = "Zona de transición ACM/PCA";
    detalles.push("Posible watershed distal parietal-occipital");
    segmentos.push("Ramas parietales posteriores (M4) o P2");
  } else {
    territorio = "PCA";
    if(yNorm > 0.88) segmentos.push("Segmento P3 cortical occipital");
    else segmentos.push("Segmento P2 parieto-occipital");
  }

  // ligero ajuste según modalidad
  if(modo === "adc" || modo === "tc" && territorio === "Perforantes profundas"){
    detalles.push("Patrón compatible con infarto lacunar / microangiopatía.");
  }

  return {territorio, detalles, segmentos};
}

/* =========================================================
   DETECCIÓN PRINCIPAL
========================================================= */
btnDetectar.addEventListener("click", detectarLesion);

function detectarLesion(){
  if(!imgLoaded){
    alert("Carga una imagen primero.");
    return;
  }

  resizeMaskCanvas();
  const w = maskCanvas.width;
  const h = maskCanvas.height;

  const tmp   = document.createElement("canvas");
  tmp.width   = w;
  tmp.height  = h;
  const tctx  = tmp.getContext("2d");
  tctx.drawImage(imagenBase, 0, 0, w, h);
  const imgData = tctx.getImageData(0,0,w,h);

  const sensibilidad = parseInt(sensibilidadSel.value,10);
  const suavizado    = parseInt(suavizadoSel.value,10);
  const usarCompH    = compHCheck.checked;

  // decidir modo efectivo
  let modo = tipoImagenSel.value;
  if(modo === "auto"){
    const stats = computeStats(imgData,w,h);
    const hist = stats.hist;
    const total= stats.total || 1;
    let veryDark=0, veryBright=0;
    for(let i=0;i<20;i++) veryDark += hist[i];
    for(let i=235;i<256;i++) veryBright += hist[i];
    const fracDark = veryDark/total;
    const fracBright=veryBright/total;
    // heurístico bruto
    if(fracDark>0.15 && fracBright>0.10) modo = "tc";
    else modo = "dwi";
  }

  let result = null;
  if(modo === "dwi" || modo === "flair"){
    result = detectHyperintensity(imgData,w,h,sensibilidad,usarCompH);
  } else { // "adc" o "tc"
    result = detectHypointensity(imgData,w,h,sensibilidad,usarCompH);
  }

  maskCtx.clearRect(0,0,w,h);

  if(!result || !result.binary){
    actualizarResultados(null,null,null,modo);
    alert("No se han detectado áreas claramente anómalas con los parámetros actuales.");
    return;
  }

  // suavizado + componente principal
  const smoothed = smoothMask(result.binary, w, h, suavizado);
  const lesionComp = extractLargestComponent(smoothed, w, h);

  if(!lesionComp.length){
    actualizarResultados(null,null,null,modo);
    alert("No se ha identificado una lesión bien delimitada.");
    return;
  }

  // construir mapa binario nuevo solo con la lesión principal
  const binaryMain = new Uint8Array(w*h);
  for(const idx of lesionComp) binaryMain[idx] = 1;

  renderMask(binaryMain, w, h);

  actualizarResultados(binaryMain, w, h, modo);
}

/* =========================================================
   RESULTADOS + VASCULAR
========================================================= */
function actualizarResultados(binaryMask, w, h, modo){
  if(!binaryMask){
    areaLesionEl.textContent = "–";
    asimetriaEl.textContent  = "–";
    confianzaEl.textContent  = "–";
    listaTerritorios.innerHTML = "";
    return;
  }

  let count = 0;
  let sumX = 0, sumY = 0;

  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const idx = y*w + x;
      if(binaryMask[idx]){
        count++;
        sumX += x;
        sumY += y;
      }
    }
  }

  if(!count){
    areaLesionEl.textContent = "0 cm²";
    asimetriaEl.textContent  = "baja";
    confianzaEl.textContent  = "baja";
    listaTerritorios.innerHTML = "<li>Sin lesión bien definida.</li>";
    return;
  }

  const cx = sumX / count;
  const cy = sumY / count;

  const areaPx  = count;
  const areaCm2 = (areaPx / (w*h)) * 100;   // escala ficticia, solo comparativa
  areaLesionEl.textContent = areaCm2.toFixed(2) + " cm²";

  const hemi = hemisferioDesdeImagen(cx, w, imagenInvertida);
  asimetriaEl.textContent = "hemisferio " + hemi;

  let conf = "media";
  if(areaCm2 < 1.0) conf = "baja";
  else if(areaCm2 > 25) conf = "media-baja (lesión muy extensa / posible ruido)";
  else conf = "media-alta";
  confianzaEl.textContent = conf;

  const clasif = clasificarTerritorioVascular(cx, cy, w, h, modo);
  const territorio = clasif.territorio || "territorio indeterminado";

  let html = "";
  html += `<li>Lesión en hemisferio <strong>${hemi}</strong>.</li>`;
  html += `<li>Territorio vascular principal: <strong>${territorio}</strong>.</li>`;

  if(clasif.segmentos && clasif.segmentos.length){
    html += `<li>Segmento/s sugeridos: ${clasif.segmentos.join("; ")}.</li>`;
  }
  if(clasif.detalles && clasif.detalles.length){
    html += `<li>${clasif.detalles.join(" ")}</li>`;
  }
  html += `<li>Modalidad analizada: <strong>${modo.toUpperCase()}</strong> (clasificación orientativa).</li>`;

  listaTerritorios.innerHTML = html;
}

/* =========================================================
   BOTONES BORRAR / REINICIAR
========================================================= */
btnBorrarMask.addEventListener("click", ()=>{
  maskCtx.clearRect(0,0,maskCanvas.width,maskCanvas.height);
  actualizarResultados(null,null,null,null);
});

btnResetTodo.addEventListener("click", ()=>{
  imagenBase.src = "";
  imagenBase.style.display="none";
  maskCtx.clearRect(0,0,maskCanvas.width,maskCanvas.height);
  imgLoaded = false;
  actualizarResultados(null,null,null,null);
});

/* =========================================================
   REDIMENSIONADO
========================================================= */
window.addEventListener("resize", ()=>{
  if(!imgLoaded) return;
  resizeMaskCanvas();
});
</script>
    <script src="js/index.js"></script>
  </body>
</html>
