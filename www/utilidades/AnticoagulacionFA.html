<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="../site.webmanifest">
<link rel="icon" type="image/png" sizes="192x192" href="../iconos/ictusgps.png">
<link rel="apple-touch-icon" sizes="180x180" href="../iconos/ictusgps.png">
<link rel="shortcut icon" href="../iconos/ictusgps.png">
<meta name="theme-color" content="#0f3d83">
<title>Fibrilaci√≥n Auricular</title>

<style>

/* =========================================================
   VARIABLES GLOBALES
========================================================= */
:root{
  --bg:#f8fafc; 
  --ink:#0e1a33;

  --azul:#0f3d83;
  --azul-institucional:#0f3d83;

  --accent-dark:#0f3d83;
  --accent-light:#2563eb;

  --border:#e5e9f2;
  --muted:#64748b;

  --ok:#166534;
  --ok-bg:#e9fce7;
  --ok-ring:#bbf7d0;

  --mid:#92400e;
  --mid-bg:#fff7ed;
  --mid-ring:#fed7aa;

  --bad:#991b1b;
  --bad-bg:#fef2f2;
  --bad-ring:#fecaca;

  --gris:#6b7280;
  --borde:#e5e7eb;
  --error:#b91c1c;
}

/* =========================================================
   SAFE-TOP (FIJO 60 px + notch)
========================================================= */
.safe-top {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: calc(env(safe-area-inset-top) + 60px);
  background: var(--azul-institucional);
  z-index: 1001;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding-top: env(safe-area-inset-top);
}

.safe-content{
  width:100%;
  max-width:1080px;
  padding: 6px 16px 8px;
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
}

.safe-left{
  display:flex;
  align-items:center;
  gap:10px;
}

.safe-mini{
  width:44px;
  height:44px;
  object-fit:contain;
  padding:4px;
  box-shadow:0 0 4px rgba(0,0,0,0.1);
}

.safe-logo{
  height:44px;
  width:auto;
}

.safe-actions{
  display:flex;
  gap:10px;
}

.safe-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:40px;
  height:40px;
  background:rgba(255,255,255,0.15);
  border:1px solid white;
  border-radius:50%;
  transition:background .25s, border-color .25s, transform .1s;
}

.safe-btn:hover{
  background:#01c5fe;
}

.safe-btn:active{
  transform:scale(0.95);
}

.safe-icon{
  width:32px; 
  height:32px;
  object-fit:contain;
}

/* =========================================================
   CABECERA STICKY
========================================================= */
header{
  position:sticky;
  top:calc(env(safe-area-inset-top) + 52px);
  z-index:1002;
  backdrop-filter:blur(6px);
  background:var(--azul-institucional);
  border-bottom:1px solid rgba(255,255,255,.08);
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
  color:#fff;
}

.bar{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  height:52px;
  padding:0 16px;
}

.title{
  display:flex;
  align-items:center;
  font-size:1.4rem;
  font-weight:700;
  color:#fff;
}

.title img{
  width:32px;
  height:32px;
  margin-right:8px;
}

/* =========================================================
   TIPOGRAF√çA Y TARJETAS
========================================================= */
html,body,.wrap,.card,label,input,select,button,table,p,h1,h2,h3,li{
  font-family:Verdana,Geneva,sans-serif!important;
}

.wrap{
  max-width:1080px;
  margin:16px auto;
  padding:0 12px 40px;
}

.card{
  background:#fff;
  border-radius:14px;
  box-shadow:0 3px 14px rgba(16,71,119,.12);
  padding:16px;
  margin:12px 0;
}

.grid{display:grid; gap:12px;}
.g-2{grid-template-columns:repeat(auto-fit,minmax(260px,1fr));}
.g-3{grid-template-columns:repeat(auto-fit,minmax(40%,1fr));}

label{font-weight:600;font-size:.92rem;color:#0f3f66;display:block;margin-bottom:6px;}
label.row{font-weight:400;}
.row{display:flex;gap:8px;align-items:center;margin:4px 0;}

input[type="number"],select{
  width:100%;
  box-sizing:border-box;
  border:1px solid #cfe3f6;
  background:#fff;
  border-radius:10px;
  padding:10px 12px;
  font-size:1rem;
}

small.hint{color:#345;opacity:.8;}

.btnbar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:8px;
  align-items:center;
}

button{
  border:0;
  border-radius:999px;
  padding:10px 16px;
  font-weight:700;
  cursor:pointer;
  line-height:1;
  flex:0 0 auto;
}

.primary{background:#0f3d83;color:#fff;}
.primary:hover {background:#fff;color:#0f3d83;border:2px solid #0f3d83;}

.ghost{background:#fff;color:#0f3d83;border:2px solid #0f3d83;}
.ghost:hover {background:#0f3d83;color:#fff;border:2px solid #0f3d83;}

/* =========================================================
   TABLAS / PILLS / RESULTADOS
========================================================= */
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;font-size:.95rem;}
th,td{padding:6px;border-bottom:1px solid #e8f2fb;text-align:left;vertical-align:top;}
thead th{background:#eef6ff;color:#0b4576;font-size:.9rem;}
tfoot td{background:#f3f9ff;}

.muted{color:#567;}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:700;font-size:.8rem;}
.ok{background:#e8f5e9;color:#1b5e20;}
.okr{background:#ffcccc;color:#660000;}
.okb{background:#0f3d83;color:#ffffff;}
.bad{background:#ffebee;color:#b71c1c;}
.note{font-size:.86rem;color:#456;}
.center{text-align:center;}
.subtle{color:#345;opacity:.85;}
.subtle2{background:#fff5f5;color:#660000;opacity:.85;}
.sticky-result{position:relative}
.result-anchor{scroll-margin-top:84px}

.sep{height:1px;background:#e7f0fb;margin:14px 0;}

.inlineSelect{display:flex;gap:8px;}
.unit{width:44%;}
.val{flex:1;}
/* Mejores opciones */
    #comparative tbody tr.best td{background:#e8f5e9}
    #comparative tbody tr.best td:first-child{border-left:4px solid var(--ok);font-weight:700}
    /* Adecuaci√≥n cl√≠nica */
    .tagPref{background:#e8f5e9;color:#1b5e20;border:1px solid #b7dfbf}
    .tagAvoid{background:#ffebee;color:#b71c1c;border:1px solid #f3c5c8}
    .tagNeutral{background:#eef6ff;color:#0b4576;border:1px solid #cfe3f6}
    .rec-list li{margin:4px 0}
    .list-min{padding-left:16px;margin:0}
    .doseTag{background:#fff4ce;color:#7a4e00;border:1px solid #ffe08a;padding:2px 8px;border-radius:999px;font-weight:700;font-size:.8rem}
    .noOac{color:#b71c1c;font-weight:800}

/* Columnas visibles */
#comparative tbody td._zebra{background:#eef6ff;}
@media (max-width:640px){
  .col-rra,.col-rrs{display:none;}
}




/* Toast */
.toast{
  position:fixed;
  top: calc(env(safe-area-inset-top) + 104px);
  left:50%;
  transform:translateX(-50%) translateY(-10px);
  width:calc(100% - 32px);
  max-width:680px;
  text-align:center;
  background:#b71c1c;
  border-radius:5px;
  color:#fff;
  padding:10px;
  box-shadow:0 6px 24px rgba(0,0,0,.18);
  opacity:0;
  pointer-events:none;
  z-index:1003;
  transition:opacity .25s,transform .25s;
  font-weight:600;
}
.toast.show{
  opacity:1;
  transform:translateX(-50%) translateY(0);
}.toast.warn{background:#f57c00;}
.toast.info{background:#1976d2;}

/* Referencias */
    #refContent{overflow:hidden;  border:1px solid #1976d2;background:#eef6ff;border-radius:9px;
max-height:0;transition:max-height .4s ease}
    #refContent.show{display:block!important;max-height:4000px}
    .back-btn{display:inline-block;margin:1.5rem auto 0;background:#0f3d83;color:#fff;text-decoration:none;font-weight:700;padding:.7rem 1.4rem;border-radius:10px;box-shadow:0 4px 10px rgba(15,61,131,.25);transition:background .2s,transform .1s,box-shadow .2s}
    .back-btn:hover{background:#1c60c3;transform:translateY(-1px);box-shadow:0 6px 12px rgba(15,61,131,.35)}

/* Disclaimer renal */
.renal-disclaimer{
  background:#f8fbff;
  border:1px solid #e3eef9;
  border-left:4px solid #1976d2;
  border-radius:12px;
  padding:10px 12px;
  margin:10px 0 0 0;
}
.renal-disclaimer b{color:#0b4576;}

/* =========================================================
   FOOTER
========================================================= */
footer{
  width:100%;
  margin:2rem 0 0;
  padding:1.5rem 0;
  border-top:1px solid #e5e7eb;
  background:#ffffff;
  text-align:center;
  box-shadow:0 -2px 6px rgba(0,0,0,0.04);
}

/* =========================================================
   MEDIA QUERIES
========================================================= */
@media(max-width:768px){
  header{font-size:1.05rem;}
  main{padding:0.9rem 1rem;}
  body{font-size:0.96rem;}
}

/* =========================================================
   PADDING SUPERIOR DEL CONTENIDO
========================================================= */

/* Empuja el contenido real por debajo de la barra superior */
body {
  margin: 0;
  padding-top: calc(env(safe-area-inset-top, 0px) + 52px);
  background-color: #fff;
}
</style>
</head>

<body>

<!-- SAFE-TOP -->
<div class="safe-top">
  <div class="safe-content">
    <div class="safe-left">
      <img src="../iconos/utilidadesico.png" class="safe-mini" alt="">
      <img src="../img/topbar.png" class="safe-logo" alt="IctusGPS">
    </div>

    <div class="safe-actions">
      <a href="javascript:history.back()" class="safe-btn">
        <img src="../iconos/atrastransparente.png" class="safe-icon">
      </a>
      <a href="../index.html" class="safe-btn">
        <img src="../iconos/hometransparente.png" class="safe-icon">
      </a>
    </div>
  </div>
</div>

<!-- CABECERA -->
<header>
  <div class="bar">
    <div class="title">
      <img src="anticoagulacion.png" alt="">
      Fibrilaci√≥n auricular
    </div>
  </div>
</header>


  <div class="wrap">
    <div class="card">
      <p class="note"><b>C√≥mo usar:</b> introduce los datos del paciente, marca los factores de riesgo y las
        <b>condiciones cl√≠nicas especiales</b>, y pulsa <span class="pill okb">Calcular</span>. Calcula
        <b>CHA<sub>2</sub>DS<sub>2</sub>-VASc</b>, <b>CHA<sub>2</sub>DS<sub>2</sub>-VA</b>, <b>HAS-BLED</b>,
        <b>ClCr (Cockcroft‚ÄìGault)</b> y muestra comparativa de eficacia/seguridad. Aplica
        reglas de <span class="pill ok">preferencia</span>üÜö<span class="pill okr">evitaci√≥n</span> por escenarios cl√≠nicos y sugiere posolog√≠a
        resaltando la <span class="doseTag">dosis reducida</span> cuando proceda.
      </p>
    </div>

    <!-- Datos del paciente -->
    <div class="card">
      <h2 style="margin:0 0 8px;">Datos del paciente</h2>
      <div class="grid g-2">
        <div>
          <label for="age">Edad (a√±os)</label>
          <input id="age" inputmode="numeric" max="110" min="18" placeholder="p. ej., 74" type="number"/>
        </div>
        <div>
          <label for="sex">Sexo</label>
          <select id="sex">
            <option value="">Selecciona‚Ä¶</option>
            <option value="M">Var√≥n</option>
            <option value="F">Mujer</option>
          </select>
        </div>
        <div>
          <label for="weight">Peso</label>
          <div class="inlineSelect">
            <input class="val" id="weight" max="400" min="10" placeholder="p. ej., 84.5" step="0.1" type="number"/>
            <select class="unit" id="weightUnit">
              <option value="kg">kg</option>
              <option value="lb">lb</option>
            </select>
          </div>
          <small class="hint">Puedes introducir kg o lb.</small>
        </div>
        <div>
          <label for="scr">Creatinina s√©rica</label>
          <div class="inlineSelect">
            <input class="val" id="scr" max="15" min="0.1" placeholder="p. ej., 1.1" step="0.01" type="number"/>
            <select class="unit" id="scrUnit">
              <option value="mgdl">mg/dL</option>
              <option value="umol">¬µmol/L</option>
            </select>
          </div>
          <small class="hint">Para ¬µmol/L, el sistema convierte a mg/dL (/ 88.4).</small>
        </div>
      </div>

      <div class="sep"></div>
      <div class="grid g-2">
        <div>
          <label>Factores CHA<sub>2</sub>DS<sub>2</sub>-VASc</label>
          <label class="row" for="cSc"><input id="cSc" type="checkbox"/> Sexo femenino</label>
          <label class="row" for="cAge65"><input id="cAge65" type="checkbox"/> Edad 65‚Äì74 a√±os</label>
          <label class="row" for="cAge75"><input id="cAge75" type="checkbox"/> Edad ‚â• 75 a√±os (2 pt)</label>
          <label class="row" for="cCongest"><input id="cCongest" type="checkbox"/> Insuficiencia cardiaca / disfunci√≥n VI</label>
          <label class="row" for="cStroke"><input id="cStroke" type="checkbox"/> Ictus/AIT/TE previo (2 pt)</label>
          <label class="row" for="cHTN"><input id="cHTN" type="checkbox"/> Hipertensi√≥n</label>
          <label class="row" for="cDiab"><input id="cDiab" type="checkbox"/> Diabetes</label>
          <label class="row" for="cVasc"><input id="cVasc" type="checkbox"/> Vascular (IAM, placa Ao, EAP)</label>
        </div>
        <div>
          <label>HAS-BLED</label>
          <label class="row" for="hHTN"><input id="hHTN" type="checkbox"/> HTA (&gt;160 mmHg sist.)</label>
          <label class="row" for="hRenal"><input id="hRenal" type="checkbox" title="Autorrelleno si SCr ‚â•2.26 mg/dL (~200 ¬µmol/L) o ClCr &lt;30 ml/min"/> Disfunci√≥n renal (incluye trasplante)</label>
          <label class="row" for="hLiver"><input id="hLiver" type="checkbox"/> Disfunci√≥n hep√°tica</label>
          <label class="row" for="hStroke"><input id="hStroke" type="checkbox"/> Ictus previo</label>
          <label class="row" for="hBleed"><input id="hBleed" type="checkbox"/> Sangrado mayor/di√°tesis</label>
          <label class="row" for="hLabileINR"><input id="hLabileINR" type="checkbox"/> INR l√°bil (si en VKA)</label>
          <label class="row" for="hElder"><input id="hElder" type="checkbox" title="Autorrelleno si edad &gt;65 a√±os"/> Edad &gt;65</label>
          <label class="row" for="hDrugs"><input id="hDrugs" type="checkbox"/> F√°rmacos (antiagregantes, AINEs...)</label>
          <label class="row" for="hAlcohol"><input id="hAlcohol" type="checkbox"/> Alcohol</label>
        </div>
      </div>

      <div class="sep"></div>
      <h3 style="margin:0 0 6px;">Condiciones cl√≠nicas especiales</h3>
      <div class="grid g-2">
        <div>
          <label class="row"><input id="condDysphagia" type="checkbox"/> Disfagia / administraci√≥n por SNG</label>
          <label class="row"><input id="condGIbleed" type="checkbox"/> Antecedente de hemorragia digestiva severa</label>
          <label class="row"><input id="condICHrisk" type="checkbox"/> Alto riesgo de hemorragia intracraneal</label>
          <label class="row"><input id="condValvular" type="checkbox"/> Pr√≥tesis valvular mec√°nica o EM reum√°tica significativa</label>
          <label class="row"><input id="condOncoGI" type="checkbox"/> Neoplasia GI/GU activa</label>
        </div>
        <div>
          <label class="row"><input id="condPolypharm" type="checkbox"/> Polimedicaci√≥n/intolerancia a interacciones</label>
          <label class="row"><input id="condCirrhosis" type="checkbox"/> Hepatopat√≠a avanzada (Child-Pugh B‚ÄìC)</label>
          <label class="row"><input id="condObesity" type="checkbox" title="Autorrelleno si peso &gt;120 kg (o IMC &gt;40, si disponible)"/> Obesidad m√≥rbida (IMC &gt;40 o &gt;120 kg)</label>
          <label class="row"><input id="condPoorINR" type="checkbox"/> Dificultad para monitorizar INR/visitas</label>
          <label class="row"><input id="condQD" type="checkbox"/> Preferencia por dosis √∫nica diaria</label>
          <label class="row"><input id="condPgp" type="checkbox"/> Inhibidor potente de P-gp (verapamilo/dronedarona/quinidina)</label>
        </div>
      </div>

      <div class="button">
        <button type="button" class="primary" id="btnCalc">Calcular</button>
        <button type="button" class="primary" id="btnReset">Borrar</button>
        <span aria-live="polite" role="status" class="muted" id="calcMsg"></span>
      </div>
    </div>

    <!-- Resultados -->
    <div class="card sticky-result result-anchor" id="resultCard">
      <h2 style="margin:0 0 8px;">Resultados</h2>
      <div class="grid g-3">
        <div>
          <div><b>CHA<sub>2</sub>DS<sub>2</sub>-VA</b>: <span class="pill ok" id="scoreVA">‚Äì</span>
            &nbsp;<span class="muted">(sin sexo)</span></div>
          <div><b>HAS-BLED</b>: <span class="pill ok" id="scoreHASBLED">‚Äì</span></div>
          <div class="muted">CHA<sub>2</sub>DS<sub>2</sub>-VASc cl√°sico: <span id="scoreVASc">‚Äì</span></div>
        </div>
        <div>
          <div><b>Riesgo anual de ictus (sin tto): <span class="pill okr"><span id="annualStroke">‚Äì</span>%</span></b></div>
          <div><b>Riesgo anual de sangrado(*): <span class="pill okr"><span id="annualBleed">‚Äì</span>%</span></b></div>
          <div class="muted"><sup>*</sup>En pacientes con FA y VKA</div>
        </div>
        <div>
          <div><b>Aclaramiento de creatinina:</b> <span id="crcl" class="doseTag">‚Äì</span> ml/min</div>
          <div class="muted">Conversi√≥n SCr: <span id="scrConv" class="doseTag">‚Äì</span> mg/dL</div>
        </div>
      </div>

      <div class="sep"></div>

      <h3 style="margin:0 0 6px;">Comparativa de estrategias</h3>
      <table id="comparative">
        <thead>
          <tr>
            <th>Estrategia</th><th class="right">RA</th><th class="right">RRR</th>
            <th class="right col-rra">RRA</th><th class="right">NNT</th>
            <th class="right">RS</th><th class="right col-rrs">RRS</th><th class="right">NNH</th>
            <th class="right">Adecuaci√≥n cl√≠nica</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td class="subtle" colspan="9"><b>Abreviaturas:</b> <b>RA</b>=riesgo anual de ictus; <b>RRR</b>=reducci√≥n relativa; <b>RRA</b>=reducci√≥n absoluta;
        <b>NNT</b>=n¬∫ necesario a tratar; <b>RS</b>=riesgo anual de sangrado mayor; <b>RRS</b>=riesgo relativo de sangrado vs VKA; <b>NNH</b>=n¬∫ necesario para da√±ar.</td></tr>
        <tr><td class="subtle2" colspan="9"><b>Nota:</b> coeficientes orientativos; adapta a tus fuentes.</td></tr>
</tfoot>
      </table>

      <!-- NUEVO: Disclaimer bajo la tabla (umbral renal + seguimiento) -->
      <div class="renal-disclaimer" id="renalDisclaimer">
        <div class="note">
          <b>Ajuste por funci√≥n renal (FA; EMA/ESC):</b>
          <ul class="list-min">
            <li><b>Apixab√°n</b>: 2,5 mg/12 h si <b>‚â•2</b> criterios (edad ‚â•80 a, peso ‚â§60 kg, SCr ‚â•1,5 mg/dL) <i>o</i> <b>ClCr 15‚Äì29</b> mL/min. Evitar si <b>ClCr &lt;15</b> o di√°lisis (EMA).</li>
            <li><b>Dabigatr√°n</b>: <b>110 mg/12 h</b> si <b>ClCr 30‚Äì50</b> mL/min (o riesgo hemorr√°gico alto); <b>contraindicado &lt;30</b>.</li>
            <li><b>Rivaroxab√°n</b>: <b>15 mg/24 h</b> si <b>ClCr 15‚Äì49</b> mL/min; <b>contraindicado &lt;15</b>.</li>
            <li><b>Edoxab√°n</b>: <b>30 mg/24 h</b> si <b>ClCr 15‚Äì50</b> mL/min o ‚â§60 kg o inhibidor potente P-gp; <b>evitar &lt;15</b>. <span class="muted">Menor eficacia si <b>ClCr &gt;95</b> (etiqueta FDA).</span></li>
          </ul>
          <div class="subtle"><b>Seguimiento de funci√≥n renal:</b> cada 6‚Äì12 meses si ClCr &gt;60; cada 3‚Äì6 meses si 30‚Äì60; cada 1‚Äì3 meses si &lt;30 o en ancianos/fr√°giles.</div>
        </div>
      </div>

      <div class="sep"></div>
      <h3 style="margin:0 0 6px;">Recomendaciones individualizadas</h3>
      <ul id="recList" class="rec-list list-min"></ul>

      <div class="sep"></div>
      <div id="doseSection">
        <h3 style="margin:0 0 6px;">Posolog√≠a sugerida seg√∫n datos introducidos</h3>
        <ul id="doseList" class="rec-list list-min"></ul>
      </div>

      <div class="btnbar">
        <button type="button" class="ghost" id="btnPrint" disabled>Imprimir informe</button>
        <button type="button" class="ghost" id="btnCopy" disabled>Copiar informe</button>
      </div>
    </div>

    <app-disclaimer
      data-target="#resultCard"
      data-position="after"
      data-when="visible"
      data-version="1.0"
      data-context="FA no valvular ‚Äî Anticoagulaci√≥n">
    </app-disclaimer>

    <!-- Toast -->
    <div id="toast" class="toast" role="alert" aria-live="assertive"></div>

    <script>
    /* ===== Utilidades ===== */
    const NDASH='‚Äî';
    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
    const fmt=(x,d=1)=>isFinite(x)?(+x).toFixed(d):NDASH;
    const oneIn=pct=>{const p=parseFloat(pct);if(!isFinite(p)||p<=0)return NDASH;return Math.round(100/p);};
    const scrollToResult=()=>{const el=document.getElementById('resultCard');if(el)el.scrollIntoView({behavior:'smooth',block:'start'});};
    let _toastTimer=null;
    function decodeEntities(str){const ta=document.createElement('textarea');ta.innerHTML=String(str);return ta.value;}
    function escAttr(s){return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
    function showToast(msg,type='error'){const t=document.getElementById('toast');t.textContent=decodeEntities(msg);t.classList.remove('warn','info');if(type==='warn')t.classList.add('warn');if(type==='info')t.classList.add('info');t.classList.add('show');clearTimeout(_toastTimer);_toastTimer=setTimeout(()=>t.classList.remove('show'),3500);}

    /* ===== Par√°metros ===== */
    let strokeRisksByVasc={0:0.2,1:0.6,2:2.2,3:3.2,4:4.8,5:7.2,6:9.7,7:11.2,8:10.8,9:12.2};
    let bleedRiskByHASBLED={0:1.1,1:1.9,2:3.4,3:5.8,4:8.9,5:12.5,6:15.0};
    let RR_Stroke={"No ACO":1.00,"VKA":0.36,"Apixab√°n":0.36*0.79,"Dabigatr√°n":0.36*0.66,"Edoxab√°n":0.36*0.87,"Rivaroxab√°n":0.36*0.79};
    let RR_Bleed_vs_VKA={"No ACO":0.30,"VKA":1.00,"Apixab√°n":0.69,"Dabigatr√°n":0.93,"Edoxab√°n":0.80,"Rivaroxab√°n":1.04};
    const STRATS=["No ACO","VKA","Apixab√°n","Dabigatr√°n","Edoxab√°n","Rivaroxab√°n"];

    /* ===== C√°lculos base ===== */
    function calcVasc(age,female,flags){let s=0;if(flags.cCongest)s+=1;if(flags.cHTN)s+=1;if(age>=75||flags.cAge75)s+=2;if(flags.cDiab)s+=1;if(flags.cStroke)s+=2;if(flags.cVasc)s+=1;if((age>=65&&age<=74)||flags.cAge65)s+=1;const classicVASc=s+(female?1:0);return{va:s,vasc:classicVASc};}
    function calcHASBLED(flags,age){let s=0;if(flags.hHTN)s+=1;if(flags.hRenal)s+=1;if(flags.hLiver)s+=1;if(flags.hStroke)s+=1;if(flags.hBleed)s+=1;if(flags.hLabileINR)s+=1;if(age>65||flags.hElder)s+=1;if(flags.hDrugs)s+=1;if(flags.hAlcohol)s+=1;return s;}
    function getStrokeRiskPct(vasc){const k=Math.max(0,Math.min(9,vasc|0));return strokeRisksByVasc[k]??0;}
    function getBleedRiskPct(hasbled){const k=Math.max(0,Math.min(6,hasbled|0));return bleedRiskByHASBLED[k]??bleedRiskByHASBLED[6];}
    function calcCrCl(age,sex,weightVal,wUnit,scrVal,scrUnit){
      if(!isFinite(age)||!sex||!isFinite(weightVal)||!isFinite(scrVal))return{crcl:NaN,scr_mgdl:NaN};
      const wtKg=(wUnit==='lb')?(weightVal/2.20462):weightVal;
      const scrMg=(scrUnit==='umol')?(scrVal/88.4):scrVal;
      const base=(140-age)*wtKg/(72*scrMg);
      const factor=(sex==='F')?0.85:1.0;
      return{crcl:base*factor,scr_mgdl:scrMg};
    }

    /* ===== Autorrelleno ===== */
    function autoCheckByInputs(){
      const age=clamp(parseFloat(document.getElementById('age').value)||0,0,150);
      const sex=document.getElementById('sex').value;
      const weightRaw=parseFloat(document.getElementById('weight').value);
      const weight=isFinite(weightRaw)?clamp(weightRaw,10,400):NaN;
      const wUnit=document.getElementById('weightUnit').value;
      const kg=isFinite(weight)?((wUnit==='lb')?(weight/2.20462):weight):NaN;
      const scrRaw=parseFloat(document.getElementById('scr').value);
      const scr=isFinite(scrRaw)?clamp(scrRaw,0.1,15):NaN;
      const scrUnit=document.getElementById('scrUnit').value;

      document.getElementById('cSc').checked=(sex==='F');
      document.getElementById('cAge75').checked=(age>=75);
      document.getElementById('cAge65').checked=(age>=65&&age<=74);
      document.getElementById('hElder').checked=(age>65);
      document.getElementById('condObesity').checked=(isFinite(kg)&&kg>120);

      const {crcl,scr_mgdl}=calcCrCl(age,sex,kg,'kg',scr,scrUnit);
      const renalByScr=(isFinite(scr_mgdl)&&scr_mgdl>=2.26);
      const renalByClCr=(isFinite(crcl)&&crcl<30);
      document.getElementById('hRenal').checked=(renalByScr||renalByClCr);
    }

    /* ===== Validaci√≥n ===== */
    function checkAndFixContradictions(controlId){
      const age=clamp(parseFloat(document.getElementById('age').value)||0,0,150);
      const sex=document.getElementById('sex').value;
      const weightRaw=parseFloat(document.getElementById('weight').value);
      const weight=isFinite(weightRaw)?clamp(weightRaw,10,400):NaN;
      const wUnit=document.getElementById('weightUnit').value;
      const kg=isFinite(weight)?((wUnit==='lb')?(weight/2.20462):weight):NaN;
      const scrRaw=parseFloat(document.getElementById('scr').value);
      const scr=isFinite(scrRaw)?clamp(scrRaw,0.1,15):NaN;
      const scrUnit=document.getElementById('scrUnit').value;
      const {crcl,scr_mgdl}=calcCrCl(age,sex,kg,'kg',scr,scrUnit);
      const el=id=>document.getElementById(id);

      if(controlId==='condObesity'&&el('condObesity').checked&&!(isFinite(kg)&&kg>120)){
        showToast('Obesidad m√≥rbida: criterio habitual IMC >= 40 o peso > 120 kg. Con el peso actual, mant√©n marcada la casilla solo si el IMC es >= 40.','warn');return true;}
      if(controlId==='cAge65'&&el('cAge65').checked&&!(age>=65&&age<=74)){el('cAge65').checked=false;showToast('Marca Edad 65‚Äì74 solo si la edad est√° entre 65 y 74 a√±os.');return false;}
      if(controlId==='cAge75'&&el('cAge75').checked&&!(age>=75)){el('cAge75').checked=false;showToast('Marca Edad >= 75 solo si la edad introducida es >= 75 a√±os.');return false;}
      if(controlId==='hElder'&&el('hElder').checked&&!(age>65)){el('hElder').checked=false;showToast('HAS-BLED: Edad > 65 requiere edad introducida > 65 a√±os.');return false;}
      if(controlId==='cSc'&&el('cSc').checked&&sex!=='F'){el('cSc').checked=false;showToast('Sexo femenino solo procede si el sexo seleccionado es Mujer.');return false;}
      if(controlId==='hRenal'&&el('hRenal').checked&&!((isFinite(scr_mgdl)&&scr_mgdl>=2.26)||(isFinite(crcl)&&crcl<30))){
        showToast('Revise disfunci√≥n renal: con los datos introducidos no se cumple HAS-BLED (SCr >= 2.26 mg/dL o ClCr < 30). Si trasplante/di√°lisis, mantenga marcado.','warn');return true;}
      return true;
    }
    ['condObesity','cAge65','cAge75','hElder','hRenal','cSc'].forEach(id=>document.getElementById(id).addEventListener('change',()=>checkAndFixContradictions(id)));

    /* ===== Reglas cl√≠nicas (incluye ri√±√≥n) ===== */
    function buildClinicalRules(context){
      const {crcl,age,special,weightKg}=context;
      const prefer={"VKA":new Set(),"Apixab√°n":new Set(),"Dabigatr√°n":new Set(),"Edoxab√°n":new Set(),"Rivaroxab√°n":new Set()};
      const avoid={"VKA":new Set(),"Apixab√°n":new Set(),"Dabigatr√°n":new Set(),"Edoxab√°n":new Set(),"Rivaroxab√°n":new Set()};
      const notes=[];

      // Disfagia / SNG
      if(special.dysphagia){
        avoid.Dabigatr√°n.add("Disfagia/SNG (no abrir c√°psula)");
        prefer.Apixab√°n.add("Compatible triturado/SNG");
        prefer.Rivaroxab√°n.add("Compatible triturado/SNG (>=15 mg con comida)");
        prefer.VKA.add("Se puede triturar/SNG");
        notes.push("Disfagia/SNG: evitar dabigatr√°n; apixab√°n, rivaroxab√°n o VKA son opciones.");
      }

      // Funci√≥n renal
      if(isFinite(crcl)){
        if(crcl<15){
          prefer.VKA.add("ERC terminal (<15 mL/min) o di√°lisis");
          avoid.Dabigatr√°n.add("ERC terminal");
          avoid.Rivaroxab√°n.add("ERC terminal");
          avoid.Edoxab√°n.add("ERC terminal");
          avoid.Apixab√°n.add("No recomendado por EMA en ERC terminal/di√°lisis");
          notes.push("ClCr <15 mL/min o di√°lisis: preferir VKA; evitar DOAC.");
        }else if(crcl>=15&&crcl<30){
          prefer.Apixab√°n.add("ERC 15‚Äì29 (baja excreci√≥n renal)");
          avoid.Dabigatr√°n.add("ERC 15‚Äì29 (contraindicado si <30)");
          notes.push("ClCr 15‚Äì29 mL/min: preferir apixab√°n; evitar dabigatr√°n; ajustar rivaroxab√°n/edoxab√°n.");
        }else if(crcl>95){
          avoid.Edoxab√°n.add("Menor eficacia si ClCr >95 mL/min (FDA, Savaysa)");
          notes.push("ClCr >95 mL/min: evitar edoxab√°n por menor eficacia relativa (FA no valvular).");
        }
      }

      // Otros condicionantes
      if(special.giBleed){prefer.Apixab√°n.add("Mejor perfil GI");avoid.Rivaroxab√°n.add("M√°s sangrado GI");avoid.Dabigatr√°n.add("M√°s sangrado GI (150 mg)");avoid.Edoxab√°n.add("M√°s sangrado GI");notes.push("Antecedente de HDA severa: preferir apixab√°n.");}
      if(special.ichRisk){prefer.Apixab√°n.add("Menor HIC vs VKA");prefer.Edoxab√°n.add("Menor HIC vs VKA");avoid.VKA.add("M√°s HIC vs DOAC");notes.push("Alto riesgo de HIC: priorizar DOAC (apixab√°n/edoxab√°n).");}
      if(special.valvular){prefer.VKA.add("Pr√≥tesis mec√°nica/EM reum√°tica (indicaci√≥n absoluta)");avoid.Apixab√°n.add("No indicado");avoid.Dabigatr√°n.add("No indicado");avoid.Edoxab√°n.add("No indicado");avoid.Rivaroxab√°n.add("No indicado");notes.push("Pr√≥tesis mec√°nica/EM reum√°tica significativa: VKA obligatorio.");}
      if(special.polypharm){prefer.Apixab√°n.add("Menos interacciones globales");prefer.Edoxab√°n.add("Menos interacciones globales");avoid.VKA.add("M√∫ltiples interacciones");notes.push("Polimedicaci√≥n: preferir apixab√°n/edoxab√°n.");}
      if(special.cirrhosis){prefer.VKA.add("Hepatopat√≠a avanzada");avoid.Apixab√°n.add("Evitar Child C");avoid.Dabigatr√°n.add("Evitar Child C");avoid.Edoxab√°n.add("Evitar Child C");avoid.Rivaroxab√°n.add("Evitar Child C");notes.push("Hepatopat√≠a avanzada: preferir VKA; evitar DOAC en Child C.");}
      const over120=isFinite(weightKg)&&weightKg>120;
      if(special.obesity||over120){prefer.VKA.add("Obesidad m√≥rbida");avoid.Dabigatr√°n.add("Evidencia limitada");avoid.Edoxab√°n.add("Evidencia limitada");notes.push("Obesidad m√≥rbida: preferir VKA; si DOAC, mejor apixab√°n/rivaroxab√°n.");}
      if(special.oncoGI){prefer.VKA.add("Alternativa en tumor GI/GU activo");avoid.Rivaroxab√°n.add("Mayor riesgo GI");avoid.Dabigatr√°n.add("Mayor riesgo GI");avoid.Edoxab√°n.add("Mayor riesgo GI");prefer.Apixab√°n.add("Perfil GI favorable");notes.push("Neoplasia GI/GU activa: preferible apixab√°n o VKA.");}
      if(age>=80){prefer.Apixab√°n.add("Mejor balance en ancianos");avoid.Dabigatr√°n.add("Evitar 150 mg en ancianos");notes.push("Anciano fr√°gil: apixab√°n suele ser la opci√≥n m√°s segura.");}
      if(special.poorINR){avoid.VKA.add("Dif√≠cil monitorizaci√≥n INR");prefer.Apixab√°n.add("Sin INR rutinario");prefer.Rivaroxab√°n.add("Sin INR rutinario");prefer.Edoxab√°n.add("Sin INR rutinario");prefer.Dabigatr√°n.add("Sin INR rutinario");notes.push("Si no se puede monitorizar INR: preferir DOAC.");}
      if(special.qd){prefer.Rivaroxab√°n.add("Posolog√≠a QD");prefer.Edoxab√°n.add("Posolog√≠a QD");notes.push("Preferencia por dosis √∫nica diaria: rivaroxab√°n o edoxab√°n.");}

      return {prefer,avoid,notes};
    }

    /* ===== Posolog√≠a (actualizada) ===== */
    function doseSuggestions(ctx,avoid){
      const {age,crcl,hasbled,weightKg,scr_mgdl,special}=ctx;
      const out=[]; const isAvoided=name=> (avoid?.[name]&&avoid[name].size>0);

      // Apixab√°n
      if(!isAvoided("Apixab√°n")){
        const apxCrit=((age>=80)?1:0)+((isFinite(weightKg)&&weightKg<=60)?1:0)+((isFinite(scr_mgdl)&&scr_mgdl>=1.5)?1:0);
        const apxReduce=(apxCrit>=2)||(isFinite(crcl)&&crcl>=15&&crcl<30);
        out.push({name:"Apixab√°n",dose:apxReduce?"2.5 mg cada 12 h":"5 mg cada 12 h",highlight:apxReduce,why:apxReduce?">=2 criterios (edad >=80, peso <=60 kg, SCr >=1.5 mg/dL) o ClCr 15‚Äì29 ml/min":"Criterios de reducci√≥n no presentes"});
      }

      // Rivaroxab√°n
      if(!isAvoided("Rivaroxab√°n")){
        const rivaReduce=(isFinite(crcl)&&crcl>=15&&crcl<50);
        out.push({name:"Rivaroxab√°n",dose:rivaReduce?"15 mg cada 24 h":"20 mg cada 24 h",highlight:rivaReduce,why:rivaReduce?"ClCr 15‚Äì49 ml/min":"ClCr >=50 ml/min"});
      }

      // Edoxab√°n
      if(!isAvoided("Edoxab√°n")){
        const edoReduce=((isFinite(crcl)&&crcl>=15&&crcl<=50)||(isFinite(weightKg)&&weightKg<=60)||special.pgp===true);
        out.push({name:"Edoxab√°n",dose:edoReduce?"30 mg cada 24 h":"60 mg cada 24 h",highlight:edoReduce,why:edoReduce?"ClCr 15‚Äì50 ml/min o peso <=60 kg o inhibidor potente P-gp":"Sin criterios de reducci√≥n"});
      }

      // Dabigatr√°n
      if(!isAvoided("Dabigatr√°n")){
        const dabAvoid=(isFinite(crcl)&&crcl<30);
        if(!dabAvoid){
          const dabReduce = (isFinite(crcl)&&crcl>=30&&crcl<=50) || (age>=80) || (age>=75&&age<80&&hasbled>=3) || special.pgp===true;
          out.push({name:"Dabigatr√°n",dose:dabReduce?"110 mg cada 12 h":"150 mg cada 12 h",highlight:dabReduce,why:(dabReduce?"ClCr 30‚Äì50 mL/min o edad ‚â•80 (o 75‚Äì80 con HAS-BLED alto) o inhibidor potente P-gp":"Sin criterios de reducci√≥n")});
        }
      }

      // VKA
      if(!isAvoided("VKA")){out.push({name:"VKA",dose:"Ajuste a INR entre 2 y 3",highlight:false,why:"Dosis individualizada seg√∫n INR"});}

      return out;
    }

    /* ===== Zebra por columnas ===== */
    function applyColumnStriping(){
      const rows=document.querySelectorAll('#comparative tbody tr');
      rows.forEach(row=>{
        const tds=Array.from(row.querySelectorAll('td'));
        tds.forEach(td=>td.classList.remove('_zebra'));
        const visible=tds.filter(td=>getComputedStyle(td).display!=='none');
        visible.forEach((td,idx)=>{if(((idx+1)%2)===0)td.classList.add('_zebra');});
      });
    }
    let _zebraTimer=null;window.addEventListener('resize',()=>{clearTimeout(_zebraTimer);_zebraTimer=setTimeout(applyColumnStriping,80);});
    function summarizeForStrategy(name,prefSet,avoidSet){
      const prefs=Array.from(prefSet[name]||[]),avoids=Array.from(avoidSet[name]||[]);
      if(avoids.length>0)return{label:'Evitar',cls:'tagAvoid',tooltip:avoids.join(' ¬∑ ')};
      if(prefs.length>0)return{label:'Preferible',cls:'tagPref',tooltip:prefs.join(' ¬∑ ')};
      return{label:'‚Äî',cls:'tagNeutral',tooltip:'Sin condicionantes espec√≠ficos'};
    }

    /* ===== Estado para informe ===== */
    let __lastReport=null;

    /* ===== Compute principal ===== */
    function compute(){
      autoCheckByInputs();

      const age=clamp(parseFloat(document.getElementById('age').value)||0,18,110);
      const sex=document.getElementById('sex').value;

      const weightRaw=parseFloat(document.getElementById('weight').value);
      const weight=isFinite(weightRaw)?clamp(weightRaw,10,400):NaN;
      const wUnit=document.getElementById('weightUnit').value;

      const scrRaw=parseFloat(document.getElementById('scr').value);
      const scr=isFinite(scrRaw)?clamp(scrRaw,0.1,15):NaN;
      const scrUnit=document.getElementById('scrUnit').value;

      const flags={cCongest:document.getElementById('cCongest')?.checked||false,cHTN:document.getElementById('cHTN')?.checked||false,cAge75:document.getElementById('cAge75')?.checked||false,cDiab:document.getElementById('cDiab')?.checked||false,cStroke:document.getElementById('cStroke')?.checked||false,cVasc:document.getElementById('cVasc')?.checked||false,cAge65:document.getElementById('cAge65')?.checked||false,cSc:document.getElementById('cSc')?.checked||false,hHTN:document.getElementById('hHTN')?.checked||false,hRenal:document.getElementById('hRenal')?.checked||false,hLiver:document.getElementById('hLiver')?.checked||false,hStroke:document.getElementById('hStroke')?.checked||false,hBleed:document.getElementById('hBleed')?.checked||false,hLabileINR:document.getElementById('hLabileINR')?.checked||false,hElder:document.getElementById('hElder')?.checked||false,hDrugs:document.getElementById('hDrugs')?.checked||false,hAlcohol:document.getElementById('hAlcohol')?.checked||false};

      const special={dysphagia:document.getElementById('condDysphagia')?.checked||false,giBleed:document.getElementById('condGIbleed')?.checked||false,ichRisk:document.getElementById('condICHrisk')?.checked||false,valvular:document.getElementById('condValvular')?.checked||false,oncoGI:document.getElementById('condOncoGI')?.checked||false,polypharm:document.getElementById('condPolypharm')?.checked||false,cirrhosis:document.getElementById('condCirrhosis')?.checked||false,obesity:document.getElementById('condObesity')?.checked||false,poorINR:document.getElementById('condPoorINR')?.checked||false,qd:document.getElementById('condQD')?.checked||false,pgp:document.getElementById('condPgp')?.checked||false};

      const female=(sex==='F');
      const vasc=calcVasc(age||0,female,flags);
      const hasbled=calcHASBLED(flags,age||0);

      const strokeBase=getStrokeRiskPct(vasc.vasc);
      const bleedBase=getBleedRiskPct(hasbled);

      const {crcl,scr_mgdl}=calcCrCl(age,sex,isFinite(weight)?weight:NaN,wUnit,scr,scrUnit);
      const weightKg=isFinite(weight)?((wUnit==='lb')?(weight/2.20462):weight):NaN;

      // Cabecera
      document.getElementById('scoreVA').textContent=vasc.va;
      document.getElementById('scoreVASc').textContent=vasc.vasc;
      document.getElementById('annualStroke').textContent=fmt(strokeBase,1);
      document.getElementById('scoreHASBLED').textContent=hasbled;
      document.getElementById('annualBleed').textContent=fmt(bleedBase,1);
      document.getElementById('crcl').textContent=isFinite(crcl)?fmt(crcl,0):NDASH;
      document.getElementById('scrConv').textContent=isFinite(scr_mgdl)?fmt(scr_mgdl,2):NDASH;

      // Regla de no OAC (salvo valvular)
      const noOAC_byScore=(!female && vasc.vasc===0) || (female && vasc.va===0 && vasc.vasc===1);
      const noOAC=noOAC_byScore && !special.valvular;

      // Reglas cl√≠nicas
      const {prefer,avoid,notes}=buildClinicalRules({crcl,age,special,weightKg});

      // Tabla comparativa
      const TOL_REL=0.03,TOL_ABS=0.005;
      function withinTolerance(score,best,tolRel=TOL_REL,tolAbs=TOL_ABS){if(!isFinite(score)||!isFinite(best))return false;const relOk=best>0?(best-score)<=best*tolRel:false;const absOk=Math.abs(best-score)<=tolAbs;return relOk||absOk;}
      const tbody=document.querySelector('#comparative tbody');tbody.innerHTML='';
      const rows=[];let bestScore=-Infinity;
      STRATS.forEach(name=>{
        const rrStroke=RR_Stroke[name], rrBleed_vsVKA=RR_Bleed_vs_VKA[name];
        const riskStroke=strokeBase*rrStroke, rrr=(1-rrStroke)*100, arr=strokeBase-riskStroke;
        const bleedPct=(name==='VKA')?bleedBase:(bleedBase*rrBleed_vsVKA);
        const score=(arr>0&&bleedPct>0)?(arr/bleedPct):-Infinity;
        const adequacy=summarizeForStrategy(name,prefer,avoid);
        const tip=escAttr(decodeEntities(adequacy.tooltip||''));
        const tr=document.createElement('tr');
        tr.innerHTML=`<td><b>${name}</b></td>
          <td class="right">${fmt(riskStroke,1)}</td>
          <td class="right">${fmt(rrr,0)}</td>
          <td class="right col-rra">${fmt(arr,1)}</td>
          <td class="right">${isFinite(arr)&&arr>0?oneIn(arr):NDASH}</td>
          <td class="right">${fmt(bleedPct,1)}</td>
          <td class="right col-rrs">${fmt(rrBleed_vsVKA,2)}</td>
          <td class="right">${isFinite(bleedPct)&&bleedPct>0?oneIn(bleedPct):NDASH}</td>
          <td class="right"><span class="pill ${adequacy.cls}" title="${tip}">${adequacy.label}</span></td>`;
        tbody.appendChild(tr); rows.push({tr,score}); if(score>bestScore)bestScore=score;
      });
      rows.forEach(({tr,score})=>{if(withinTolerance(score,bestScore))tr.classList.add('best');});
      applyColumnStriping();

      // Recomendaciones y posolog√≠a
      const recList=document.getElementById('recList');
      const doseSection=document.getElementById('doseSection');
      recList.innerHTML='';
      let preferredGlobal=[], avoidedGlobal=[], dosesForReport=[];
      if(noOAC){
        const li=document.createElement('li');
        li.innerHTML='<span class="noOac">NO SE RECOMIENDA TRATAMIENTO ANTICOAGULANTE</span>';
        recList.appendChild(li);
        doseSection.style.display='none';
      }else{
        notes.forEach(t=>{const li=document.createElement('li');li.textContent=decodeEntities(t);recList.appendChild(li);});
        ["VKA","Apixab√°n","Dabigatr√°n","Edoxab√°n","Rivaroxab√°n"].forEach(n=>{
          if((avoid[n]||new Set()).size>0)avoidedGlobal.push(n);
          else if((prefer[n]||new Set()).size>0)preferredGlobal.push(n);
        });
        if(preferredGlobal.length){const li=document.createElement('li');li.innerHTML="<b>Estrategias preferibles:</b> "+preferredGlobal.join(", ");recList.appendChild(li);}
        if(avoidedGlobal.length){const li=document.createElement('li');li.innerHTML="<b>Estrategias a evitar:</b> "+avoidedGlobal.join(", ");recList.appendChild(li);}
        doseSection.style.display='';
        const doseList=document.getElementById('doseList');doseList.innerHTML='';
        dosesForReport=doseSuggestions({age,crcl,hasbled,weightKg,scr_mgdl,special},avoid);
        if(dosesForReport.length===0){
          const li=document.createElement('li');
          li.innerHTML='<span class="muted">No se muestran posolog√≠as porque todas las opciones disponibles est√°n marcadas como ‚ÄúEvitar‚Äù.</span>';
          doseList.appendChild(li);
        }else{
          dosesForReport.forEach(d=>{const li=document.createElement('li');const tag=d.highlight?`<span class="doseTag">Dosis reducida</span>`:'';li.innerHTML=`<b>${d.name}:</b> ${d.dose} ${tag} <span class="muted">‚Äî ${d.why}</span>`;doseList.appendChild(li);});
        }
      }

      // Guardar estado
      __lastReport={
        ts:new Date().toISOString(),
        inputs:{age,sex,weight:isFinite(weight)?weight:null,weightUnit:wUnit,scr:isFinite(scr)?scr:null,scrUnit,weightKg:isFinite(weightKg)?weightKg:null},
        renal:{crcl:isFinite(crcl)?+crcl.toFixed(0):null,scr_mgdl:isFinite(scr_mgdl)?+scr_mgdl.toFixed(2):null},
        scores:{va:vasc.va,vasc:vasc.vasc,hasbled},
        risks:{strokeBase:+strokeBase,bleedBase:+bleedBase},
        noOAC,
        preferredGlobal, avoidedGlobal,
        notes:[...notes],
        doses:dosesForReport
      };
      document.getElementById('btnPrint').disabled=false;
      document.getElementById('btnCopy').disabled=false;
    }

    /* ===== Informe imprimible ===== */
    function printReport(){
      if(!__lastReport){showToast('Primero calcule los resultados para generar el informe.','warn');return;}
      const r=__lastReport;
      const fmtOrDash=v=> (v===null||v===undefined||!isFinite(v))?NDASH:v;
      const sexTxt = r.inputs.sex==='M'?'Var√≥n':(r.inputs.sex==='F'?'Mujer':NDASH);
      const fecha = (new Date(r.ts)).toLocaleString('es-ES');

      const dosesHTML = (r.noOAC||!r.doses||r.doses.length===0) ? ''
        : ('<h3>Posolog√≠a sugerida</h3><ul>' + r.doses.map(d=>`<li><b>${d.name}:</b> ${d.dose}${d.highlight?' <span style="background:#fff4ce;border:1px solid #ffe08a;border-radius:999px;padding:2px 8px;font-weight:700">Dosis reducida</span>':''} ‚Äî <span style="color:#666">${d.why}</span></li>`).join('') + '</ul>');

      const renalHTML = `
        <div style="margin-top:10px;padding:8px 10px;border-left:4px solid #1976d2;background:#f8fbff;border:1px solid #e3eef9;border-radius:10px;">
          <div style="font-size:.92rem;color:#0b4576;"><b>Ajuste por funci√≥n renal (FA; EMA/ESC)</b></div>
          <ul style="margin:6px 0 0 18px;font-size:.9rem;color:#234;">
            <li><b>Apixab√°n</b>: 2,5 mg/12 h si ‚â•2 criterios o ClCr 15‚Äì29; evitar &lt;15 o di√°lisis (EMA).</li>
            <li><b>Dabigatr√°n</b>: 110 mg/12 h si ClCr 30‚Äì50; <b>contraindicado &lt;30</b>.</li>
            <li><b>Rivaroxab√°n</b>: 15 mg/24 h si ClCr 15‚Äì49; <b>contraindicado &lt;15</b>.</li>
            <li><b>Edoxab√°n</b>: 30 mg/24 h si ClCr 15‚Äì50 (o ‚â§60 kg o P-gp); evitar &lt;15. <i>Evitar &gt;95 por menor eficacia (FDA).</i></li>
          </ul>
          <div style="color:#456;font-size:.88rem;margin-top:4px;"><b>Seguimiento renal:</b> 6‚Äì12 m si ClCr &gt;60; 3‚Äì6 m si 30‚Äì60; 1‚Äì3 m si &lt;30 o ancianos/fr√°giles.</div>
        </div>`;

      const recHTML = r.noOAC
        ? '<p style="color:#b71c1c;font-weight:800">NO SE RECOMIENDA TRATAMIENTO ANTICOAGULANTE</p>'
        : `
          ${r.notes.length?('<h3>Recomendaciones individualizadas</h3><ul>'+r.notes.map(n=>`<li>${decodeEntities(n)}</li>`).join('')+'</ul>'):''}
          ${r.preferredGlobal.length?('<p><b>Estrategias preferibles:</b> '+r.preferredGlobal.join(', ')+'</p>'):''}
          ${r.avoidedGlobal.length?('<p><b>Estrategias a evitar:</b> '+r.avoidedGlobal.join(', ')+'</p>'):''}
          ${renalHTML}
        `;

      const html = `
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Informe ‚Äî Selecci√≥n de anticoagulante oral</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:24px;color:#111}
  h1{font-size:1.2rem;margin:0 0 6px}
  h2{font-size:1.05rem;margin:18px 0 6px}
  h3{font-size:1rem;margin:14px 0 4px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .card{padding:12px 14px;border:1px solid #e3eef9;border-radius:10px;background:#f8fbff;margin-top:8px}
  .muted{color:#666}
  table{border-collapse:collapse}
  td{padding:3px 8px}
  .chip{display:inline-block;background:#eef6ff;border:1px solid #cfe3f6;border-radius:999px;padding:2px 8px;font-weight:700}
  .foot{margin-top:18px;color:#666;font-size:.9rem}
  @media print {.no-print{display:none}}
</style>
</head>
<body>
  <h1>Informe ‚Äî Selecci√≥n de anticoagulante oral</h1>
  <div class="muted">Generado: ${fecha}</div>

  <div class="card">
    <h2>Datos y puntuaciones</h2>
    <div class="row">
      <div>
        <table>
          <tr><td><b>Edad</b></td><td>${fmtOrDash(r.inputs.age)} a√±os</td></tr>
          <tr><td><b>Sexo</b></td><td>${sexTxt}</td></tr>
          <tr><td><b>Peso</b></td><td>${r.inputs.weight!==null? r.inputs.weight+' '+r.inputs.weightUnit : NDASH}</td></tr>
          <tr><td><b>SCr</b></td><td>${r.inputs.scr!==null? r.inputs.scr+' '+r.inputs.scrUnit : NDASH}</td></tr>
          <tr><td><b>SCr (mg/dL)</b></td><td>${fmtOrDash(r.renal.scr_mgdl)}</td></tr>
          <tr><td><b>ClCr</b></td><td>${fmtOrDash(r.renal.crcl)} ml/min</td></tr>
        </table>
      </div>
      <div>
        <table>
          <tr><td><b>CHA<sub>2</sub>DS<sub>2</sub>-VA</b></td><td class="chip">${r.scores.va}</td></tr>
          <tr><td><b>CHA<sub>2</sub>DS<sub>2</sub>-VASc</b></td><td class="chip">${r.scores.vasc}</td></tr>
          <tr><td><b>HAS-BLED</b></td><td class="chip">${r.scores.hasbled}</td></tr>
          <tr><td><b>Riesgo ictus sin tto</b></td><td>${r.risks.strokeBase} %/a√±o</td></tr>
          <tr><td><b>Riesgo sangrado base</b></td><td>${r.risks.bleedBase} %/a√±o</td></tr>
        </table>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Conclusi√≥n</h2>
    ${recHTML}
    ${dosesHTML}
    <p class="foot">Documento generado autom√°ticamente. Interpretar en el contexto cl√≠nico del paciente y de las gu√≠as locales.</p>
  </div>

  <button class="no-print" onclick="window.print()">Imprimir</button>
  <script>window.addEventListener('load',()=>{setTimeout(()=>{window.print();},150);});<\/script>
</body>
</html>`;
      const w = window.open('', '_blank');
      if(!w){ showToast('El navegador ha bloqueado la ventana de impresi√≥n. Permita "pop-ups" para esta p√°gina.','warn'); return; }
      w.document.open(); w.document.write(html); w.document.close();
    }

   /* ===== Informe en TEXTO (limpio para Blogger) ===== */
    function buildPlainReport(r){
      // Normaliza caracteres problem√°ticos a ASCII seguro manteniendo tildes/√±
      const clean = (s)=> String(s)
        .replace(/[‚Ä¢]/g,'*')
        .replace(/[‚Äî‚Äì]/g,'-')
        .replace(/‚â•/g,'>=').replace(/‚â§/g,'<=');
      const sexTxt = r.inputs.sex==='M'?'Var√≥n':(r.inputs.sex==='F'?'Mujer':'-');
      const fecha = (new Date(r.ts)).toLocaleString('es-ES');
      const bullets = [];
      bullets.push('INFORME - Selecci√≥n de anticoagulante oral');
      bullets.push('Generado: ' + fecha);
      bullets.push('');
      bullets.push('DATOS Y PUNTUACIONES');
      bullets.push('* Edad: ' + (r.inputs.age ?? '-') + ' a√±os');
      bullets.push('* Sexo: ' + sexTxt);
      bullets.push('* Peso: ' + (r.inputs.weight!=null ? (r.inputs.weight+' '+r.inputs.weightUnit) : '-'));
      bullets.push('* SCr: ' + (r.inputs.scr!=null ? (r.inputs.scr+' '+r.inputs.scrUnit) : '-') +
                   '  |  SCr (mg/dL): ' + (r.renal.scr_mgdl ?? '-') +
                   '  |  ClCr: ' + (r.renal.crcl ?? '-') + ' ml/min');
      bullets.push('* CHA2DS2-VA: ' + r.scores.va + '  |  CHA2DS2-VASc: ' + r.scores.vasc + '  |  HAS-BLED: ' + r.scores.hasbled);
      bullets.push('* Riesgo ictus sin tto: ' + r.risks.strokeBase + '%/a√±o  |  Riesgo sangrado base: ' + r.risks.bleedBase + '%/a√±o');
      bullets.push('');
      bullets.push('CONCLUSI√ìN');
      if(r.noOAC){
        bullets.push('NO SE RECOMIENDA TRATAMIENTO ANTICOAGULANTE');
      }else{
        if(r.notes.length){
          bullets.push('Recomendaciones individualizadas:');
          r.notes.forEach(n=>bullets.push('* ' + clean(decodeEntities(n))));
        }
        if(r.preferredGlobal.length) bullets.push('Estrategias preferibles: ' + r.preferredGlobal.join(', '));
        if(r.avoidedGlobal.length) bullets.push('Estrategias a evitar: ' + r.avoidedGlobal.join(', '));
        if(r.doses && r.doses.length){
          bullets.push('');
          bullets.push('Posolog√≠a sugerida:');
          r.doses.forEach(d=>{
            bullets.push('* ' + d.name + ': ' + d.dose + (d.highlight?' [Dosis reducida]':'') + ' - ' + clean(d.why));
          });
        }
      }
      return bullets.join('\n');
    }

    async function copyReport(){
      if(!__lastReport){showToast('Primero calcule los resultados para generar el informe.','warn');return;}
      const text = buildPlainReport(__lastReport);
      try{ await navigator.clipboard.writeText(text); }
      catch(e){
        const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.left='-1000px';
        document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); } finally{ document.body.removeChild(ta); }
      }
      const btn=document.getElementById('btnCopy'); const old=btn.textContent; btn.textContent='Copiado'; setTimeout(()=>{btn.textContent=old;},1600);
    }

    /* ===== Eventos ===== */
    ['age','sex','weight','weightUnit','scr','scrUnit'].forEach(id=>{
      const el=document.getElementById(id);
      el.addEventListener('input',autoCheckByInputs);
      el.addEventListener('change',autoCheckByInputs);
    });
    ['condObesity','cAge65','cAge75','hElder','hRenal','cSc'].forEach(id=>{
      const el=document.getElementById(id);
      el.addEventListener('change',()=>checkAndFixContradictions(id));
    });
    document.getElementById('btnCalc').addEventListener('click',e=>{
      e.preventDefault(); compute(); document.getElementById('calcMsg'); scrollToResult();
    });
    document.getElementById('btnReset').addEventListener('click',e=>{
      e.preventDefault();
      ['age','sex','weight','weightUnit','scr','scrUnit'].forEach(id=>{const el=document.getElementById(id); if(el.tagName==='SELECT'){el.selectedIndex=0;} else el.value='';});
      document.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false);
      ['scoreVA','scoreVASc','annualStroke','scoreHASBLED','annualBleed','crcl','scrConv'].forEach(id=>{document.getElementById(id).textContent=NDASH;});
      document.querySelector('#comparative tbody').innerHTML='';
      document.getElementById('recList').innerHTML='';
      document.getElementById('doseList').innerHTML='';
      document.getElementById('doseSection').style.display='';
      document.getElementById('calcMsg');
      document.getElementById('btnPrint').disabled=true;
      document.getElementById('btnCopy').disabled=true;
      



      __lastReport=null;
      window.scrollTo({top:0,behavior:'smooth'}); applyColumnStriping();
    });
    document.getElementById('btnPrint').addEventListener('click', (e)=>{ e.preventDefault(); printReport(); });
    document.getElementById('btnCopy').addEventListener('click', (e)=>{ e.preventDefault(); copyReport(); });

    window.addEventListener('DOMContentLoaded', autoCheckByInputs);
    </script>

    <!-- Referencias / Bibliograf√≠a -->   
 <div class="card" id="referencias">
   <div class="note" id="refNote">
      <h2 id="refToggle" style="margin:0 0 8px;font-size:1em;cursor:pointer;">Referencias <span id="refArrow" style="font-size:1em;">‚ñº</span></h2>
      <div id="refContent" style="display:none;">
<div>
<ol>
  <li>
    Friberg L, Rosenqvist M, Lip GYH. Evaluation of risk stratification schemes for ischaemic stroke and bleeding in 182,678 patients with atrial fibrillation.
    <i>Eur Heart J.</i> 2012;33(12):1500‚Äì1510.
    <a href="https://doi.org/10.1093/eurheartj/ehr488" rel="noopener" target="_blank">doi:10.1093/eurheartj/ehr488</a>
  </li>
  <li>
    Olesen JB, et al. Validation of risk stratification schemes for predicting stroke and thromboembolism in atrial fibrillation.
    <i>BMJ.</i> 2011;342:d124.
    <a href="https://www.bmj.com/content/342/bmj.d124" rel="noopener" target="_blank">BMJ 2011;342:d124</a>
  </li>
  <li>
    Pisters R, Lane DA, Nieuwlaat R, de Vos CB, Crijns HJGM, Lip GYH. A novel user-friendly score (HAS-BLED) to assess one-year risk of major bleeding in atrial fibrillation.
    <i>Chest.</i> 2010;138(5):1093‚Äì1100.
    <a href="https://doi.org/10.1378/chest.10-0134" rel="noopener" target="_blank">doi:10.1378/chest.10-0134</a>
  </li>
  <li>
    Lip GYH, Frison L, Halperin JL, Lane DA. Comparative validation of the HAS-BLED score in anticoagulated patients with AF.
    <i>J Am Coll Cardiol.</i> 2011;57(2):173‚Äì180.
    <a href="https://doi.org/10.1016/j.jacc.2010.09.024" rel="noopener" target="_blank">doi:10.1016/j.jacc.2010.09.024</a>
  </li>
  <li>
    Cockcroft DW, Gault MH. Prediction of creatinine clearance from serum creatinine.
    <i>Nephron.</i> 1976;16(1):31‚Äì41.
    <a href="https://pubmed.ncbi.nlm.nih.gov/1244564/" rel="noopener" target="_blank">PMID:1244564</a>
  </li>
  <li>
    Granger CB, et al. Apixaban versus warfarin in patients with AF (ARISTOTLE).
    <i>N Engl J Med.</i> 2011;365:981‚Äì992.
    <a href="https://www.nejm.org/doi/full/10.1056/NEJMoa1107039" rel="noopener" target="_blank">NEJM 2011</a>
  </li>
  <li>
    Connolly SJ, et al. Dabigatran versus warfarin in AF (RE-LY).
    <i>N Engl J Med.</i> 2009;361:1139‚Äì1151.
    <a href="https://www.nejm.org/doi/full/10.1056/NEJMoa0905561" rel="noopener" target="_blank">NEJM 2009</a>
  </li>
  <li>
    Patel MR, et al. Rivaroxaban versus warfarin in AF (ROCKET-AF).
    <i>N Engl J Med.</i> 2011;365:883‚Äì891.
    <a href="https://www.nejm.org/doi/full/10.1056/NEJMoa1009638" rel="noopener" target="_blank">NEJM 2011</a>
  </li>
  <li>
    Giugliano RP, et al. Edoxaban versus warfarin in AF (ENGAGE AF‚ÄìTIMI 48).
    <i>N Engl J Med.</i> 2013;369:2093‚Äì2104.
    <a href="https://www.nejm.org/doi/full/10.1056/NEJMoa1310907" rel="noopener" target="_blank">NEJM 2013</a>
  </li>
  <li>
    Hart RG, Pearce LA, Aguilar MI. Meta-analysis: antithrombotic therapy to prevent stroke in AF.
    <i>Ann Intern Med.</i> 2007;146:857‚Äì867.
    <a href="https://pubmed.ncbi.nlm.nih.gov/17577005/" rel="noopener" target="_blank">PMID:17577005</a>
  </li>
  <li>
    Aguilar MI, Hart R, Pearce LA. Antithrombotic therapy for AF (Cochrane Review).
    <i>Cochrane Database Syst Rev.</i> 2005;CD001927.
    <a href="https://doi.org/10.1002/14651858.CD001927.pub2" rel="noopener" target="_blank">doi:10.1002/14651858.CD001927.pub2</a>
  </li>
  <li>
    Van Gelder IC, et al. 2024 ESC Guidelines for the management of atrial fibrillation (developed with EACTS).
    <i>Eur Heart J.</i> 2024;45(36):3314‚Äì? 
    <a href="https://academic.oup.com/eurheartj/article/45/36/3314/7738779" rel="noopener" target="_blank">Art√≠culo OUP</a> | 
    <a href="https://www.escardio.org/Guidelines/Clinical-Practice-Guidelines/Atrial-Fibrillation" rel="noopener" target="_blank">P√°gina ESC</a>
  </li>
  <li>
    Joglar JA, et al. 2023 ACC/AHA/ACCP/HRS Guideline for the Diagnosis and Management of Atrial Fibrillation.
    <i>Circulation.</i> 2023;148:eXXX‚ÄìeXXX.
    <a href="https://doi.org/10.1161/CIR.0000000000001193" rel="noopener" target="_blank">doi:10.1161/CIR.0000000000001193</a>
  </li>
  <li>
    Steffel J, et al. 2021 European Heart Rhythm Association Practical Guide on the use of NOACs in AF.
    <i>Europace.</i> 2021;23(10):1612‚Äì1676.
    <a href="https://doi.org/10.1093/europace/euab065" rel="noopener" target="_blank">doi:10.1093/europace/euab065</a>
  </li>
  <li>
    SmPC EMA ‚Äì Apixab√°n (Eliquis). Criterios 2/3 para 2,5 mg c/12 h; opciones triturado/SNG.
    <a href="https://www.ema.europa.eu/en/documents/product-information/eliquis-epar-product-information_en.pdf" rel="noopener" target="_blank">EMA ‚Äì Eliquis</a>
  </li>
  <li>
    SmPC EMA ‚Äì Rivaroxab√°n (Xarelto). Triturado/SNG; 15‚Äì20 mg con comida.
    <a href="https://www.ema.europa.eu/en/documents/product-information/xarelto-epar-product-information_en.pdf" rel="noopener" target="_blank">EMA ‚Äì Xarelto</a>
  </li>
  <li>
    SmPC EMA ‚Äì Edoxab√°n (Lixiana). Reducci√≥n a 30 mg con inhibidores potentes de P-gp o ‚â§60 kg; opciones triturado/SNG.
    <a href="https://www.ema.europa.eu/en/documents/product-information/lixiana-epar-product-information_en.pdf" rel="noopener" target="_blank">EMA ‚Äì Lixiana</a>
  </li>
  <li>
    SmPC EMA ‚Äì Dabigatr√°n (Pradaxa). No abrir c√°psulas; precauciones con inhibidores de P-gp; contraindicado si ClCr &lt;30 ml/min.
    <a href="https://www.ema.europa.eu/en/documents/product-information/pradaxa-epar-product-information_en.pdf" rel="noopener" target="_blank">EMA ‚Äì Pradaxa</a>
  </li>
  <li>
    FDA ‚Äì Savaysa (edoxab√°n). <i>Boxed warning</i>: menor eficacia si ClCr &gt;95 mL/min en FA no valvular.
    <a href="https://www.accessdata.fda.gov/drugsatfda_docs/label/2015/206316lbl.pdf" rel="noopener" target="_blank">FDA label</a>
  </li>
  <li>
    Radadiya D, et al. Major gastrointestinal bleeding risk with DOACs: Does type and dose matter? Network meta-analysis.
    <i>Eur J Gastroenterol Hepatol.</i> 2021;33(1S Suppl 1):e50‚Äìe58.
    <a href="https://doi.org/10.1097/MEG.0000000000002035" rel="noopener" target="_blank">doi:10.1097/MEG.0000000000002035</a>
  </li>
  <li>
    Mamas MA, et al. Meta-Analysis Comparing Apixaban Versus Rivaroxaban in Patients With AF.
    <i>Am J Cardiol.</i> 2022;170:33‚Äì43.
    <a href="https://www.ajconline.org/article/S0002-9149(21)01148-6/fulltext" rel="noopener" target="_blank">Texto completo</a>
  </li>
  <li>
    Ruff CT, et al. Comparison of the efficacy and safety of new oral anticoagulants with warfarin in AF: meta-analysis of RCTs.
    <i>Lancet.</i> 2014;383(9921):955‚Äì962.
    <a href="https://doi.org/10.1016/S0140-6736(13)62343-0" rel="noopener" target="_blank">doi:10.1016/S0140-6736(13)62343-0</a>
  </li>
  <li>
    Song Y, et al. Relative Bioavailability of Apixaban Solution or Crushed Tablet Administered by Mouth or via NGT.
    <i>Clin Ther.</i> 2015;37(8):1703‚Äì1712.
    <a href="https://doi.org/10.1016/j.clinthera.2015.05.497" rel="noopener" target="_blank">doi:10.1016/j.clinthera.2015.05.497</a>
  </li>
  <li>
    Duchin K, et al. PK of edoxaban 60-mg tablet crushed y administrado por SNG o en pur√© de manzana (estudio cruzado).
    <i>Clin Pharmacokinet.</i> 2018;57:221‚Äì228.
    <a href="https://pubmed.ncbi.nlm.nih.gov/28512699/" rel="noopener" target="_blank">PMID:28512699</a> |
    <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC5784001/" rel="noopener" target="_blank">PMC</a>
  </li>
  <li>
    Byon W, et al. Apixaban: Clinical Pharmacokinetic and Pharmacodynamic Overview (incluye datos de trituraci√≥n/applesauce).
    <i>Clin Pharmacokinet.</i> 2019;58:1265‚Äì1279.
    <a href="https://link.springer.com/article/10.1007/s40262-019-00775-z" rel="noopener" target="_blank">Resumen</a>
  </li>
  <li>
    Martin K, et al. Use of DOACs in patients with obesity: Updated communication from the ISTH SSC (resumen de 2021).
    <i>J Thromb Haemost.</i> 2021;19:1874‚Äì1882.
    <a href="https://www.jthjournal.org/article/S1538-7836(22)01848-7/fulltext" rel="noopener" target="_blank">Texto</a>
  </li>
</ol> 
     </div></div>
</div></div></div>

    <script>
      const refToggle=document.getElementById('refToggle');
      const refContent=document.getElementById('refContent');
      const refArrow=document.getElementById('refArrow');
      refToggle.addEventListener('click',()=>{const isOpen=refContent.classList.toggle('show');refArrow.textContent=isOpen?'‚ñ≤':'‚ñº';});
    </script>

    <!-- Componente universal de advertencia contextual -->
    <script>
    (()=>{
      class AppDisclaimer extends HTMLElement{
        static get observedAttributes(){ return ["data-version","data-context","data-target","data-position","data-when","data-require"]; }
        constructor(){ super(); this._shadow=this.attachShadow({mode:"open"}); this._render(); }
        connectedCallback(){ this._ensureMounted(); this._setupObservers(); }
        attributeChangedCallback(){ this._render(); this._ensureMounted(); }
        _render(){
          this._shadow.innerHTML=`
        <style>
          :host{display:block}
          .box{font-family: Verdana, Geneva, Tahoma, sans-serif;color: var(--ink,#0f172a);background:#fff5f5;border:1px solid #fbd5d5;border-left:4px solid var(--bad,#b71c1c);border-radius:12px;padding:12px 14px;margin:12px 0 0 0;line-height:1.45}
          .box strong{ color: var(--bad,#b71c1c); }
          .hidden{ display:none!important; }
        </style>
        <aside class="box hidden" role="note" aria-label="Advertencia de uso">
          <strong>Advertencia.</strong> Esta herramienta es un <b>apoyo</b> a la decisi√≥n cl√≠nica;
          no sustituye el juicio profesional, la valoraci√≥n individual del paciente ni los
          <b>protocolos/gu√≠as locales actualizados</b>. Verifique siempre indicaciones,
          contraindicaciones, interacciones, posolog√≠a y disponibilidad seg√∫n su centro.
          Ante discrepancias, <b>prevalecen los protocolos vigentes</b> y el criterio del equipo responsable.
        </aside>`;
        }
        _getTarget(){
          const explicit=this.getAttribute("data-target");
          if(explicit){ try{const el=document.querySelector(explicit); if(el) return el;}catch(_){ }
          }
          const candidates=["#resultCard",".resultado","#resultado",".result","#result",".recomendacion",".recommendation",".output","#output",".rope-result",".calc-result",".box-result",".card-result"];
          for(const sel of candidates){ const el=document.querySelector(sel); if(el) return el; }
          return null;
        }
        _ensureMounted(){
          const tgt=this._getTarget();
          if(tgt){ this._mountTo(tgt); return; }
          if(this._waitMO) return;
          this._waitMO=new MutationObserver(()=>{ const t=this._getTarget(); if(t){ this._mountTo(t); this._waitMO.disconnect(); this._waitMO=null; }});
          this._waitMO.observe(document.body,{childList:true,subtree:true});
        }
        _mountTo(tgt){
          if(this._mountedTo===tgt) return; this._mountedTo=tgt;
          const pos=(this.getAttribute("data-position")||"after").toLowerCase();
          if(pos==="before"){ tgt.insertAdjacentElement("beforebegin",this); }
          else if(pos==="inside-start"){ tgt.insertAdjacentElement("afterbegin",this); }
          else if(pos==="inside-end"){ tgt.insertAdjacentElement("beforeend",this); }
          else{ tgt.insertAdjacentElement("afterend",this); }
        }
        _setupObservers(){
          const tgt=this._getTarget(); if(!tgt) return;
          this._mo && this._mo.disconnect();
          this._mo=new MutationObserver(()=>this._evaluateVisibility());
          this._mo.observe(tgt,{attributes:true,attributeFilter:["class","style","aria-hidden"],subtree:false});
          this._contentMO && this._contentMO.disconnect();
          this._contentMO=new MutationObserver(()=>this._evaluateVisibility());
          const recList=document.querySelector("#recList"); if(recList) this._contentMO.observe(recList,{childList:true,subtree:false});
          const compBody=document.querySelector("#comparative tbody"); if(compBody) this._contentMO.observe(compBody,{childList:true,subtree:false});
          this._io && this._io.disconnect();
          this._io=new IntersectionObserver((entries)=>{const visible=entries.some(e=>e.isIntersecting);this._evaluateVisibility(visible);},{root:null,threshold:0.01});
          this._io.observe(tgt);
          this._tick && clearInterval(this._tick);
          this._tick=setInterval(()=>this._evaluateVisibility(),500);
          this._evaluateVisibility();
        }
        _hasComputedResult(){
          if (typeof window!=="undefined" && window.__lastReport) return true;
          const hasRec = !!document.querySelector("#recList li");
          const hasRows = !!document.querySelector("#comparative tbody tr");
          const btnP=document.getElementById('btnPrint'), btnC=document.getElementById('btnCopy');
          const buttonsReady = !!(btnP && btnC && !btnP.disabled && !btnC.disabled);
          return hasRec || hasRows || buttonsReady;
        }
        _evaluateVisibility(ioVisible){
          const tgt=this._getTarget(); if(!tgt){ this._setVisible(false); return; }
          const style=getComputedStyle(tgt);
          const displayOk=style.display!=="none" && style.visibility!=="hidden" && style.opacity!=="0";
          const classOk=!(tgt.classList && tgt.classList.contains("hidden"));
          const showOk=(tgt.classList && (tgt.classList.contains("show")||tgt.classList.contains("active"))) || tgt.getAttribute("aria-hidden")==="false";
          const when=(this.getAttribute("data-when")||"visible").toLowerCase();
          const require=(this.getAttribute("data-require")||"report").toLowerCase();
          const logicalVisible = (when==="always") ? true : (showOk || (displayOk && classOk));
          let computedOk=true;
          if(require==="report"){ computedOk = this._hasComputedResult(); }
          else if(require==="rows"){ const rec = !!document.querySelector("#recList li"); const rows=!!document.querySelector("#comparative tbody tr"); computedOk = (rec||rows); }
          const finalVisible = logicalVisible && computedOk && (ioVisible===undefined ? true : ioVisible);
          this._setVisible(finalVisible);
        }
        _setVisible(flag){ const box=this._shadow.querySelector(".box"); if(box) box.classList.toggle("hidden",!flag); }
      }
      if(!customElements.get("app-disclaimer")){ customElements.define("app-disclaimer",AppDisclaimer); }
    })();
    </script>


<script src="../js/index.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  if (window.Capacitor && Capacitor.getPlatform() === "android") {
    const btnPrint = document.getElementById("btnPrint");
    if (btnPrint) btnPrint.style.display = "none";
  }
});
</script>

<footer>
  <img src="uibanner.png" alt="Unidad de Ictus M√°laga" style="max-width:380px;height:auto;opacity:.96;">
</footer>

</body>
</html>
