<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- ===== META DATA / SEO ===== -->
<meta name="title" content="Otras cardiopat√≠as embol√≠genas">
<meta name="description" content="Ayuda a la selecci√≥n del tratamiento en cardiopat√≠as embol√≠genas distintas a FA y FOP. Desarrollado por Rafael Bustamante Toledo.">
<meta name="keywords" content="ictus criptog√©nico, cardiopat√≠a embol√≠gena, cardiopat√≠a, neurolog√≠a vascular, Ictus GPS, tratamiento ictus, prevenci√≥n secundaria">
<meta name="author" content="Rafael Bustamante Toledo">
<meta name="robots" content="index, follow">
<meta property="og:title" content="Otras cardiopat√≠as embol√≠genas">
<meta property="og:description" content="Ayuda a la selecci√≥n del tratamiento en cardiopat√≠as embol√≠genas distintas a FA y FOP.">
<meta property="og:type" content="website">
<meta property="og:image" content="../iconos/ictusgps.png">
<meta property="og:locale" content="es_ES">
<meta name="theme-color" content="#0f3d83">

<title>Otras cardiopat√≠as embol√≠genas</title>
<link rel="icon" type="image/png" sizes="192x192" href="../iconos/ictusgps.png">
<link rel="apple-touch-icon" sizes="180x180" href="../iconos/ictusgps.png">

<style>
/* =========================================================
   VARIABLES GLOBALES
========================================================= */
:root{
  --bg:#f8fafc; 
  --ink:#0e1a33;

  --azul:#0f3d83;
  --azul-institucional:#0f3d83;

  --accent-dark:#0f3d83;
  --accent-light:#2563eb;

  --border:#e5e9f2;
  --muted:#64748b;

  --ok:#166534;
  --ok-bg:#e9fce7;
  --ok-ring:#bbf7d0;

  --mid:#92400e;
  --mid-bg:#fff7ed;
  --mid-ring:#fed7aa;

  --bad:#991b1b;
  --bad-bg:#fef2f2;
  --bad-ring:#fecaca;

  --gris:#6b7280;
  --borde:#e5e7eb;
  --error:#b91c1c;
}

/* TIPOGRAF√çA GLOBAL VERDANA */
html, body,
.wrap, .card, .panel, .block,
label, input, select, button, table, p, h1, h2, h3, li {
  font-family: Verdana, Geneva, sans-serif !important;
}

body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
}

/* =========================================================
   SAFE-TOP (FIJO 60 px + notch)
========================================================= */
.safe-top {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: calc(env(safe-area-inset-top) + 60px);
  background: var(--azul-institucional);
  z-index: 1001;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding-top: env(safe-area-inset-top);
}

.safe-content{
  width:100%;
  max-width:1080px;
  padding: 6px 16px 8px;
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
}

.safe-left{
  display:flex;
  align-items:center;
  gap:10px;
}

.safe-mini{
  width:44px;
  height:44px;
  object-fit:contain;
  padding:4px;
  box-shadow:0 0 4px rgba(0,0,0,0.1);
}

.safe-logo{
  height:44px;
  width:auto;
}

.safe-actions{
  display:flex;
  gap:10px;
}

.safe-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:40px;
  height:40px;
  background:rgba(255,255,255,0.15);
  border:1px solid white;
  border-radius:50%;
  transition:background .25s, border-color .25s, transform .1s;
}

.safe-btn:hover{
  background:#01c5fe;
}

.safe-btn:active{
  transform:scale(0.95);
}

.safe-icon{
  width:32px; 
  height:32px;
  object-fit:contain;
}

/* =========================================================
   CABECERA STICKY
========================================================= */
header{
  position:sticky;
  top:calc(env(safe-area-inset-top) + 52px);
  z-index:1002;
  backdrop-filter:blur(6px);
  background:var(--azul-institucional);
  border-bottom:1px solid rgba(255,255,255,.08);
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
  color:#fff;
}

.bar{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  height:52px;
  padding:0 16px;
}

.title{
  display:flex;
  align-items:center;
  font-size:1.4rem;
  font-weight:700;
  color:#fff;
}

.title img{
  width:32px;
  height:32px;
  margin-right:8px;
}


/* =========================================================
   CONTENIDO
========================================================= */
.wrap{
  max-width:1080px;
  margin:16px auto 48px;
  padding:0 16px;
}

.panel{
  background:#fff;
  border-radius:16px;
  padding:16px;
  box-shadow:0 3px 14px rgba(16,71,119,.12);
  border:1px solid var(--border);
  margin-top:8px;
}

.howto{
  background:#fff;
  border-radius:14px;
  box-shadow:0 2px 10px rgba(15,23,42,.06);
  font-size:.9rem;
  padding:12px;
  margin:12px 0 18px;
  border:1px solid var(--border);
}

/* Bloques tem√°ticos tipo FOP */
.block{
  border-radius:14px;
  padding:14px 16px;
  margin:14px 0;
  transition:background .3s;
}

.block h3{
  margin:0 0 8px 0;
  font-size:1.05rem;
  font-weight:800;
  display:flex;
  align-items:center;
  gap:6px;
}

.block.patologia{
  background:#eff6ff;
  border-left:4px solid #2563eb;
}

.block.datos{
  background:#f8fafc;
  border-left:4px solid #0f3d83;
}

.block.escalas{
  background:#ecfdf5;
  border-left:4px solid #16a34a;
}

.block.condiciones{
  background:#fffbeb;
  border-left:4px solid #f59e0b;
}

.block.resultado{
  background:#ffffff;
  border-left:4px solid #0f172a;
}

.note{
  color:#64748b;
  font-size:12px;
  margin:6px 0 12px;
}

/* Grids */
.grid{
  display:grid;
  gap:10px;
}
.g-2{grid-template-columns:repeat(auto-fit,minmax(260px,1fr));}
@media(min-width:640px){
  .grid.cols-2{grid-template-columns:1fr 1fr;}
}

/* Labels y controles */
label{
  font-weight:400;
  color:#1e293b;
  margin-top:6px;
  display:block;
  font-size:.92rem;
}

label.row{font-weight:400;}

input[type="number"], select{
  width:100%;
  box-sizing:border-box;
  border:1px solid #cbd5e1;
  background:#fff;
  border-radius:10px;
  padding:10px 12px;
  font-size:0.95rem;
}

.inlineSelect{
  display:flex;
  gap:8px;
}
.inlineSelect .val{flex:1;}
.inlineSelect .unit{width:44%;}

small.hint{
  color:#64748b;
  opacity:.9;
  font-size:0.78rem;
}

/* Checkboxes estilo FOP */
.check,
.block .row{
  display:flex;
  align-items:flex-start;
  gap:8px;
  margin:4px 0;
  color:#1e293b;
  font-weight:400;
  transition:color .2s;
}

.check:hover,
.block .row:hover{
  color:#0f3d83;
}

.check input,
.block .row input{
  margin-top:2px;
  transform:scale(1.05);
  accent-color:#0f3d83;
}

/* Separador */
.sep{
  height:1px;
  background:#e5e9f2;
  margin:12px 0;
}

/* Botonera principal */
.actions{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:16px;
}

.btn-action{
  flex:1 1 32%;
  border:none;
  border-radius:10px;
  padding:10px 12px;
  font-size:14px;
  font-weight:700;
  cursor:pointer;
}

.btn-calc{
  background:#0f3d83;
  color:#fff;
  border:1px solid #0f3d83;
}
.btn-calc:hover{background:#1c60c3;}

.btn-clear{
  background:#fff;
  color:#0b2c5f;
  border:1px solid #2563eb;
}
.btn-clear:hover{background:#eff6ff;}

.btn-copy,
.btn-print{
  background:#fff;
  color:#0f3d83;
  border:1px solid #2563eb;
}
.btn-copy:hover,
.btn-print:hover{background:#eff6ff;}

.btn-copy.copiado{
  background:#0f3d83!important;
  color:#fff!important;
}

/* KPI Resultados tipo tarjetas */
.kpi{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:12px;
  margin-top:10px;
}

.box{
  border:1.5px dashed #c7dbff;
  border-radius:14px;
  padding:14px;
  background:#f8fbff;
  text-align:center;
}

.ttl{
  font-size:14px;
  color:#334155;
  font-weight:800;
  margin-bottom:2px;
}

.val{
  font-size:22px;
  font-weight:900;
  color:#0b2c5f;
}

.mini{
  font-size:12px;
  color:#64748b;
  margin-top:4px;
}

/* Tonos para KPIs */
.ok{
  background:var(--ok-bg);
  border-color:var(--ok-ring);
}
.ok .val{color:var(--ok);}

.warn{
  background:var(--mid-bg);
  border-color:var(--mid-ring);
}
.warn .val{color:var(--mid);}

.bad{
  background:var(--bad-bg);
  border-color:var(--bad-ring);
}
.bad .val{color:var(--bad);}

/* Tabla comparativa */
table{
  width:100%;
  border-collapse:collapse;
  background:white;
  border-radius:12px;
  overflow:hidden;
  font-size:.9rem;
}

th,td{
  padding:6px 8px;
  border-bottom:1px solid #e8f2fb;
  text-align:left;
  vertical-align:top;
}

thead th{
  background:#eef6ff;
  color:#0b4576;
  font-size:.85rem;
}

tfoot td{
  background:#f3f9ff;
}

.right{text-align:right;}
.muted{color:#64748b;font-size:.85rem;}

.pill{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-weight:700;
  font-size:.8rem;
}

.pill.ok{background:#e8f5e9;color:#166534;}
.pill.okr{background:#fee2e2;color:#991b1b;}
.pill.bad{background:#fef2f2;color:#b91c1c;}

.tagPref{
  background:#e8f5e9;
  color:#166534;
  border:1px solid #bbf7d0;
  border-radius:999px;
  padding:2px 8px;
  font-size:.78rem;
  font-weight:700;
}
.tagAvoid{
  background:#fef2f2;
  color:#b91c1c;
  border:1px solid #fecaca;
  border-radius:999px;
  padding:2px 8px;
  font-size:.78rem;
  font-weight:700;
}
.tagNeutral{
  background:#eef6ff;
  color:#0b4576;
  border:1px solid #cfe3f6;
  border-radius:999px;
  padding:2px 8px;
  font-size:.78rem;
  font-weight:700;
}

/* Zebra por columnas visibles */
#comparative tbody td._zebra{background:#eef6ff;}
#comparative tbody tr.best td{background:#e8f5e9;}
#comparative tbody tr.best td:first-child{
  border-left:4px solid var(--ok);
  font-weight:700;
}

/* Columnas visibles */
#comparative tbody td._zebra{background:#eef6ff;}
@media (max-width:640px){
  .col-rra,.col-rrs{display:none;}
}

/* Toast */
.toast{
  position:fixed;
  top:calc(env(safe-area-inset-top,0px) + 8px);
  right:16px;
  background:#b71c1c;
  color:#fff;
  padding:10px 14px;
  border-radius:10px;
  box-shadow:0 6px 24px rgba(0,0,0,.18);
  opacity:0;
  transform:translateY(-10px);
  pointer-events:none;
  z-index:1100;
  transition:opacity .25s ease,transform .25s ease;
  max-width:min(92vw,520px);
  line-height:1.25;
  font-weight:600;
  font-size:.9rem;
}
.toast.show{
  opacity:1;
  transform:translateY(0);
  pointer-events:auto;
}
.toast.warn{background:#f57c00;}
.toast.info{background:#1976d2;}

/* Nota final abreviaturas */
.note-final{
  font-size:.84rem;
  color:#475569;
  margin-top:10px;
}

/* Bibliograf√≠a (mantengo tu secci√≥n en card) */
#bibliografia summary{
  font-weight:700;
  font-size:1.0rem;
  color:#0b4576;
  cursor:pointer;
  padding:4px 0;
}
#bibliografia ol{
  list-style-type:none;
  padding:0 0 0 10px;
  border-left:3px solid #cfe3f6;
}
#bibliografia li{
  margin-bottom:10px;
  font-size:0.85rem;
}
#bibliografia a{
  color:var(--accent-light);
  text-decoration:none;
}

/* DISCLAIMER FINAL */
.disclaimer-red{
  background:#fef2f2;
  border:1px solid #fecaca;
  border-radius:12px;
  padding:14px 16px;
  margin:20px auto 0;
  max-width:960px;
  box-shadow:0 2px 8px rgba(185,28,28,0.05);
}
.disclaimer-red p{
  margin:0;
  color:#7f1d1d;
  font-size:13px;
  line-height:1.5;
  text-align:left;
}
.disclaimer-red b{color:#991b1b;}

/* FOOTER */
footer{
  width:100%;
  margin:2rem 0 0;
  padding:1.5rem 0;
  border-top:1px solid #e5e7eb;
  background:#ffffff;
  text-align:center;
  box-shadow:0 -2px 6px rgba(0,0,0,0.04);
}
footer img { max-width:80%; height:auto; }
@media (min-width:600px){ footer img { max-width:380px; } }

/* =========================================================
   MEDIA QUERIES / BODY PADDING
========================================================= */
@media(max-width:768px){
  header{font-size:1.05rem;}
  body{font-size:0.96rem;}
}

/* Empuja el contenido real por debajo de la barra superior */
body{
  padding-top:calc(env(safe-area-inset-top, 0px) + 52px);
  background-color:#f8fafc;
}
</style>
</head>

<body>

<!-- SAFE-TOP UNIFICADO -->
<div class="safe-top">
  <div class="safe-content">
    <div class="safe-left">
      <img src="../iconos/utilidadesico.png" class="safe-mini" alt="Cardiopat√≠as embol√≠genas">
      <img src="../img/topbar.png" class="safe-logo" alt="IctusGPS">
    </div>
    <div class="safe-actions">
      <a href="javascript:history.back()" class="safe-btn" aria-label="Atr√°s">
        <img src="../iconos/atrastransparente.png" class="safe-icon" alt="">
      </a>
      <a href="../index.html" class="safe-btn" aria-label="Inicio">
        <img src="../iconos/hometransparente.png" class="safe-icon" alt="">
      </a>
    </div>
  </div>
</div>

<!-- CABECERA -->
<header>
  <div class="bar">
    <div class="title">
      <img src="cardiopatiasico.png" alt="">
      Otras cardiopat√≠as embol√≠genas
    </div>
  </div>
</header>

<main class="wrap">
<section class="panel">

  <!-- C√ìMO USAR -->
  <div class="howto">
    <b>C√≥mo usar:</b> seleccione la <b>patolog√≠a card√≠aca embol√≠gena</b> principal, marque los <b>factores espec√≠ficos</b> de esa entidad y complete los <b>datos cl√≠nicos</b> (edad, sexo, peso, creatinina, comorbilidades).  
    La calculadora estima el riesgo <b>CHA<sub>2</sub>DS<sub>2</sub>-VASc</b>, <b>HAS-BLED</b>, el <b>aclaramiento de creatinina</b> y muestra una recomendaci√≥n orientativa de <b>tratamiento antitromb√≥tico</b> (ACOD/AVK/no ACO) ajustada a la patolog√≠a y a las condiciones cl√≠nicas especiales.
  </div>

  <!-- BLOQUE 1: PATOLOG√çA CARD√çACA -->
  <div class="block patologia" id="patologia-section">
    <h3>ü´Ä Patolog√≠a card√≠aca embol√≠gena</h3>
    <label for="patologia"><b>Seleccione la entidad principal:</b></label>
    <select id="patologia" aria-label="Patolog√≠a card√≠aca" onchange="mostrarFactoresPatologia()">
      <option value="" disabled selected>Seleccione una patolog√≠a‚Ä¶</option>

      <!-- Cardiopat√≠as mantenidas -->
      <option value="hipertrofica">Miocardiopat√≠a hipertr√≥fica</option>
      <option value="iam">Infarto agudo de miocardio</option>
      <option value="dilatada">Miocardiopat√≠a dilatada</option>
      <option value="isquemica">Miocardiopat√≠a isqu√©mica</option>
      <option value="restrictiva">Miocardiopat√≠a restrictiva</option>
      <option value="tako">Miocardiopat√≠a de Tako-Tsubo</option>
      <option value="mixoma">Mixoma auricular</option>
      <option value="valvular">Pr√≥tesis valvulares / Cardiopat√≠a valvular</option>
      <option value="endocarditis">Endocarditis infecciosa</option>
      <option value="sicksinus">S√≠ndrome del seno enfermo</option>
<option value="auricula">Aur√≠cula izquierda/Orejuela (trombo o riesgo estructural)</option>
    </select>

    <div id="patologia-factores" style="margin-top:10px;"></div>
    <div id="patologia-resultado" class="note" style="margin-top:10px;"></div>
    <small class="hint">La recomendaci√≥n final se integra con el riesgo emb√≥lico y hemorr√°gico al pulsar <b>Calcular</b>.</small>
  </div>

  <!-- BLOQUE 2: DATOS DEL PACIENTE -->
  <div class="block datos">
    <h3>üë§ Datos del paciente</h3>
    <div class="grid g-2">
      <div>
        <label for="age">Edad (a√±os)</label>
        <input id="age" inputmode="numeric" max="110" min="18" placeholder="p. ej., 74" type="number">
      </div>
      <div>
        <label for="sex">Sexo</label>
        <select id="sex">
          <option value="">Selecciona‚Ä¶</option>
          <option value="M">Var√≥n</option>
          <option value="F">Mujer</option>
        </select>
      </div>
      <div>
        <label for="weight">Peso</label>
        <div class="inlineSelect">
          <input class="val" id="weight" max="400" min="10" placeholder="p. ej., 84.5" step="0.1" type="number">
          <select class="unit" id="weightUnit">
            <option value="kg">kg</option>
            <option value="lb">lb</option>
          </select>
        </div>
        <small class="hint">Puede introducir kg o lb.</small>
      </div>
      <div>
        <label for="scr">Creatinina s√©rica</label>
        <div class="inlineSelect">
          <input class="val" id="scr" max="15" min="0.1" placeholder="p. ej., 1.1" step="0.01" type="number">
          <select class="unit" id="scrUnit">
            <option value="mgdl">mg/dL</option>
            <option value="umol">¬µmol/L</option>
          </select>
        </div>
        <small class="hint">Para ¬µmol/L, se convierte a mg/dL (√∑ 88,4).</small>
      </div>
    </div>
  </div>

  <!-- BLOQUE 3: CHA2DS2-VASc / HAS-BLED (OCULTO HASTA QUE SE MARCA FA) -->
  <div class="block escalas" id="escalas-block" style="display:none;">
    <h3>üßÆ Escalas CHA<sub>2</sub>DS<sub>2</sub>-VASc y HAS-BLED</h3>
    <div class="grid g-2">
      <div>
        <label>CHA<sub>2</sub>DS<sub>2</sub>-VASc</label>
        <label class="row"><input id="cSc" type="checkbox"> Sexo femenino</label>
        <label class="row"><input id="cAge65" type="checkbox"> Edad 65‚Äì74 a√±os</label>
        <label class="row"><input id="cAge75" type="checkbox"> Edad ‚â• 75 a√±os (2 pt)</label>
        <label class="row"><input id="cCongest" type="checkbox"> Insuficiencia cardiaca / disfunci√≥n VI</label>
        <label class="row"><input id="cStroke" type="checkbox"> Ictus/AIT/TE previo (2 pt)</label>
        <label class="row"><input id="cHTN" type="checkbox"> Hipertensi√≥n</label>
        <label class="row"><input id="cDiab" type="checkbox"> Diabetes</label>
        <label class="row"><input id="cVasc" type="checkbox"> Vascular (IAM, placa a√≥rtica, EAP)</label>
      </div>
      <div>
        <label>HAS-BLED</label>
        <label class="row"><input id="hHTN" type="checkbox"> HTA (&gt;160 mmHg sist.)</label>
        <label class="row"><input id="hRenal" type="checkbox" title="Autorrelleno si SCr ‚â•2,26 mg/dL o ClCr &lt;30 ml/min"> Disfunci√≥n renal (incluye trasplante)</label>
        <label class="row"><input id="hLiver" type="checkbox"> Disfunci√≥n hep√°tica</label>
        <label class="row"><input id="hStroke" type="checkbox"> Ictus previo</label>
        <label class="row"><input id="hBleed" type="checkbox"> Sangrado mayor/di√°tesis</label>
        <label class="row"><input id="hLabileINR" type="checkbox"> INR l√°bil (si VKA)</label>
        <label class="row"><input id="hElder" type="checkbox" title="Autorrelleno si edad &gt;65 a√±os"> Edad &gt;65</label>
        <label class="row"><input id="hDrugs" type="checkbox"> F√°rmacos (antiagregantes, AINEs...)</label>
        <label class="row"><input id="hAlcohol" type="checkbox"> Alcohol</label>
      </div>
    </div>
  </div>

  <!-- BLOQUE 4: CONDICIONES CL√çNICAS ESPECIALES -->
  <div class="block condiciones">
    <h3>‚öïÔ∏è Condiciones cl√≠nicas especiales</h3>
    <div class="grid g-2">
      <div>
        <label class="row"><input id="condDysphagia" type="checkbox"> Disfagia / administraci√≥n por SNG</label>
        <label class="row"><input id="condGIbleed" type="checkbox"> Antecedente de hemorragia digestiva severa</label>
        <label class="row"><input id="condICHrisk" type="checkbox"> Alto riesgo de hemorragia intracraneal</label>
        <label class="row"><input id="condValvular" type="checkbox"> Pr√≥tesis valvular mec√°nica o EM reum√°tica significativa</label>
        <label class="row"><input id="condOncoGI" type="checkbox"> Neoplasia GI/GU activa</label>
      </div>
      <div>
        <label class="row"><input id="condPolypharm" type="checkbox"> Polimedicaci√≥n/intolerancia a interacciones</label>
        <label class="row"><input id="condCirrhosis" type="checkbox"> Hepatopat√≠a avanzada (Child-Pugh B‚ÄìC)</label>
        <label class="row"><input id="condObesity" type="checkbox" title="Autorrelleno si peso &gt;120 kg"> Obesidad m√≥rbida (IMC &gt;40 o &gt;120 kg)</label>
        <label class="row"><input id="condPoorINR" type="checkbox"> Dificultad para monitorizar INR/visitas</label>
        <label class="row"><input id="condQD" type="checkbox"> Preferencia por dosis √∫nica diaria</label>
        <label class="row"><input id="condPgp" type="checkbox"> Inhibidor potente de P-gp (verapamilo/dronedarona/quinidina)</label>
      </div>
    </div>
  </div>

  <!-- BOTONES PRINCIPALES -->
  <div class="actions">
    <button type="button" class="btn-action btn-calc" id="btnCalc">Calcular</button>
    <button type="button" class="btn-action btn-clear" id="btnReset">Borrar</button>
    <span aria-live="polite" role="status" class="muted" id="calcMsg" style="align-self:center;">&nbsp;</span>
  </div>

  <!-- BLOQUE 5: RESULTADOS -->
  <div class="block resultado" id="resultCard">
    <h3>üìä Resultados globales</h3>

    <!-- KPIs principales -->
    <div class="kpi">
      <div class="box" id="kpiScore">
        <div class="ttl">CHA<sub>2</sub>DS<sub>2</sub>-VA</div>
        <div class="val"><span id="scoreVA">‚Äì</span></div>
        <div class="mini">CHA<sub>2</sub>DS<sub>2</sub>-VASc cl√°sico: <span id="scoreVASc">‚Äì</span></div>
      </div>
      <div class="box" id="kpiHAS">
        <div class="ttl">HAS-BLED</div>
        <div class="val"><span id="scoreHASBLED">‚Äì</span></div>
        <div class="mini">Riesgo anual de sangrado: <span id="annualBleed">‚Äì</span>%</div>
      </div>
      <div class="box" id="kpiStroke">
        <div class="ttl">Riesgo anual de ictus (sin tto)</div>
        <div class="val"><span id="annualStroke">‚Äì</span>%</div>
        <div class="mini">Estimaci√≥n basada en CHA<sub>2</sub>DS<sub>2</sub>-VASc.</div>
      </div>
      <div class="box" id="kpiRenal">
        <div class="ttl">Funci√≥n renal (Cockcroft‚ÄìGault)</div>
        <div class="val"><span id="crcl">‚Äì</span> ml/min</div>
        <div class="mini">Creatinina convertida: <span id="scrConv">‚Äì</span> mg/dL</div>
      </div>
    </div>

    <div class="sep"></div>

    <!-- RECOMENDACI√ìN POR PATOLOG√çA -->
    <h3 style="margin:0 0 6px;">üß∑ Conclusi√≥n por patolog√≠a</h3>
    <div id="patologia-rec-final" style="font-size:.95rem; padding:8px 0;"></div>

    <div class="sep"></div>

    <!-- TABLA COMPARATIVA ESTRATEGIAS -->
    <h3 style="margin:0 0 6px;">Comparativa de estrategias (modelo FA no valvular)</h3>
    <table id="comparative">
      <thead>
        <tr>
          <th>Estrategia</th>
          <th class="right">RA ictus</th>
          <th class="right">RRR</th>
          <th class="right col-rra">RRA</th>
          <th class="right">NNT</th>
          <th class="right">RS</th>
          <th class="right col-rrs">RRS</th>
          <th class="right">NNH</th>
          <th class="right">Adecuaci√≥n cl√≠nica</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td class="muted" colspan="9">
            Coeficientes orientativos derivados de ensayos en FA; adaptar siempre a las gu√≠as locales y a la patolog√≠a concreta.
          </td>
        </tr>
      </tfoot>
    </table>

    <div class="sep"></div>

    <!-- RECOMENDACIONES INDIVIDUALIZADAS -->
    <h3 style="margin:0 0 6px;">Recomendaciones individualizadas de DOACs/VKA</h3>
    <ul id="recList" class="list-min" style="padding-left:16px;margin:0;"></ul>

    <div class="sep"></div>

    <!-- POSOLOG√çA -->
    <div id="doseSection">
      <h3 style="margin:0 0 6px;">Posolog√≠a sugerida seg√∫n datos introducidos</h3>
      <ul id="doseList" class="list-min" style="padding-left:16px;margin:0;"></ul>
    </div>

    <!-- BOTONES INFORME -->
    <div class="actions" style="margin-top:14px;">
      <button type="button" class="btn-action btn-print" id="btnPrint" disabled>Imprimir informe</button>
      <button type="button" class="btn-action btn-copy" id="btnCopy" disabled>Copiar informe</button>
      <span class="muted" id="printHint" style="align-self:center;">Genera un resumen imprimible/copiable con conclusiones y, si procede, posolog√≠a.</span>
    </div>

    <p class="note-final">
      <b>Abreviaturas:</b> RA = riesgo anual de ictus; RRR = reducci√≥n relativa; RRA = reducci√≥n absoluta;
      NNT = n¬∫ necesario a tratar; RS = riesgo anual de sangrado mayor; RRS = riesgo relativo de sangrado vs AVK; NNH = n¬∫ necesario para da√±ar.
    </p>
  </div>

</section>

<!-- TOAST -->
<div id="toast" class="toast" role="alert" aria-live="assertive"></div>

<!-- BIBLIOGRAF√çA -->
<section class="panel" id="bibliografia">
  <details>
    <summary>Bibliograf√≠a y referencias cl√≠nicas</summary>
    <ol>
      <li><b>CHA‚ÇÇDS‚ÇÇ-VASc:</b> Friberg L, Rosenqvist M, Lip GYH. Eur Heart J. 2012;33(12):1500‚Äì1510.</li>
      <li>Olesen JB, et al. BMJ. 2011;342:d124.</li>
      <li><b>HAS-BLED:</b> Pisters R, Lane DA, et al. Chest. 2010;138(5):1093‚Äì1100.</li>
      <li>Lip GYH, et al. J Am Coll Cardiol. 2011;57(2):173‚Äì180.</li>
      <li><b>Cockcroft‚ÄìGault:</b> Cockcroft DW, Gault MH. Nephron. 1976;16(1):31‚Äì41.</li>
      <li><b>FA ‚Äì Gu√≠as ESC/ACC/AHA:</b> Van Gelder IC, et al. Eur Heart J. 2024; Joglar JA, et al. Circulation. 2023.</li>
      <li><b>Valvulopat√≠as:</b> Baumgartner H, et al. Eur Heart J. 2021;42(37):3597‚Äì3632.</li>
      <li><b>Insuficiencia cardiaca/miocardiopat√≠as:</b> McDonagh TA, et al. Eur Heart J. 2021;42(36):3599‚Äì3726.</li>
      <li><b>Miocardiopat√≠a hipertr√≥fica:</b> Elliott PM, et al. Eur Heart J. 2014;35(39):2733‚Äì2779.</li>
      <li><b>Endocarditis:</b> Habibi G, et al. Eur Heart J. 2015;36(44):3075‚Äì3128.</li>
      <li><b>ACOD en FA:</b> ARISTOTLE, RE-LY, ROCKET-AF, ENGAGE AF‚ÄìTIMI 48 y metaan√°lisis de Ruff CT, et al. Lancet. 2014.</li>
      <li><b>Gu√≠a pr√°ctica ACOD:</b> Steffel J, et al. Europace. 2021;23(10):1612‚Äì1676.</li>
      <li><b>Obesidad/ACOD:</b> Martin K, et al. J Thromb Haemost. 2021;19:1874‚Äì1882.</li>
      <li><b>Hemorragia GI y ACOD:</b> Radadiya D, et al. Eur J Gastroenterol Hepatol. 2021;33(1S Suppl 1):e50‚Äìe58.</li>
    </ol>
  </details>
</section>

<!-- DISCLAIMER -->
<section class="disclaimer-red">
  <p>
    <b>Advertencia.</b> Esta herramienta tiene car√°cter orientativo y no sustituye el juicio cl√≠nico del profesional ni los protocolos locales.
    Las recomendaciones deben integrarse con la situaci√≥n individual del paciente, las gu√≠as vigentes y la discusi√≥n multidisciplinar cuando proceda.
  </p>
</section>

</main>

<footer>
  <img src="uibanner.png" alt="Unidad de Ictus M√°laga">
</footer>

<!-- ===========================
     L√ìGICA JS ORIGINAL ADAPTADA
=========================== -->
<script>
/* ===== Datos y l√≥gica de patolog√≠as (igual que en tu versi√≥n original) ===== */

// =========================
// DETECCI√ìN GLOBAL DE FA
// =========================
const FA_KEYWORDS = [
  "FA",                       // cualquier forma
  "FA ",                      // m√°s seguro
  "FA/",                      // variaciones
  "FA-",                      // variaciones
  "FA parox√≠stica",
  "FA concomitante",
  "FA documentada",
  "FA Parox√≠stica/Cr√≥nica documentada"
];

// =========================
// FUNCI√ìN QUE DETECTA SI LA PATOLOG√çA ACTUAL TIENE FA MARCADA
// =========================
function patologiaTieneFASeleccionada() {
  const checks = document.querySelectorAll("#patologia-factores input[type='checkbox']:checked");
  return Array.from(checks).some(ch =>
    FA_KEYWORDS.some(kw => ch.value.includes(kw))
  );
}



const factoresPatologia = {
  hipertrofica: ['FA parox√≠stica'],
  iam: ['IAM anterior extenso', 'FE < 40%', 'Trombo cavitario', 'Ictus periinfarto'],
  dilatada: ['FE ‚â§ 28%', 'Trombo apical', 'FA concomitante'],
  isquemica: ['Zonas acin√©ticas o hipocin√©ticas', 'Trombo mural documentado', 'FE ‚â§ 35%', 'Antecedente de ictus cardioemb√≥lico'],
  restrictiva: ['FA documentada', 'Trombos auriculares', 'Amiloidosis confirmada'],
  tako: ['FA concomitante', 'Trombo ventricular', 'FE < 40%'],
  mixoma: ['Trombo en aur√≠cula', 'Ictus cardioemb√≥lico'],
  valvular: ['V√°lvula mec√°nica', 'Pr√≥tesis Biol√≥gica A√≥rtica (TAVI/Quir√∫rgica)', 'Pr√≥tesis Biol√≥gica Mitral/Tric√∫spide', 'Estenosis mitral moderada-severa', 'FA concomitante', 'Complicaciones tromboemb√≥licas previas'],
  endocarditis: ['Complicaciones neurol√≥gicas', 'Aneurismas mic√≥ticos'],
  sicksinus: ['FA Parox√≠stica/Cr√≥nica documentada', 'Antecedente de ictus/embolia sist√©mica'],
auricula: [
  'Trombo en aur√≠cula izquierda / orejuela',
  'Estenosis mitral moderada-severa',
  'FA concomitante',
  'Dilataci√≥n auricular severa',
  'FEVI < 35%',
  'Ictus cardioemb√≥lico previo'
]
};

const patologiaAutoChecks = {
  'Insuficiencia Card√≠aca (1 pto)': {cCongest: true},
  'Hipertensi√≥n (1 pto)': {cHTN: true},
  'Diabetes (1 pto)': {cDiab: true},
  'Ictus/AIT/TE previo (2 ptos)': {cStroke: true, hStroke: true},
  'Enfermedad Vascular (1 pto)': {cVasc: true},
  'FA parox√≠stica': {cCongest: true}, 
  'FA concomitante': {cCongest: true}, 
  'FA documentada': {cCongest: true}, 
  'FA Parox√≠stica/Cr√≥nica documentada': {cCongest: true}, 
  'Ictus periinfarto': {cStroke: true, hStroke: true},
  'Antecedente de ictus cardioemb√≥lico': {cStroke: true, hStroke: true},
  'Complicaciones tromboemb√≥licas previas': {cStroke: true, hStroke: true},
};

let autoCheckedState = {};

/* Mostrar/ocultar bloque de escalas seg√∫n presencia de FA en los factores seleccionados */
function updateEscalasVisibility() {
  const escalasBlock = document.getElementById('escalas-block');
  if (!escalasBlock) return;

  const checks = document.querySelectorAll("#patologia-factores input[type='checkbox']:checked");
  const riesgos = Array.from(checks).map(el => (el.value || '').toUpperCase());

  const hasFA = riesgos.some(txt =>
    txt.includes('FA ') || txt.startsWith('FA')
  );

  escalasBlock.style.display = hasFA ? '' : 'none';
}

function aplicarAutoChecks() {
  Object.keys(autoCheckedState).forEach(id => {
    const el = document.getElementById(id);
    if (el) el.checked = false;
  });
  autoCheckedState = {};

  const patologia = document.getElementById("patologia").value;
  const checks = document.querySelectorAll("#patologia-factores input[type='checkbox']:checked");
  const riesgos = Array.from(checks).map(el => el.value);

  riesgos.forEach(riesgo => {
    if (patologiaAutoChecks[riesgo]) {
      const targets = patologiaAutoChecks[riesgo];
      for (const id in targets) {
        if (targets[id]) {
          const el = document.getElementById(id);
          if (el) {
            el.checked = true;
            autoCheckedState[id] = true;
          }
        }
      }
    }
  });

  const isValvularForced =
    riesgos.includes('V√°lvula mec√°nica') ||
    riesgos.includes('Estenosis mitral moderada-severa') ||
    riesgos.includes('¬°AVISO! Valvulopat√≠a mec√°nica/Estenosis mitral mod-severa (Requiere AVK)');

  const elCondValvular = document.getElementById('condValvular');
  if (elCondValvular) {
    if (isValvularForced) {
      elCondValvular.checked = true;
      autoCheckedState['condValvular'] = true;
    } else {
      elCondValvular.checked = false;
      delete autoCheckedState['condValvular'];
    }
  }

  autoCheckByInputs();
}

function checkAutoCheckedAlarm(controlId) {
  const el = document.getElementById(controlId);
  if (autoCheckedState[controlId] && !el.checked) {
    el.checked = true;
    showToast('‚ö†Ô∏è Esta casilla fue marcada autom√°ticamente por la Patolog√≠a Embol√≠gena y NO debe desmarcarse (coherencia cl√≠nica).', 'warn');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  ['cStroke', 'hStroke', 'condValvular', 'cCongest', 'cHTN', 'cDiab', 'cVasc'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', () => checkAutoCheckedAlarm(id));
  });
});

function actualizarPatologia() {
  aplicarAutoChecks();
  updateEscalasVisibility();
  mostrarRecomendacionPatologia(true);
}

function mostrarFactoresPatologia() {
  const div = document.getElementById("patologia-factores");
  const resultadoDiv = document.getElementById("patologia-resultado");
  const patologia = document.getElementById("patologia").value;
  div.innerHTML = "";
  resultadoDiv.innerHTML = "";

  if (factoresPatologia[patologia]) {
    factoresPatologia[patologia].forEach(factor => {
      const label = document.createElement("label");
      label.classList.add("row");
      label.innerHTML = `<input type='checkbox' value="${factor}"> ${factor}`;
      div.appendChild(label);
    });
    document.querySelectorAll("#patologia-factores input[type='checkbox']").forEach(cb => {
      cb.addEventListener('change', actualizarPatologia);
    });
    actualizarPatologia();
  } else {
    aplicarAutoChecks();
    resultadoDiv.textContent = "Seleccione una patolog√≠a para ver los factores de riesgo espec√≠ficos.";
    updateEscalasVisibility();
  }
}

function mostrarRecomendacionPatologia(preliminar = false) {
  const patologia = document.getElementById("patologia").value;
  const checks = document.querySelectorAll("#patologia-factores input[type='checkbox']:checked");
  const riesgos = Array.from(checks).map(el => el.value);
  const resultadoDiv = document.getElementById("patologia-resultado");
  
  let texto = "", recomendacion = "", fuerza = "INSUFICIENTE";
  let score = 0;
  const isFemale = riesgos.includes('Sexo Femenino (1 pto)');
  riesgos.forEach(r => {
    if (r.includes('2 ptos')) score += 2;
    else if (r.includes('1 pto')) score += 1;
  });

  switch(patologia) {
    case "hipertrofica":
      texto = "<b>Miocardiopat√≠a hipertr√≥fica</b> ‚Äì Riesgo emb√≥lico elevado si coexistencia de FA.";
      if (riesgos.includes("FA parox√≠stica")) {
        recomendacion = "Anticoagulaci√≥n indefinida (preferiblemente ACOD si no contraindicado), independientemente del CHA‚ÇÇDS‚ÇÇ-VASc.";
        fuerza = "ACODS_PREFERIDOS";
      } else {
        recomendacion = "No se indica anticoagulaci√≥n si no hay FA.";
        fuerza = "NO_ANTICOAGULAR";
      }
      break;

    case "iam":
  texto = "<b>Infarto agudo de miocardio</b> ‚Äì Mayor riesgo emb√≥lico si trombo cavitario o ictus periinfarto.";

  // PRIORIDAD CL√çNICA CORRECTA

  // 1Ô∏è‚É£ Ictus periinfarto ‚Üí anticoagulaci√≥n indefinida
  if (riesgos.includes("Ictus periinfarto")) {
    recomendacion = "Anticoagulaci√≥n (ACOD o AVK) indefinida como prevenci√≥n secundaria del ictus periinfarto. " ;
    fuerza = "ACODS_PREFERIDOS";

  // 2Ô∏è‚É£ Trombo cavitario ‚Üí anticoagulaci√≥n transitoria 3‚Äì6 meses
  } else if (riesgos.includes("Trombo cavitario")) {
    recomendacion = "Anticoagulaci√≥n (ACOD o AVK) 3‚Äì6 meses, con reevaluaci√≥n por imagen hasta resoluci√≥n del trombo.";
    fuerza = "ANTICOAGULACION_TRANSITORIA";

  // 3Ô∏è‚É£ Ning√∫n criterio mayor
  } else {
    recomendacion = "En ausencia de ictus periinfarto o trombo cavitario, no se recomienda anticoagulaci√≥n sistem√°tica.";
    fuerza = "NO_ANTICOAGULAR";
  }
  break;


    case "dilatada":
  texto = "<b>Miocardiopat√≠a dilatada</b> ‚Äì Riesgo emb√≥lico si trombo apical o FA concomitante.";

  // PRIORIDAD CORRECTA

  // 1Ô∏è‚É£ FA ‚Üí anticoagulaci√≥n indefinida
  if (riesgos.includes("FA concomitante")) {
    recomendacion = "Anticoagulaci√≥n indefinida (ACOD o AVK). ";
    fuerza = "ACODS_PREFERIDOS";

  // 2Ô∏è‚É£ Trombo apical ‚Üí anticoagulaci√≥n transitoria
  } else if (riesgos.includes("Trombo apical")) {
    recomendacion = "Anticoagulaci√≥n (ACOD o AVK) 3‚Äì6 meses, con reevaluaci√≥n por imagen hasta resoluci√≥n del trombo.";
    fuerza = "ANTICOAGULACION_TRANSITORIA";

  // 3Ô∏è‚É£ Sin FA y sin trombo
  } else {
    recomendacion = "No se indica anticoagulaci√≥n sistem√°tica sin trombo ni FA.";
    fuerza = "NO_ANTICOAGULAR";
  }
  break;


    case "isquemica":
      texto = "<b>Miocardiopat√≠a isqu√©mica</b> ‚Äì Riesgo emb√≥lico en zonas acin√©ticas, trombos murales o ictus previo.";
      if (riesgos.includes("Trombo mural documentado")) {
        recomendacion = "Anticoagulaci√≥n (AVK o ACOD) 3‚Äì6 meses, hasta resoluci√≥n del trombo.";
        fuerza = "ANTICOAGULACION_TRANSITORIA";
      } else if (riesgos.includes("Antecedente de ictus cardioemb√≥lico")) {
        recomendacion = "Anticoagulaci√≥n (AVK o ACOD) indefinida como prevenci√≥n secundaria.";
        fuerza = "ACODS_PREFERIDOS";
      } else {
        recomendacion = "No se indica anticoagulaci√≥n sistem√°tica sin trombo ni ictus cardioemb√≥lico.";
        fuerza = "NO_ANTICOAGULAR";
      }
      break;

    case "restrictiva":
      texto = "<b>Miocardiopat√≠a restrictiva</b> ‚Äì FA y trombos auriculares frecuentes, especialmente en amiloidosis.";
      if (riesgos.includes("FA documentada") || riesgos.includes("Trombos auriculares")) {
        recomendacion = "Anticoagulaci√≥n (ACOD o AVK) indefinida independientemente del CHA‚ÇÇDS‚ÇÇ-VASc.";
        fuerza = "ACODS_PREFERIDOS";
      } else {
        recomendacion = "Sin FA ni trombos, no se indica anticoagulaci√≥n sistem√°tica.";
        fuerza = "NO_ANTICOAGULAR";
      }
      break;

    case "tako":
      texto = "<b>Miocardiopat√≠a de Tako-Tsubo</b> ‚Äì Riesgo emb√≥lico bajo; individualizar.";
      if (riesgos.includes("FA concomitante")) {
        recomendacion = "Anticoagulaci√≥n indefinida (ACOD o AVK) independientemente del CHA‚ÇÇDS‚ÇÇ-VASc.";
        fuerza = "ACODS_PREFERIDOS";
      } else if (riesgos.includes("Trombo ventricular")) {
        recomendacion = "Anticoagulaci√≥n (AVK o ACOD) 3 meses o hasta resoluci√≥n del trombo.";
        fuerza = "ANTICOAGULACION_TRANSITORIA";
      } else {
        recomendacion = "No se recomienda anticoagulaci√≥n por defecto; valorar si persiste disfunci√≥n grave.";
        fuerza = "NO_ANTICOAGULAR";
      }
      break;

    case "mixoma":
      texto = "<b>Mixoma auricular</b> ‚Äì Riesgo emb√≥lico relevante; indicaci√≥n principal: cirug√≠a.";
      if (riesgos.includes("Ictus cardioemb√≥lico") || riesgos.includes("Trombo en aur√≠cula")) {
        recomendacion = "Anticoagulaci√≥n (preferiblemente AVK, pudiendo valorar ACOD) transitoria hasta la resecci√≥n quir√∫rgica.";
        fuerza = "ANTICOAGULACION_TRANSITORIA";
      } else {
        recomendacion = "Sin ictus ni trombo visible, se prioriza la cirug√≠a; anticoagulaci√≥n no sistem√°tica.";
        fuerza = "NO_ANTICOAGULAR";
      }
      break;

   case "valvular":
  texto = "<b>Patolog√≠a valvular / Pr√≥tesis valvulares</b> ‚Äì Riesgo emb√≥lico variable seg√∫n tipo de v√°lvula y presencia de FA.";

  const hasFAv = riesgos.includes("FA concomitante") || riesgos.includes("FA documentada") || riesgos.includes("FA Parox√≠stica/Cr√≥nica documentada");
  const hasTEPrevio = riesgos.includes("Complicaciones tromboemb√≥licas previas");

  const isMec√°nica = riesgos.includes("V√°lvula mec√°nica");
  const isEM_MS = riesgos.includes("Estenosis mitral moderada-severa");
  const isBioMitral = riesgos.includes("Pr√≥tesis Biol√≥gica Mitral/Tric√∫spide");
  const isBioAortica = riesgos.includes("Pr√≥tesis Biol√≥gica A√≥rtica (TAVI/Quir√∫rgica)");

  // ============================================================
  // 1Ô∏è‚É£ V√ÅLVULA MEC√ÅNICA ‚Üí AVK SIEMPRE (ACOD CONTRAINDICADOS)
  // ============================================================
  if (isMec√°nica) {
    recomendacion =
      "Anticoagulaci√≥n de por vida con AVK (INR seg√∫n posici√≥n y tipo de pr√≥tesis). " +
      "Los ACOD est√°n contraindicados en v√°lvulas mec√°nicas.";
    fuerza = "VKA_OBLIGATORIO";
    break;
  }

  // ============================================================
  // 2Ô∏è‚É£ ESTENOSIS MITRAL MODERADA-SEVERA (RMS/EM-MS)
  // ============================================================
  if (isEM_MS) {
    if (hasFAv || hasTEPrevio) {
      recomendacion =
        "Anticoagulaci√≥n indefinida con AVK. " +
        "Los ACOD est√°n contraindicados en estenosis mitral moderada-severa con FA.";
      fuerza = "VKA_OBLIGATORIO";
    } else {
      recomendacion =
        "En estenosis mitral moderada-severa en ritmo sinusal, no se recomienda anticoagulaci√≥n sistem√°tica. " ;
      fuerza = "ANTIAGREGACION_PREFERIDA";
    }
    break;
  }

  // ============================================================
  // 3Ô∏è‚É£ PR√ìTESIS BIOL√ìGICA MITRAL O TRIC√öSPIDE
  // ============================================================
  if (isBioMitral) {
    if (hasFAv || hasTEPrevio) {
      recomendacion =
        "Anticoagulaci√≥n indefinida (ACOD o AVK) por presencia de FA o eventos tromboemb√≥licos previos.";
      fuerza = "ACODS_PREFERIDOS";
    } else {
      recomendacion =
        "Anticoagulaci√≥n con AVK o ACOD durante 3‚Äì6 meses tras el implante (especialmente si posici√≥n mitral). " +
        "Despu√©s, AAS en monoterapia si ritmo sinusal. " +
        "En pr√≥tesis tric√∫spide aislada, suele ser suficiente AAS desde el inicio.";
      fuerza = "";
    }
    break;
  }

  // ============================================================
  // 4Ô∏è‚É£ PR√ìTESIS BIOL√ìGICA A√ìRTICA (TAVI o quir√∫rgica)
  // ============================================================
  if (isBioAortica) {
    if (hasFAv || hasTEPrevio) {
      recomendacion =
        "Anticoagulaci√≥n indefinida (ACOD o AVK) por presencia de FA o eventos tromboemb√≥licos previos.";
      fuerza = "ACODS_PREFERIDOS";
    } else {
      recomendacion =
        "AAS en monoterapia como estrategia est√°ndar. " +
        "La DAPT solo est√° indicada si existe un stent coronario implantado < 3 meses; no por la TAVI en s√≠.";
      fuerza = "ANTIAGREGACION_PREFERIDA";
    }
    break;
  }

  // ============================================================
  // 5Ô∏è‚É£ RESTO DE CARDIOPAT√çA VALVULAR NO PRINCIPAL
  // ============================================================
  if (hasFAv) {
    recomendacion =
      "Anticoagulaci√≥n (ACOD o AVK) seg√∫n CHA‚ÇÇDS‚ÇÇ-VASc, por la presencia de FA en el contexto de valvulopat√≠a no mec√°nica.";
    fuerza = "ACODS_PREFERIDOS";
  } else {
    recomendacion =
      "Sin FA ni pr√≥tesis mec√°nica, no se recomienda anticoagulaci√≥n sistem√°tica. " +
      "Suele bastar antiagregaci√≥n (AAS) o vigilancia cl√≠nica.";
    fuerza = "NO_ANTICOAGULAR";
  }
  break;


case "endocarditis":
  texto = "<b>Endocarditis infecciosa</b> ‚Äì Riesgo extremadamente alto de hemorragia intracraneal, incluso en ictus isqu√©micos.";

  const neuro = riesgos.includes("Complicaciones neurol√≥gicas");
  const micoticos = riesgos.includes("Aneurismas mic√≥ticos");

  if (neuro || micoticos) {
    recomendacion =
      "Evitar anticoagulaci√≥n. Suspender AVK/ACOD si estaban en uso salvo indicaci√≥n absolutamente imprescindible (p. ej., v√°lvula mec√°nica). " +
      "Tras un ictus isqu√©mico en el contexto de endocarditis, la anticoagulaci√≥n aumenta el riesgo de transformaci√≥n hemorr√°gica y de ruptura de aneurismas mic√≥ticos. " +
      "Reevaluaci√≥n tras 1‚Äì2 semanas y tras neuroimagen de control.";
    fuerza = "NO_ANTICOAGULAR";

  } else {
    recomendacion =
      "No se recomienda anticoagulaci√≥n durante la endocarditis activa salvo indicaci√≥n esencial (p. ej., v√°lvula mec√°nica). " +
      "Decisi√≥n a individualizar en equipo multidisciplinar.";
    fuerza = "NO_ANTICOAGULAR";
  }

  break;


case "sicksinus":
  texto = "<b>S√≠ndrome del seno enfermo</b> ‚Äì La FA puede ser parox√≠stica u oculta; la estratificaci√≥n de riesgo sigue el CHA‚ÇÇDS‚ÇÇ-VASc.";
 
 // 2Ô∏è‚É£ ICTUS CARDIOEMB√ìLICO PREVIO (sin FA documentada)
  if (riesgos.includes("Antecedente de ictus/embolia sist√©mica")) {

    recomendacion =
      "Anticoagulaci√≥n indefinida (ACOD o AVK). Incluso en ausencia de FA documentada, un ictus cardioemb√≥lico en contexto de SSE es altamente sugestivo de FA oculta.";
    fuerza = "ACODS_PREFERIDOS";

  }

  // 1Ô∏è‚É£ FA DOCUMENTADA ‚Üí AC seg√∫n CHA‚ÇÇDS‚ÇÇ-VASc
  else if (riesgos.includes("FA Parox√≠stica/Cr√≥nica documentada")) {

    recomendacion =
      "Anticoagulaci√≥n si el CHA‚ÇÇDS‚ÇÇ-VASc lo indica. En el SSE la FA suele ser intermitente, por lo que debe evaluarse el riesgo emb√≥lico real mediante la escala.";
    fuerza = "ACODS_PREFERIDOS";

  }

  // 3Ô∏è‚É£ SIN FA NI ICTUS ‚Üí no AC
  else {

    recomendacion =
      "No se recomienda anticoagulaci√≥n en ausencia de FA documentada o ictus cardioemb√≥lico previo. Se aconseja monitorizaci√≥n prolongada por riesgo de FA silente.";
    fuerza = "NO_ANTICOAGULAR";

  }
  break;


case "auricula":
  texto = "<b>Aur√≠cula izquierda / orejuela</b> ‚Äì El riesgo emb√≥lico depende de la presencia de trombo, valvulopat√≠a mitral, FA y del remodelado auricular.";

  const tieneTrombo = riesgos.includes("Trombo en aur√≠cula izquierda / orejuela");
  const estenosisMitral = riesgos.includes("Estenosis mitral moderada-severa");
  const tieneFA = riesgos.includes("FA concomitante");
  const dilatacionSevera = riesgos.includes("Dilataci√≥n auricular severa");
  const feviBaja = riesgos.includes("FEVI < 35%");
  const ictusPrevio = riesgos.includes("Ictus cardioemb√≥lico previo");

  // 1Ô∏è‚É£ ESTENOSIS MITRAL ‚Üí AVK siempre
  if (estenosisMitral) {
    recomendacion =
      "Anticoagulaci√≥n obligatoria con AVK (ACOD contraindicados). Si existe trombo, mantener AVK y realizar control por imagen hasta su resoluci√≥n.";
    fuerza = "VKA_OBLIGATORIO";
  }

  // 2Ô∏è‚É£ FA CONCOMITANTE ‚Üí INDICACI√ìN ABSOLUTA
  else if (tieneFA) {
    recomendacion =
      "Anticoagulaci√≥n indefinida (ACOD o AVK). La FA implica estasis auricular y riesgo cardioemb√≥lico incluso sin trombo visible.";
    fuerza = "ACODS_PREFERIDOS";
  }

  // 3Ô∏è‚É£ TROMBO DOCUMENTADO (sin EM y sin FA)
  else if (tieneTrombo) {
    recomendacion =
      "Anticoagulaci√≥n 3‚Äì6 meses (ACOD o AVK) con control por imagen hasta resoluci√≥n. Tras la resoluci√≥n, individualizar si mantener antiagregaci√≥n o suspender.";
    fuerza = "ANTICOAGULACION_TRANSITORIA";
  }

  // 4Ô∏è‚É£ Aur√≠cula muy enferma sin trombo
  else if (dilatacionSevera && feviBaja) {
    recomendacion =
      "Considerar anticoagulaci√≥n (ACOD o AVK) por alto riesgo emb√≥lico asociado a dilataci√≥n severa y FEVI <35%, especialmente si sospecha de FA subcl√≠nica.";
    fuerza = "CONSIDERAR_ACOD";
  }

  // 5Ô∏è‚É£ Ictus previo emb√≥lico atribuible a aur√≠cula
  else if (ictusPrevio) {
  recomendacion =
    "Ictus cardioemb√≥lico previo. Sin FA, trombo o estenosis mitral moderada‚Äìsevera, no se indica anticoagulaci√≥n indefinida. Reevaluar etiolog√≠a y monitorizar FA oculta.";
  fuerza = "NO_ANTICOAGULAR";
}


  // 6Ô∏è‚É£ Caso basal (sin nada relevante)
  else {
    recomendacion =
      "Sin trombo, sin FA y sin valvulopat√≠a mitral significativa, no se recomienda anticoagulaci√≥n sistem√°tica.";
    fuerza = "NO_ANTICOAGULAR";
  }
  break;




    default:
      texto = "Seleccione una patolog√≠a.";
      recomendacion = "A la espera de selecci√≥n y factores de riesgo.";
      fuerza = "INSUFICIENTE";
  }
// === COLETILLA SEG√öN FUERZA ===
let coletilla = "";

switch (fuerza) {
  case "ACODS_PREFERIDOS":
    coletilla = " ACOD preferidos por mejor perfil eficacia/seguridad.";
    break;
  case "ANTICOAGULACION_TRANSITORIA":
    coletilla = " Anticoagulaci√≥n temporal con reevaluaci√≥n por imagen.";
    break;
  case "VKA_OBLIGATORIO":
    coletilla = " ACOD contraindicados: solo AVK.";
    break;
  case "NO_ANTICOAGULAR":
    coletilla = " No se recomienda anticoagulaci√≥n.";
    break;
  case "ANTIAGREGACION_PREFERIDA":
    coletilla = " Antiagregaci√≥n seg√∫n perfil cl√≠nico.";
    break;
}



// A√±adir coletilla al texto de recomendaci√≥n
recomendacion += coletilla;

  const resumen = riesgos.length > 0 ? riesgos.join(", ") : "Ninguno";
  resultadoDiv.innerHTML = `${texto}<br><b>Factores de riesgo presentes:</b> ${resumen}.<br><b>Recomendaci√≥n orientativa:</b> ${recomendacion}`;



  const patTxt = patologia === "" ? "No seleccionada" : texto.replace(/<\/?b>/g, '');
  document.getElementById('patologia-rec-final').innerHTML =
    `<b>Patolog√≠a:</b> ${patTxt}<br><b>Recomendaci√≥n:</b> ${recomendacion}`;

  return {fuerza, recomendacion};
}

/* ===== Utilidades y c√°lculos (id√©ntico a tu c√≥digo previo) ===== */
const NDASH = '\u2013';
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const fmt   = (x,d=1)=>isFinite(x)?(+x).toFixed(d):NDASH;
const oneIn = pct=>{const p=parseFloat(pct);if(!isFinite(p)||p<=0)return NDASH;return Math.round(100/p);};
const scrollToResult = ()=>{const el=document.getElementById('resultCard');if(el)el.scrollIntoView({behavior:'smooth',block:'start'});};

let _toastTimer=null;
function decodeEntities(str){const ta=document.createElement('textarea');ta.innerHTML=String(str);return ta.value;}
function escAttr(s){return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function showToast(msg,type='error'){
  const t=document.getElementById('toast');
  t.textContent=decodeEntities(msg);
  t.classList.remove('warn','info');
  if(type==='warn')t.classList.add('warn');
  if(type==='info')t.classList.add('info');
  t.classList.add('show');
  clearTimeout(_toastTimer);
  _toastTimer=setTimeout(()=>t.classList.remove('show'),3500);
}

/* Par√°metros de riesgo */
let strokeRisksByVasc={0:0.2,1:0.6,2:2.2,3:3.2,4:4.8,5:7.2,6:9.7,7:11.2,8:10.8,9:12.2};
let bleedRiskByHASBLED={0:1.1,1:1.9,2:3.4,3:5.8,4:8.9,5:12.5,6:15.0};
let RR_Stroke={"No terapia":1.00,"VKA":0.36,"Apixab√°n":0.36*0.79,"Dabigatr√°n":0.36*0.66,"Edoxab√°n":0.36*0.87,"Rivaroxab√°n":0.36*0.79};
let RR_Bleed_vs_VKA={"No terapia":0.30,"VKA":1.00,"Apixab√°n":0.69,"Dabigatr√°n":0.93,"Edoxab√°n":0.80,"Rivaroxab√°n":1.04};
const STRATS=["No terapia","VKA","Apixab√°n","Dabigatr√°n","Edoxab√°n","Rivaroxab√°n"];

function calcVasc(age,female,flags){
  let s=0;
  if(flags.cCongest)s+=1;
  if(flags.cHTN)s+=1;
  if(age>=75||flags.cAge75)s+=2;
  if(flags.cDiab)s+=1;
  if(flags.cStroke)s+=2;
  if(flags.cVasc)s+=1;
  if((age>=65&&age<=74)||flags.cAge65)s+=1;
  const classicVASc=s+(female?1:0);
  return{va:s,vasc:classicVASc};
}
function calcHASBLED(flags,age){
  let s=0;
  if(flags.hHTN)s+=1;
  if(flags.hRenal)s+=1;
  if(flags.hLiver)s+=1;
  if(flags.hStroke)s+=1;
  if(flags.hBleed)s+=1;
  if(flags.hLabileINR)s+=1;
  if(age>65||flags.hElder)s+=1;
  if(flags.hDrugs)s+=1;
  if(flags.hAlcohol)s+=1;
  return s;
}
function getStrokeRiskPct(vasc){
  const k=Math.max(0,Math.min(9,vasc|0));
  return strokeRisksByVasc[k]??0;
}
function getBleedRiskPct(hasbled){
  const k=Math.max(0,Math.min(6,hasbled|0));
  return bleedRiskByHASBLED[k]??bleedRiskByHASBLED[6];
}
function calcCrCl(age,sex,weightVal,wUnit,scrVal,scrUnit){
  if(!isFinite(age)||!sex||!isFinite(weightVal)||!isFinite(scrVal))
    return{crcl:NaN,scr_mgdl:NaN};
  const wtKg=(wUnit==='lb')?(weightVal/2.20462):weightVal;
  const scrMg=(scrUnit==='umol')?(scrVal/88.4):scrVal;
  const base=(140-age)*wtKg/(72*scrMg);
  const factor=(sex==='F')?0.85:1.0;
  return{crcl:base*factor,scr_mgdl:scrMg};
}

/* Autorrelleno de casillas base */
function autoCheckByInputs(){
  const age=clamp(parseFloat(document.getElementById('age').value)||0,0,150);
  const sex=document.getElementById('sex').value;
  const weightRaw=parseFloat(document.getElementById('weight').value);
  const weight=isFinite(weightRaw)?clamp(weightRaw,10,400):NaN;
  const wUnit=document.getElementById('weightUnit').value;
  const kg=isFinite(weight)?((wUnit==='lb')?(weight/2.20462):weight):NaN;
  const scrRaw=parseFloat(document.getElementById('scr').value);
  const scr=isFinite(scrRaw)?clamp(scrRaw,0.1,15):NaN;
  const scrUnit=document.getElementById('scrUnit').value;

  document.getElementById('cSc').checked=(sex==='F');
  document.getElementById('cAge75').checked=(age>=75);
  document.getElementById('cAge65').checked=(age>=65&&age<=74);
  document.getElementById('hElder').checked=(age>65);
  document.getElementById('condObesity').checked=(isFinite(kg)&&kg>120);

  const {crcl,scr_mgdl}=calcCrCl(age,sex,kg,'kg',scr,scrUnit);
  const renalByScr=(isFinite(scr_mgdl)&&scr_mgdl>=2.26);
  const renalByClCr=(isFinite(crcl)&&crcl<30);
  document.getElementById('hRenal').checked=(renalByScr||renalByClCr);
}

/* Validaci√≥n de contradicciones */
function checkAndFixContradictions(controlId){
  const age=clamp(parseFloat(document.getElementById('age').value)||0,0,150);
  const sex=document.getElementById('sex').value;
  const weightRaw=parseFloat(document.getElementById('weight').value);
  const weight=isFinite(weightRaw)?clamp(weightRaw,10,400):NaN;
  const wUnit=document.getElementById('weightUnit').value;
  const kg=isFinite(weight)?((wUnit==='lb')?(weight/2.20462):weight):NaN;
  const scrRaw=parseFloat(document.getElementById('scr').value);
  const scr=isFinite(scrRaw)?clamp(scrRaw,0.1,15):NaN;
  const scrUnit=document.getElementById('scrUnit').value;
  const {crcl,scr_mgdl}=calcCrCl(age,sex,kg,'kg',scr,scrUnit);
  const el=id=>document.getElementById(id);

  if(controlId==='condObesity'&&el('condObesity').checked&&!(isFinite(kg)&&kg>120)){
    showToast('Obesidad m√≥rbida: criterio habitual IMC ‚â•40 o peso >120 kg. Con el peso actual, mantenga la casilla solo si el IMC es ‚â•40.','warn');
    return true;
  }
  if(controlId==='cAge65'&&el('cAge65').checked&&!(age>=65&&age<=74)){
    el('cAge65').checked=false;
    showToast('Edad 65‚Äì74 solo si la edad est√° entre 65 y 74 a√±os.');
    return false;
  }
  if(controlId==='cAge75'&&el('cAge75').checked&&!(age>=75)){
    el('cAge75').checked=false;
    showToast('Edad ‚â•75 solo si la edad introducida es ‚â•75 a√±os.');
    return false;
  }
  if(controlId==='hElder'&&el('hElder').checked&&!(age>65)){
    el('hElder').checked=false;
    showToast('HAS-BLED: Edad >65 requiere edad introducida >65 a√±os.');
    return false;
  }
  if(controlId==='cSc'&&el('cSc').checked&&sex!=='F'){
    el('cSc').checked=false;
    showToast('Sexo femenino solo procede si el sexo seleccionado es Mujer.');
    return false;
  }
  if(controlId==='hRenal'&&el('hRenal').checked&&!((isFinite(scr_mgdl)&&scr_mgdl>=2.26)||(isFinite(crcl)&&crcl<30))){
    showToast('Disfunci√≥n renal HAS-BLED: revisar SCr ‚â•2,26 mg/dL o ClCr <30 ml/min. Si trasplante/di√°lisis, mantenga la casilla marcada.','warn');
    return true;
  }
  return true;
}

['condObesity','cAge65','cAge75','hElder','hRenal','cSc'].forEach(id=>{
  const el=document.getElementById(id);
  if(el) el.addEventListener('change',()=>checkAndFixContradictions(id));
});

/* Reglas cl√≠nicas con l√≥gica de prevalencia */
function buildClinicalRules(context, patologiaFuerza){
  const {crcl,age,special,weightKg}=context;
  const prefer={"VKA":new Set(),"Apixab√°n":new Set(),"Dabigatr√°n":new Set(),"Edoxab√°n":new Set(),"Rivaroxab√°n":new Set(),"No terapia":new Set()};
  const avoid={"VKA":new Set(),"Apixab√°n":new Set(),"Dabigatr√°n":new Set(),"Edoxab√°n":new Set(),"Rivaroxab√°n":new Set(),"No terapia":new Set()};
  const notes=[];

  switch (patologiaFuerza) {
    case "VKA_OBLIGATORIO":
      prefer.VKA.add("Patolog√≠a: VKA OBLIGATORIO (v√°lvula mec√°nica/EM reum√°tica con FA)");
      ["Apixab√°n", "Dabigatr√°n", "Edoxab√°n", "Rivaroxab√°n"].forEach(a => avoid[a].add("Contraindicados por valvulopat√≠a mayor"));
      avoid["No terapia"].add("Anticoagulaci√≥n requerida");
      notes.push("‚ö†Ô∏è La anticoagulaci√≥n con AVK es obligatoria por la patolog√≠a valvular. Los ACOD est√°n contraindicados.");
      break;
    case "NO_ANTICOAGULAR":
      prefer["No terapia"].add("Patolog√≠a: no se requiere anticoagulaci√≥n activa");
      ["VKA", "Apixab√°n", "Dabigatr√°n", "Edoxab√°n", "Rivaroxab√°n"].forEach(a => avoid[a].add("No indicado por patolog√≠a (antiagregaci√≥n o vigilancia)"));
      notes.push("‚úÖ No hay indicaci√≥n clara de anticoagulaci√≥n. Manejo habitual: antiagregaci√≥n o vigilancia.");
      break;
    case "ANTIAGREGACION_PREFERIDA":
      prefer["No terapia"].add("Patolog√≠a: antiagregaci√≥n preferida (p. ej. FOP o biopr√≥tesis a√≥rtica sin FA)");
      ["VKA", "Apixab√°n", "Dabigatr√°n", "Edoxab√°n", "Rivaroxab√°n"].forEach(a => avoid[a].add("Antiagregaci√≥n preferida por patolog√≠a; anticoagulaci√≥n solo en escenarios seleccionados"));
      notes.push("üß≤ La opci√≥n est√°ndar es antiagregaci√≥n plaquetaria (AAS); la anticoagulaci√≥n debe individualizarse y suele ser transitoria.");
      break;
  }

  if (patologiaFuerza !== "VKA_OBLIGATORIO" &&
      patologiaFuerza !== "NO_ANTICOAGULAR" &&
      patologiaFuerza !== "ANTIAGREGACION_PREFERIDA") {

    if (patologiaFuerza === "ANTICOAGULACION_TRANSITORIA") {
      notes.push("‚è±Ô∏è Anticoagulaci√≥n transitoria (habitualmente 3‚Äì6 meses), con reevaluaci√≥n posterior.");
      avoid["No terapia"].add("Se requiere anticoagulaci√≥n transitoria");
    } else if (patologiaFuerza === "CONSIDERAR_ACOD" || patologiaFuerza === "ACODS_PREFERIDOS") {
      notes.push("üîó Anticoagulaci√≥n indefinida: seleccionar el ACOD √≥ptimo seg√∫n comorbilidades y riesgo hemorr√°gico.");
      avoid["No terapia"].add("Se recomienda anticoagulaci√≥n indefinida");
    }

    if(special.dysphagia){
      avoid.Dabigatr√°n.add("Disfagia/SNG (no abrir c√°psula)");
      prefer.Apixab√°n.add("Compatible triturado/SNG");
      prefer.Rivaroxab√°n.add("Compatible triturado/SNG (‚â•15 mg con comida)");
      prefer.VKA.add("Se puede triturar y administrar por SNG");
      notes.push("Disfagia/SNG: evitar dabigatr√°n; considerar apixab√°n, rivaroxab√°n o AVK.");
    }
    if(isFinite(crcl)){
      if(crcl<15){
        prefer.VKA.add("ERC terminal (ClCr <15 ml/min)");
        avoid.Dabigatr√°n.add("ERC terminal");
        avoid.Rivaroxab√°n.add("ERC terminal");
        avoid.Edoxab√°n.add("ERC terminal");
        notes.push("ClCr <15 ml/min: preferir AVK; evitar ACOD.");
      }else if(crcl>=15&&crcl<30){
        prefer.Apixab√°n.add("ERC 15‚Äì29 (menor excreci√≥n renal)");
        avoid.Dabigatr√°n.add("ERC 15‚Äì29");
        notes.push("ClCr 15‚Äì29 ml/min: preferir apixab√°n; evitar dabigatr√°n; ajustar rivaroxab√°n/edoxab√°n.");
      }
    }
    if(special.giBleed){
      prefer.Apixab√°n.add("Mejor perfil GI");
      avoid.Rivaroxab√°n.add("Mayor sangrado GI");
      avoid.Dabigatr√°n.add("Mayor sangrado GI (150 mg)");
      avoid.Edoxab√°n.add("Mayor sangrado GI");
      notes.push("Antecedente de hemorragia digestiva severa: preferir apixab√°n.");
    }
    if(special.ichRisk){
      prefer.Apixab√°n.add("Menor HIC vs AVK");
      prefer.Edoxab√°n.add("Menor HIC vs AVK");
      avoid.VKA.add("Mayor HIC vs ACOD");
      notes.push("Alto riesgo de HIC: priorizar ACOD (apixab√°n/edoxab√°n).");
    }
    if(special.polypharm){
      prefer.Apixab√°n.add("Menos interacciones globales");
      prefer.Edoxab√°n.add("Menos interacciones globales");
      avoid.VKA.add("M√∫ltiples interacciones");
      notes.push("Polimedicaci√≥n: preferir apixab√°n/edoxab√°n.");
    }
    if(special.cirrhosis){
      prefer.VKA.add("Hepatopat√≠a avanzada");
      avoid.Apixab√°n.add("Evitar Child C");
      avoid.Dabigatr√°n.add("Evitar Child C");
      avoid.Edoxab√°n.add("Evitar Child C");
      avoid.Rivaroxab√°n.add("Evitar Child C");
      notes.push("Hepatopat√≠a avanzada (Child C): preferir AVK; evitar ACOD.");
    }
    const over120=isFinite(weightKg)&&weightKg>120;
    if(special.obesity||over120){
      prefer.VKA.add("Obesidad m√≥rbida/Peso >120 kg");
      avoid.Dabigatr√°n.add("Evidencia limitada en obesidad extrema");
      avoid.Edoxab√°n.add("Evidencia limitada en obesidad extrema");
      notes.push("Obesidad m√≥rbida: preferir AVK; si ACOD, mejor apixab√°n/rivaroxab√°n.");
    }
    if(special.oncoGI){
      prefer.VKA.add("Alternativa en tumor GI/GU activo");
      avoid.Rivaroxab√°n.add("Mayor riesgo GI");
      avoid.Dabigatr√°n.add("Mayor riesgo GI");
      avoid.Edoxab√°n.add("Mayor riesgo GI");
      prefer.Apixab√°n.add("Perfil favorable en GI");
      notes.push("Neoplasia GI/GU activa: preferible apixab√°n o AVK.");
    }
    if(age>=80){
      prefer.Apixab√°n.add("Mejor balance en ancianos");
      avoid.Dabigatr√°n.add("Evitar 150 mg en ancianos fr√°giles");
      notes.push("Anciano fr√°gil: apixab√°n suele ser la opci√≥n m√°s segura.");
    }
    if(special.poorINR){
      avoid.VKA.add("Dif√≠cil monitorizaci√≥n de INR");
      ["Apixab√°n","Rivaroxab√°n","Edoxab√°n","Dabigatr√°n"].forEach(a=>prefer[a].add("No precisa control INR"));
      notes.push("Si no se puede monitorizar INR, preferir ACOD.");
    }
    if(special.qd){
      prefer.Rivaroxab√°n.add("Posolog√≠a una vez al d√≠a");
      prefer.Edoxab√°n.add("Posolog√≠a una vez al d√≠a");
      notes.push("Preferencia por dosis √∫nica diaria: rivaroxab√°n o edoxab√°n.");
    }
  }

  return {prefer,avoid,notes};
}

/* Posolog√≠a sugerida */
function doseSuggestions(ctx,avoid){
  const {age,crcl,hasbled,weightKg,scr_mgdl,special}=ctx;
  const out=[]; const isAvoided=name=> (avoid?.[name]&&avoid[name].size>0);

  if(!isAvoided("Apixab√°n")){
    const apxCrit=((age>=80)?1:0)+((isFinite(weightKg)&&weightKg<=60)?1:0)+((isFinite(scr_mgdl)&&scr_mgdl>=1.5)?1:0);
    const apxReduce=(apxCrit>=2)||(isFinite(crcl)&&crcl>=15&&crcl<30);
    out.push({
      name:"Apixab√°n",
      dose:apxReduce?"2,5 mg cada 12 h":"5 mg cada 12 h",
      highlight:apxReduce,
      why:apxReduce?
        "‚â•2 criterios (edad ‚â•80, peso ‚â§60 kg, SCr ‚â•1,5 mg/dL) o ClCr 15‚Äì29 ml/min":
        "Sin criterios de reducci√≥n"
    });
  }
  if(!isAvoided("Rivaroxab√°n")){
    const rivaReduce=(isFinite(crcl)&&crcl>=15&&crcl<50);
    out.push({
      name:"Rivaroxab√°n",
      dose:rivaReduce?"15 mg cada 24 h":"20 mg cada 24 h",
      highlight:rivaReduce,
      why:rivaReduce?"ClCr 15‚Äì49 ml/min":"ClCr ‚â•50 ml/min"
    });
  }
  if(!isAvoided("Edoxab√°n")){
    const edoReduce=((isFinite(crcl)&&crcl>=15&&crcl<=50)||(isFinite(weightKg)&&weightKg<=60)||special.pgp===true);
    out.push({
      name:"Edoxab√°n",
      dose:edoReduce?"30 mg cada 24 h":"60 mg cada 24 h",
      highlight:edoReduce,
      why:edoReduce?"ClCr 15‚Äì50 ml/min o peso ‚â§60 kg o inhibidor potente P-gp":"Sin criterios de reducci√≥n"
    });
  }
  if(!isAvoided("Dabigatr√°n")){
    const dabAvoid=(isFinite(crcl)&&crcl<30);
    if(!dabAvoid){
      const dabReduce=(age>=80)||
        (age>=75&&age<80&&hasbled>=3)||
        (isFinite(crcl)&&crcl>=30&&crcl<50&&hasbled>=3)||
        special.pgp===true;
      out.push({
        name:"Dabigatr√°n",
        dose:dabReduce?"110 mg cada 12 h":"150 mg cada 12 h",
        highlight:dabReduce,
        why:dabReduce?
          "Edad ‚â•80 a√±os o 75‚Äì80 con HAS-BLED alto, o ClCr 30‚Äì49 con HAS-BLED alto, o inhibidor potente P-gp":
          "Sin criterios de reducci√≥n"
      });
    }
  }
  if(!isAvoided("VKA")){
    out.push({
      name:"AVK",
      dose:"Ajuste a INR entre 2 y 3 (seg√∫n patolog√≠a/posici√≥n valvular)",
      highlight:false,
      why:"Dosis individualizada seg√∫n INR"
    });
  }
  return out;
}

/* Zebra por columnas visibles */
function applyColumnStriping(){
  const rows=document.querySelectorAll('#comparative tbody tr');
  rows.forEach(row=>{
    const tds=Array.from(row.querySelectorAll('td'));
    tds.forEach(td=>td.classList.remove('_zebra'));
    const visible=tds.filter(td=>getComputedStyle(td).display!=='none');
    visible.forEach((td,idx)=>{if(((idx+1)%2)===0)td.classList.add('_zebra');});
  });
}
let _zebraTimer=null;
window.addEventListener('resize',()=>{
  clearTimeout(_zebraTimer);
  _zebraTimer=setTimeout(applyColumnStriping,80);
});

function summarizeForStrategy(name,prefSet,avoidSet){
  const prefs=Array.from(prefSet[name]||[]),avoids=Array.from(avoidSet[name]||[]);
  if(avoids.length>0)return{label:'Evitar',cls:'tagAvoid',tooltip:avoids.join(' ¬∑ ')};
  if(prefs.length>0)return{label:'Preferible',cls:'tagPref',tooltip:prefs.join(' ¬∑ ')};
  return{label:'‚Äî',cls:'tagNeutral',tooltip:'Sin condicionantes espec√≠ficos'};
}

/* Estado para imprimir/copiar */
let __lastReport=null;

/* C√°lculo principal */
function compute(){
  aplicarAutoChecks();
  updateEscalasVisibility();

  const age=clamp(parseFloat(document.getElementById('age').value)||0,18,110);
  const sex=document.getElementById('sex').value;

  const weightRaw=parseFloat(document.getElementById('weight').value);
  const weight=isFinite(weightRaw)?clamp(weightRaw,10,400):NaN;
  const wUnit=document.getElementById('weightUnit').value;

  const scrRaw=parseFloat(document.getElementById('scr').value);
  const scr=isFinite(scrRaw)?clamp(scrRaw,0.1,15):NaN;
  const scrUnit=document.getElementById('scrUnit').value;

  const flags={
    cCongest:document.getElementById('cCongest')?.checked||false,
    cHTN:document.getElementById('cHTN')?.checked||false,
    cAge75:document.getElementById('cAge75')?.checked||false,
    cDiab:document.getElementById('cDiab')?.checked||false,
    cStroke:document.getElementById('cStroke')?.checked||false,
    cVasc:document.getElementById('cVasc')?.checked||false,
    cAge65:document.getElementById('cAge65')?.checked||false,
    cSc:document.getElementById('cSc')?.checked||false,
    hHTN:document.getElementById('hHTN')?.checked||false,
    hRenal:document.getElementById('hRenal')?.checked||false,
    hLiver:document.getElementById('hLiver')?.checked||false,
    hStroke:document.getElementById('hStroke')?.checked||false,
    hBleed:document.getElementById('hBleed')?.checked||false,
    hLabileINR:document.getElementById('hLabileINR')?.checked||false,
    hElder:document.getElementById('hElder')?.checked||false,
    hDrugs:document.getElementById('hDrugs')?.checked||false,
    hAlcohol:document.getElementById('hAlcohol')?.checked||false
  };

  const special={
    dysphagia:document.getElementById('condDysphagia')?.checked||false,
    giBleed:document.getElementById('condGIbleed')?.checked||false,
    ichRisk:document.getElementById('condICHrisk')?.checked||false,
    valvular:document.getElementById('condValvular')?.checked||false,
    oncoGI:document.getElementById('condOncoGI')?.checked||false,
    polypharm:document.getElementById('condPolypharm')?.checked||false,
    cirrhosis:document.getElementById('condCirrhosis')?.checked||false,
    obesity:document.getElementById('condObesity')?.checked||false,
    poorINR:document.getElementById('condPoorINR')?.checked||false,
    qd:document.getElementById('condQD')?.checked||false,
    pgp:document.getElementById('condPgp')?.checked||false
  };

  const female=(sex==='F');
  const vasc=calcVasc(age||0,female,flags);
  const hasbled=calcHASBLED(flags,age||0);

  const strokeBase=getStrokeRiskPct(vasc.vasc);
  const bleedBase=getBleedRiskPct(hasbled);

  const {crcl,scr_mgdl}=calcCrCl(age,sex,isFinite(weight)?weight:NaN,wUnit,scr,scrUnit);
  const weightKg=isFinite(weight)?((wUnit==='lb')?(weight/2.20462):weight):NaN;

const { fuerza, recomendacion } = mostrarRecomendacionPatologia(false);

// =========================
// MOSTRAR/OCULTAR BLOQUE FA SEG√öN SI HAY FA MARCADA
// =========================
const tieneFA = patologiaTieneFASeleccionada();

if (!tieneFA) {
  // Ocultar todo el bloque FA
  document.querySelector(".kpi").style.display = "none";
  document.getElementById("comparative").style.display = "none";
  document.getElementById("doseSection").style.display = "none";

  // Limpiar KPIs
  document.getElementById('scoreVA').textContent = "‚Äì";
  document.getElementById('scoreVASc').textContent = "‚Äì";
  document.getElementById('annualStroke').textContent = "‚Äì";
  document.getElementById('scoreHASBLED').textContent = "‚Äì";
  document.getElementById('annualBleed').textContent = "‚Äì";
  document.getElementById('crcl').textContent = "‚Äì";
  document.getElementById('scrConv').textContent = "‚Äì";

} else {
  // Mostrar bloque FA
  document.querySelector(".kpi").style.display = "grid";
  document.getElementById("comparative").style.display = "table";
  document.getElementById("doseSection").style.display = "";
}


  document.getElementById('scoreVA').textContent=vasc.va;
  document.getElementById('scoreVASc').textContent=vasc.vasc;
  document.getElementById('annualStroke').textContent=fmt(strokeBase,1);
  document.getElementById('scoreHASBLED').textContent=hasbled;
  document.getElementById('annualBleed').textContent=fmt(bleedBase,1);
  document.getElementById('crcl').textContent=isFinite(crcl)?fmt(crcl,0):NDASH;
  document.getElementById('scrConv').textContent=isFinite(scr_mgdl)?fmt(scr_mgdl,2):NDASH;

  const {prefer,avoid,notes}=buildClinicalRules({crcl,age,special,weightKg}, fuerza);

  const TOL_REL=0.03,TOL_ABS=0.005;
  function withinTolerance(score,best,tolRel=TOL_REL,tolAbs=TOL_ABS){
    if(!isFinite(score)||!isFinite(best))return false;
    const relOk=best>0?(best-score)<=best*tolRel:false;
    const absOk=Math.abs(best-score)<=tolAbs;
    return relOk||absOk;
  }

  const tbody=document.querySelector('#comparative tbody');
  tbody.innerHTML='';
  const rows=[];
  let bestScore=-Infinity;

  STRATS.forEach(name=>{
    const rrStroke=RR_Stroke[name], rrBleed_vsVKA=RR_Bleed_vs_VKA[name];
    const riskStroke=strokeBase*rrStroke, rrr=(1-rrStroke)*100, arr=strokeBase-riskStroke;
    const bleedPct=(name==='VKA')?bleedBase:(bleedBase*rrBleed_vsVKA);
    const score=(arr>0&&bleedPct>0)?(arr/bleedPct):-Infinity;
    const adequacy=summarizeForStrategy(name,prefer,avoid);
    const tip=escAttr(decodeEntities(adequacy.tooltip||''));
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><b>${name}</b></td>
      <td class="right">${fmt(riskStroke,1)}</td>
      <td class="right">${fmt(rrr,0)}</td>
      <td class="right col-rra">${fmt(arr,1)}</td>
      <td class="right">${isFinite(arr)&&arr>0?oneIn(arr):NDASH}</td>
      <td class="right">${fmt(bleedPct,1)}</td>
      <td class="right col-rrs">${fmt(rrBleed_vsVKA,2)}</td>
      <td class="right">${isFinite(bleedPct)&&bleedPct>0?oneIn(bleedPct):NDASH}</td>
      <td class="right"><span class="pill ${adequacy.cls}" title="${tip}">${adequacy.label}</span></td>`;
    tbody.appendChild(tr);
    rows.push({tr,score});
    if(score>bestScore)bestScore=score;
  });
  rows.forEach(({tr,score})=>{if(withinTolerance(score,bestScore))tr.classList.add('best');});
  applyColumnStriping();

  const recList=document.getElementById('recList');
// Mostrar coletilla (opcional) en recomendaciones globales
if (recomendacion) {
  const li = document.createElement("li");
  li.innerHTML = `<i>${recomendacion}</i>`;
  recList.appendChild(li);
}
  const doseSection=document.getElementById('doseSection');
  recList.innerHTML='';
  let preferredGlobal=[], avoidedGlobal=[], dosesForReport=[];

  const isAnticoagulationRequired =
    fuerza !== "NO_ANTICOAGULAR" &&
    fuerza !== "ANTIAGREGACION_PREFERIDA" &&
    fuerza !== "INSUFICIENTE";

  if(!isAnticoagulationRequired && fuerza !== "INSUFICIENTE"){ 
    const li=document.createElement('li');
    li.innerHTML='<span style="color:#b71c1c;font-weight:800;">NO se recomienda tratamiento anticoagulante. Manejo habitual: antiagregaci√≥n (AAS) o vigilancia.</span>';
    recList.appendChild(li);
    doseSection.style.display='none';
  }else{
    notes.forEach(t=>{
      const li=document.createElement('li');
      li.textContent=decodeEntities(t);
      recList.appendChild(li);
    });

    ["VKA","Apixab√°n","Dabigatr√°n","Edoxab√°n","Rivaroxab√°n"].forEach(n=>{
      if((avoid[n]||new Set()).size>0)avoidedGlobal.push(n);
      else if((prefer[n]||new Set()).size>0)preferredGlobal.push(n);
    });

    if(fuerza === "VKA_OBLIGATORIO") {
      preferredGlobal = ["VKA"];
      avoidedGlobal = ["Apixab√°n", "Dabigatr√°n", "Edoxab√°n", "Rivaroxab√°n", "No terapia"];
    }

    const preferredACODs = preferredGlobal.filter(n => n !== "VKA");
    const isVKAOnlyForComorbidity =
      preferredGlobal.includes("VKA") &&
      preferredACODs.length > 0 &&
      fuerza !== "VKA_OBLIGATORIO";

    if(isVKAOnlyForComorbidity) {
      notes.push(`‚ö†Ô∏è Nota: el AVK aparece como ‚Äúpreferible‚Äù por comorbilidad (p. ej. obesidad m√≥rbida o hepatopat√≠a), pero en FA no valvular los ACOD (${preferredACODs.join(', ')}) siguen siendo primera elecci√≥n; debe ponderarse beneficio y riesgo en cada caso.`);
      preferredGlobal = preferredACODs;
    } else if (preferredACODs.length > 0 && fuerza !== "VKA_OBLIGATORIO") {
      notes.push(`‚≠ê Primera elecci√≥n: ${preferredACODs.join(', ')} por mejor balance eficacia/seguridad en este contexto.`);
    }

    if(preferredGlobal.length){
      const li=document.createElement('li');
      li.innerHTML="<b>Estrategias preferibles (seg√∫n comorbilidades):</b> "+preferredGlobal.join(", ");
      recList.appendChild(li);
    }
    if(avoidedGlobal.length){
      const li=document.createElement('li');
      li.innerHTML="<b>Estrategias a evitar:</b> "+avoidedGlobal.join(", ");
      recList.appendChild(li);
    }

    doseSection.style.display='';
    const doseList=document.getElementById('doseList');
    doseList.innerHTML='';
    dosesForReport=doseSuggestions({age,crcl,hasbled,weightKg,scr_mgdl,special},avoid);
    if(dosesForReport.length===0){
      const li=document.createElement('li');
      li.innerHTML='<span class="muted">No se muestran posolog√≠as porque todas las opciones disponibles est√°n marcadas como ¬´Evitar¬ª.</span>';
      doseList.appendChild(li);
    }else{
      dosesForReport.forEach(d=>{
        const li=document.createElement('li');
        const tag=d.highlight?`<span class="pill" style="background:#fff4ce;border:1px solid #ffe08a;color:#7a4e00;">Dosis reducida</span>`:'';
        li.innerHTML=`<b>${d.name}:</b> ${d.dose} ${tag} <span class="muted">‚Äî ${d.why}</span>`;
        doseList.appendChild(li);
      });
    }
  }

  __lastReport={
    ts:new Date().toISOString(),
    inputs:{age,sex,weight:isFinite(weight)?weight:null,weightUnit:wUnit,scr:isFinite(scr)?scr:null,scrUnit,weightKg:isFinite(weightKg)?weightKg:null},
    renal:{crcl:isFinite(crcl)?+crcl.toFixed(0):null,scr_mgdl:isFinite(scr_mgdl)?+scr_mgdl.toFixed(2):null},
    scores:{va:vasc.va,vasc:vasc.vasc,hasbled},
    risks:{strokeBase:+strokeBase,bleedBase:+bleedBase},
    noOAC:!isAnticoagulationRequired,
    preferredGlobal, avoidedGlobal,
    notes:[...notes],
    doses:dosesForReport
  };
  document.getElementById('btnPrint').disabled=false;
  document.getElementById('btnCopy').disabled=false;
}

/* Informe imprimible */
function printReport(){
  if(!__lastReport){
    showToast('Primero calcule los resultados para generar el informe.','warn');
    return;
  }
  const r=__lastReport;
  const fmtOrDash=v=> (v===null||v===undefined||!isFinite(v))?NDASH:v;
  const sexTxt = r.inputs.sex==='M'?'Var√≥n':(r.inputs.sex==='F'?'Mujer':NDASH);
  const fecha = (new Date(r.ts)).toLocaleString('es-ES');
  const patologiaRecHtml = document.getElementById('patologia-rec-final').innerHTML;

  const dosesHTML = (r.noOAC||!r.doses||r.doses.length===0) ? ''
    : ('<h3>Posolog√≠a sugerida</h3><ul>' + r.doses.map(d=>`<li><b>${d.name}:</b> ${d.dose}${d.highlight?' <span style="background:#fff4ce;border:1px solid #ffe08a;border-radius:999px;padding:2px 8px;font-weight:700">Dosis reducida</span>':''} ‚Äî <span style="color:#666">${d.why}</span></li>`).join('') + '</ul>');

  const recHTML = r.noOAC
    ? '<p style="color:#b71c1c;font-weight:800">NO SE RECOMIENDA TRATAMIENTO ANTICOAGULANTE. Recomendaci√≥n: antiagregaci√≥n (AAS) o vigilancia.</p>'
    : `
      ${r.notes.length?('<h3>Recomendaciones espec√≠ficas</h3><ul>'+r.notes.map(n=>`<li>${decodeEntities(n)}</li>`).join('')+'</ul>'):''}
      ${r.preferredGlobal.length?('<p><b>Estrategias preferibles:</b> '+r.preferredGlobal.join(', ')+'</p>'):''}
      ${r.avoidedGlobal.length?('<p><b>Estrategias a evitar:</b> '+r.avoidedGlobal.join(', ')+'</p>'):''}
    `;

  const html = `
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Informe ‚Äî Otras cardiopat√≠as embol√≠genas</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:24px;color:#111}
  h1{font-size:1.2rem;margin:0 0 6px}
  h2{font-size:1.05rem;margin:18px 0 6px}
  h3{font-size:1rem;margin:14px 0 4px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .card{padding:12px 14px;border:1px solid #e3eef9;border-radius:10px;background:#f8fbff;margin-top:8px}
  .muted{color:#666}
  table{border-collapse:collapse}
  td{padding:3px 8px}
  .chip{display:inline-block;background:#eef6ff;border:1px solid #cfe3f6;border-radius:999px;padding:2px 8px;font-weight:700}
  .foot{margin-top:18px;color:#666;font-size:.9rem}
  @media print {.no-print{display:none}}
</style>
</head>
<body>
  <h1>Informe ‚Äî Calculadora de tratamiento antitromb√≥tico en cardiopat√≠as embol√≠genas</h1>
  <div class="muted">Generado: ${fecha}</div>

  <div class="card">
    <h2>Conclusi√≥n por patolog√≠a principal</h2>
    ${patologiaRecHtml}
  </div>

  <div class="card">
    <h2>Datos y puntuaciones</h2>
    <div class="row">
      <div>
        <table>
          <tr><td><b>Edad</b></td><td>${fmtOrDash(r.inputs.age)} a√±os</td></tr>
          <tr><td><b>Sexo</b></td><td>${sexTxt}</td></tr>
          <tr><td><b>Peso</b></td><td>${r.inputs.weight!==null? r.inputs.weight+' '+r.inputs.weightUnit : NDASH}</td></tr>
          <tr><td><b>SCr</b></td><td>${r.inputs.scr!==null? r.inputs.scr+' '+r.inputs.scrUnit : NDASH}</td></tr>
          <tr><td><b>SCr (mg/dL)</b></td><td>${fmtOrDash(r.renal.scr_mgdl)}</td></tr>
          <tr><td><b>ClCr</b></td><td>${fmtOrDash(r.renal.crcl)} ml/min</td></tr>
        </table>
      </div>
      <div>
        <table>
          <tr><td><b>CHA<sub>2</sub>DS<sub>2</sub>-VA</b></td><td class="chip">${r.scores.va}</td></tr>
          <tr><td><b>CHA<sub>2</sub>DS<sub>2</sub>-VASc</b></td><td class="chip">${r.scores.vasc}</td></tr>
          <tr><td><b>HAS-BLED</b></td><td class="chip">${r.scores.hasbled}</td></tr>
          <tr><td><b>Riesgo ictus sin tto (FA)</b></td><td>${r.risks.strokeBase} %/a√±o</td></tr>
          <tr><td><b>Riesgo sangrado base</b></td><td>${r.risks.bleedBase} %/a√±o</td></tr>
        </table>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Recomendaci√≥n individualizada</h2>
    ${recHTML}
    ${dosesHTML}
    <p class="foot">Documento generado autom√°ticamente con la herramienta Ictus GPS. Debe interpretarse siempre en el contexto cl√≠nico del paciente y conforme a las gu√≠as y protocolos locales.</p>
  </div>

  <button class="no-print" onclick="window.print()">Imprimir</button>
  <script>window.addEventListener('load',()=>{setTimeout(()=>{window.print();},150);});<\/script>
</body>
</html>`;
  const w = window.open('', '_blank');
  if(!w){
    showToast('El navegador ha bloqueado la ventana de impresi√≥n. Permita ventanas emergentes para esta p√°gina.','warn');
    return;
  }
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/* Informe en texto plano */
function buildPlainReport(r){
  const clean = (s)=> String(s)
    .replace(/[‚Ä¢]/g,'*')
    .replace(/[‚Äî‚Äì]/g,'-')
    .replace(/‚â•/g,'>=').replace(/‚â§/g,'<=');
  const sexTxt = r.inputs.sex==='M'?'Var√≥n':(r.inputs.sex==='F'?'Mujer':'-');
  const fecha = (new Date(r.ts)).toLocaleString('es-ES');
  const patologiaRecFinal = document.getElementById('patologia-rec-final').textContent;
  const bullets = [];
  bullets.push('Otras cardiopat√≠as embol√≠genas ‚Äì Recomendaci√≥n (Ictus GPS)');
  bullets.push('=========================================================');
  bullets.push('Generado: ' + fecha);
  bullets.push('');
  bullets.push('CONCLUSI√ìN POR PATOLOG√çA PRINCIPAL');
  bullets.push(patologiaRecFinal);
  bullets.push('');
  bullets.push('DATOS Y PUNTUACIONES');
  bullets.push('* Edad: ' + (r.inputs.age ?? '-') + ' a√±os');
  bullets.push('* Sexo: ' + sexTxt);
  bullets.push('* Peso: ' + (r.inputs.weight!=null ? (r.inputs.weight+' '+r.inputs.weightUnit) : '-'));
  bullets.push('* SCr: ' + (r.inputs.scr!=null ? (r.inputs.scr+' '+r.inputs.scrUnit) : '-') +
              ' | SCr (mg/dL): ' + (r.renal.scr_mgdl ?? '-') +
              ' | ClCr: ' + (r.renal.crcl ?? '-') + ' ml/min');
  bullets.push('* CHA2DS2-VASc: ' + r.scores.vasc + ' | HAS-BLED: ' + r.scores.hasbled);
  bullets.push('* Riesgo ictus sin tto (FA): ' + r.risks.strokeBase + '%/a√±o | Riesgo sangrado base: ' + r.risks.bleedBase + '%/a√±o');
  bullets.push('');
  bullets.push('RECOMENDACI√ìN INDIVIDUALIZADA');
  if(r.noOAC){
    bullets.push('No se recomienda tratamiento anticoagulante. Recomendaci√≥n: antiagregaci√≥n (AAS) o vigilancia.');
  }else{
    if(r.notes.length){
      bullets.push('Recomendaciones espec√≠ficas:');
      r.notes.forEach(n=>bullets.push('* ' + clean(decodeEntities(n))));
    }
    if(r.preferredGlobal.length) bullets.push('Estrategias preferibles: ' + r.preferredGlobal.join(', '));
    if(r.avoidedGlobal.length) bullets.push('Estrategias a evitar: ' + r.avoidedGlobal.join(', '));
    if(r.doses && r.doses.length){
      bullets.push('');
      bullets.push('Posolog√≠a sugerida:');
      r.doses.forEach(d=>{
        bullets.push('* ' + d.name + ': ' + d.dose + (d.highlight?' [Dosis reducida]':'') + ' - ' + clean(d.why));
      });
    }
  }
  bullets.push('');
  bullets.push('Aviso: herramienta orientativa; no sustituye el juicio cl√≠nico ni las gu√≠as oficiales.');
  return bullets.join('\n');
}

async function copyReport(){
  if(!__lastReport){
    showToast('Primero calcule los resultados para generar el informe.','warn');
    return;
  }
  const text = buildPlainReport(__lastReport);
  try{
    await navigator.clipboard.writeText(text);
  }catch(e){
    const ta=document.createElement('textarea');
    ta.value=text; ta.style.position='fixed'; ta.style.left='-1000px';
    document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); } finally{ document.body.removeChild(ta); }
  }
  const btn=document.getElementById('btnCopy');
  const old=btn.textContent;
  btn.textContent='Copiado [OK]';
  btn.classList.add('copiado');
  setTimeout(()=>{
    btn.textContent=old;
    btn.classList.remove('copiado');
  },1600);
}

/* Inicializaci√≥n */
window.addEventListener('DOMContentLoaded', () => {
  ['age','sex','weight','weightUnit','scr','scrUnit'].forEach(id=>{
    const el=document.getElementById(id);
    if (el) {
      el.addEventListener('input',autoCheckByInputs);
      el.addEventListener('change',autoCheckByInputs);
    }
  });

  ['condObesity','cAge65','cAge75','hElder','hRenal','cSc'].forEach(id=>{
    const el=document.getElementById(id);
    if (el) el.addEventListener('change',()=>checkAndFixContradictions(id));
  });

  document.getElementById('patologia').addEventListener('change', mostrarFactoresPatologia);

  document.getElementById('btnCalc').addEventListener('click',e=>{
    e.preventDefault();
    compute();
    document.getElementById('calcMsg').textContent='Listo.';
    scrollToResult();
  });

  document.getElementById('btnPrint').addEventListener('click', (e)=>{
    e.preventDefault();
    printReport();
  });
  document.getElementById('btnCopy').addEventListener('click', (e)=>{
    e.preventDefault();
    copyReport();
  });

  document.getElementById('btnReset').addEventListener('click',e=>{
    e.preventDefault();
    ['age','sex','weight','weightUnit','scr','scrUnit'].forEach(id=>{
      const el=document.getElementById(id);
      if(el && el.tagName==='SELECT'){el.selectedIndex=0;}
      else if (el) el.value='';
    });
    document.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false);
    ['scoreVA','scoreVASc','annualStroke','scoreHASBLED','annualBleed','crcl','scrConv']
      .forEach(id=>{document.getElementById(id).textContent=NDASH;});
    document.querySelector('#comparative tbody').innerHTML='';
    document.getElementById('recList').innerHTML='';
    document.getElementById('doseList').innerHTML='';
    document.getElementById('doseSection').style.display='';
    document.getElementById('calcMsg').textContent='Borrado.';
    document.getElementById('btnPrint').disabled=true;
    document.getElementById('btnCopy').disabled=true;
    document.getElementById('patologia').selectedIndex=0;
    document.getElementById('patologia-factores').innerHTML='';
    document.getElementById('patologia-resultado').innerHTML='';
    document.getElementById('patologia-rec-final').innerHTML='';
    __lastReport=null;
    updateEscalasVisibility();
    window.scrollTo({top:0,behavior:'smooth'});
    applyColumnStriping();
    autoCheckByInputs();
  });

  autoCheckByInputs();
  updateEscalasVisibility();
});
</script>

<script src="../js/index.js"></script>

</body>
</html>
